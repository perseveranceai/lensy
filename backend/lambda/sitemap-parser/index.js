"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const xml2js_1 = require("xml2js");
const progress_publisher_1 = require("./progress-publisher");
const handler = async (event) => {
    const startTime = Date.now();
    console.log('Parsing sitemap for URL:', event.url);
    // Initialize progress publisher and S3 client
    const progress = new progress_publisher_1.ProgressPublisher(event.sessionId);
    const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
    try {
        // Send initial progress
        await progress.progress('Starting sitemap parsing...', 'sitemap-parsing');
        // Fetch and parse the sitemap
        const result = await parseSitemapRecursively(event.url, progress, 0);
        // Store results in S3
        const s3Key = `sessions/${event.sessionId}/sitemap-results.json`;
        const s3Location = `s3://${process.env.ANALYSIS_BUCKET}/${s3Key}`;
        const sitemapResults = {
            originalUrl: event.url,
            totalUrls: result.urls.length,
            urls: result.urls,
            nestedSitemaps: result.nestedSitemaps,
            processingTime: Date.now() - startTime,
            timestamp: new Date().toISOString()
        };
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: process.env.ANALYSIS_BUCKET,
            Key: s3Key,
            Body: JSON.stringify(sitemapResults, null, 2),
            ContentType: 'application/json'
        }));
        // Send completion message
        await progress.success(`Sitemap parsing complete: Found ${result.urls.length} URLs${result.nestedSitemaps > 0 ? ` (${result.nestedSitemaps} nested sitemaps)` : ''}`, {
            totalUrls: result.urls.length,
            nestedSitemaps: result.nestedSitemaps,
            processingTime: Date.now() - startTime
        });
        console.log(`Sitemap parsing completed: ${result.urls.length} URLs found`);
        return {
            success: true,
            sessionId: event.sessionId,
            totalUrls: result.urls.length,
            sitemapUrls: result.urls,
            nestedSitemaps: result.nestedSitemaps,
            s3Location,
            message: `Successfully parsed sitemap with ${result.urls.length} URLs`,
            processingTime: Date.now() - startTime
        };
    }
    catch (error) {
        console.error('Sitemap parsing failed:', error);
        await progress.error(`Sitemap parsing failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
        return {
            success: false,
            sessionId: event.sessionId,
            totalUrls: 0,
            sitemapUrls: [],
            nestedSitemaps: 0,
            s3Location: '',
            message: `Sitemap parsing failed: ${error instanceof Error ? error.message : 'Unknown error'}`,
            processingTime: Date.now() - startTime
        };
    }
};
exports.handler = handler;
/**
 * Recursively parse sitemap with nested sitemap support
 * Requirements: 29.1, 29.2, 29.3, 29.7, 29.8, 29.9, 29.10
 */
async function parseSitemapRecursively(sitemapUrl, progress, depth = 0, maxDepth = 3, processedUrls = new Set()) {
    // Prevent infinite recursion and duplicate processing
    if (depth > maxDepth) {
        console.log(`Max depth ${maxDepth} reached, skipping: ${sitemapUrl}`);
        return { urls: [], nestedSitemaps: 0 };
    }
    if (processedUrls.has(sitemapUrl)) {
        console.log(`Already processed: ${sitemapUrl}`);
        return { urls: [], nestedSitemaps: 0 };
    }
    processedUrls.add(sitemapUrl);
    try {
        await progress.progress(`Fetching sitemap: ${sitemapUrl}`, 'sitemap-parsing');
        // Fetch sitemap content with timeout handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        const response = await fetch(sitemapUrl, {
            headers: {
                'User-Agent': 'Lensy Documentation Quality Auditor/1.0'
            },
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const contentType = response.headers.get('content-type') || '';
        let xmlContent;
        // Handle compressed sitemaps
        if (contentType.includes('gzip') || sitemapUrl.endsWith('.gz')) {
            await progress.progress('Decompressing gzipped sitemap...', 'sitemap-parsing');
            // For now, assume uncompressed. In production, would use zlib
            xmlContent = await response.text();
        }
        else {
            xmlContent = await response.text();
        }
        // Parse XML
        const parsedXml = await new Promise((resolve, reject) => {
            (0, xml2js_1.parseString)(xmlContent, {
                explicitArray: true,
                ignoreAttrs: false,
                trim: true
            }, (err, result) => {
                if (err)
                    reject(err);
                else
                    resolve(result);
            });
        });
        let allUrls = [];
        let nestedSitemapCount = 0;
        // Handle sitemap index (contains references to other sitemaps)
        if (parsedXml.sitemapindex?.sitemap) {
            await progress.progress(`Found sitemap index with ${parsedXml.sitemapindex.sitemap.length} nested sitemaps`, 'sitemap-parsing');
            for (const nestedSitemap of parsedXml.sitemapindex.sitemap) {
                if (nestedSitemap.loc && nestedSitemap.loc[0]) {
                    const nestedUrl = nestedSitemap.loc[0].trim();
                    console.log(`Processing nested sitemap: ${nestedUrl}`);
                    const nestedResult = await parseSitemapRecursively(nestedUrl, progress, depth + 1, maxDepth, processedUrls);
                    allUrls.push(...nestedResult.urls);
                    nestedSitemapCount += 1 + nestedResult.nestedSitemaps;
                }
            }
        }
        // Handle regular sitemap (contains actual URLs)
        if (parsedXml.urlset?.url) {
            await progress.progress(`Extracting ${parsedXml.urlset.url.length} URLs from sitemap`, 'sitemap-parsing');
            for (const urlEntry of parsedXml.urlset.url) {
                if (urlEntry.loc && urlEntry.loc[0]) {
                    const url = urlEntry.loc[0].trim();
                    if (url && isValidUrl(url)) {
                        allUrls.push(url);
                    }
                }
            }
        }
        // Remove duplicates
        const uniqueUrls = [...new Set(allUrls)];
        if (depth === 0) {
            await progress.progress(`Sitemap parsing complete: ${uniqueUrls.length} unique URLs found`, 'sitemap-parsing');
        }
        return {
            urls: uniqueUrls,
            nestedSitemaps: nestedSitemapCount
        };
    }
    catch (error) {
        console.error(`Error parsing sitemap ${sitemapUrl}:`, error);
        await progress.error(`Failed to parse sitemap: ${sitemapUrl} - ${error instanceof Error ? error.message : 'Unknown error'}`);
        // Return empty result but don't fail the entire process
        return { urls: [], nestedSitemaps: 0 };
    }
}
/**
 * Validate URL format
 */
function isValidUrl(urlString) {
    try {
        const url = new URL(urlString);
        return url.protocol === 'http:' || url.protocol === 'https:';
    }
    catch {
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBZ0U7QUFDaEUsbUNBQXFDO0FBQ3JDLDZEQUF5RDtBQXNDbEQsTUFBTSxPQUFPLEdBQXVELEtBQUssRUFBRSxLQUFLLEVBQUUsRUFBRTtJQUN2RixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDN0IsT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBMEIsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFbkQsOENBQThDO0lBQzlDLE1BQU0sUUFBUSxHQUFHLElBQUksc0NBQWlCLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3hELE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7SUFFbEUsSUFBSSxDQUFDO1FBQ0Qsd0JBQXdCO1FBQ3hCLE1BQU0sUUFBUSxDQUFDLFFBQVEsQ0FBQyw2QkFBNkIsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO1FBRTFFLDhCQUE4QjtRQUM5QixNQUFNLE1BQU0sR0FBRyxNQUFNLHVCQUF1QixDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRXJFLHNCQUFzQjtRQUN0QixNQUFNLEtBQUssR0FBRyxZQUFZLEtBQUssQ0FBQyxTQUFTLHVCQUF1QixDQUFDO1FBQ2pFLE1BQU0sVUFBVSxHQUFHLFFBQVEsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksS0FBSyxFQUFFLENBQUM7UUFFbEUsTUFBTSxjQUFjLEdBQUc7WUFDbkIsV0FBVyxFQUFFLEtBQUssQ0FBQyxHQUFHO1lBQ3RCLFNBQVMsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU07WUFDN0IsSUFBSSxFQUFFLE1BQU0sQ0FBQyxJ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QUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFMzQ2xpZW50LCBQdXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IHBhcnNlU3RyaW5nIH0gZnJvbSAneG1sMmpzJztcbmltcG9ydCB7IFByb2dyZXNzUHVibGlzaGVyIH0gZnJvbSAnLi9wcm9ncmVzcy1wdWJsaXNoZXInO1xuXG5pbnRlcmZhY2UgU2l0ZW1hcFBhcnNlckV2ZW50IHtcbiAgICB1cmw6IHN0cmluZztcbiAgICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgICBpbnB1dFR5cGU6ICdzaXRlbWFwJztcbn1cblxuaW50ZXJmYWNlIFNpdGVtYXBQYXJzZXJSZXNwb25zZSB7XG4gICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgICB0b3RhbFVybHM6IG51bWJlcjtcbiAgICBzaXRlbWFwVXJsczogc3RyaW5nW107XG4gICAgbmVzdGVkU2l0ZW1hcHM6IG51bWJlcjtcbiAgICBzM0xvY2F0aW9uOiBzdHJpbmc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIHByb2Nlc3NpbmdUaW1lOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBTaXRlbWFwRW50cnkge1xuICAgIGxvYzogc3RyaW5nW107XG4gICAgbGFzdG1vZD86IHN0cmluZ1tdO1xuICAgIHByaW9yaXR5Pzogc3RyaW5nW107XG4gICAgY2hhbmdlZnJlcT86IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgUGFyc2VkU2l0ZW1hcCB7XG4gICAgdXJsc2V0Pzoge1xuICAgICAgICB1cmw6IFNpdGVtYXBFbnRyeVtdO1xuICAgIH07XG4gICAgc2l0ZW1hcGluZGV4Pzoge1xuICAgICAgICBzaXRlbWFwOiBBcnJheTx7XG4gICAgICAgICAgICBsb2M6IHN0cmluZ1tdO1xuICAgICAgICAgICAgbGFzdG1vZD86IHN0cmluZ1tdO1xuICAgICAgICB9PjtcbiAgICB9O1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlcjogSGFuZGxlcjxTaXRlbWFwUGFyc2VyRXZlbnQsIFNpdGVtYXBQYXJzZXJSZXNwb25zZT4gPSBhc3luYyAoZXZlbnQpID0+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnNvbGUubG9nKCdQYXJzaW5nIHNpdGVtYXAgZm9yIFVSTDonLCBldmVudC51cmwpO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBwcm9ncmVzcyBwdWJsaXNoZXIgYW5kIFMzIGNsaWVudFxuICAgIGNvbnN0IHByb2dyZXNzID0gbmV3IFByb2dyZXNzUHVibGlzaGVyKGV2ZW50LnNlc3Npb25JZCk7XG4gICAgY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5cbiAgICB0cnkge1xuICAgICAgICAvLyBTZW5kIGluaXRpYWwgcHJvZ3Jlc3NcbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoJ1N0YXJ0aW5nIHNpdGVtYXAgcGFyc2luZy4uLicsICdzaXRlbWFwLXBhcnNpbmcnKTtcblxuICAgICAgICAvLyBGZXRjaCBhbmQgcGFyc2UgdGhlIHNpdGVtYXBcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGFyc2VTaXRlbWFwUmVjdXJzaXZlbHkoZXZlbnQudXJsLCBwcm9ncmVzcywgMCk7XG5cbiAgICAgICAgLy8gU3RvcmUgcmVzdWx0cyBpbiBTM1xuICAgICAgICBjb25zdCBzM0tleSA9IGBzZXNzaW9ucy8ke2V2ZW50LnNlc3Npb25JZH0vc2l0ZW1hcC1yZXN1bHRzLmpzb25gO1xuICAgICAgICBjb25zdCBzM0xvY2F0aW9uID0gYHMzOi8vJHtwcm9jZXNzLmVudi5BTkFMWVNJU19CVUNLRVR9LyR7czNLZXl9YDtcblxuICAgICAgICBjb25zdCBzaXRlbWFwUmVzdWx0cyA9IHtcbiAgICAgICAgICAgIG9yaWdpbmFsVXJsOiBldmVudC51cmwsXG4gICAgICAgICAgICB0b3RhbFVybHM6IHJlc3VsdC51cmxzLmxlbmd0aCxcbiAgICAgICAgICAgIHVybHM6IHJlc3VsdC51cmxzLFxuICAgICAgICAgICAgbmVzdGVkU2l0ZW1hcHM6IHJlc3VsdC5uZXN0ZWRTaXRlbWFwcyxcbiAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgfTtcblxuICAgICAgICBhd2FpdCBzM0NsaWVudC5zZW5kKG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuQU5BTFlTSVNfQlVDS0VULFxuICAgICAgICAgICAgS2V5OiBzM0tleSxcbiAgICAgICAgICAgIEJvZHk6IEpTT04uc3RyaW5naWZ5KHNpdGVtYXBSZXN1bHRzLCBudWxsLCAyKSxcbiAgICAgICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIC8vIFNlbmQgY29tcGxldGlvbiBtZXNzYWdlXG4gICAgICAgIGF3YWl0IHByb2dyZXNzLnN1Y2Nlc3MoXG4gICAgICAgICAgICBgU2l0ZW1hcCBwYXJzaW5nIGNvbXBsZXRlOiBGb3VuZCAke3Jlc3VsdC51cmxzLmxlbmd0aH0gVVJMcyR7cmVzdWx0Lm5lc3RlZFNpdGVtYXBzID4gMCA/IGAgKCR7cmVzdWx0Lm5lc3RlZFNpdGVtYXBzfSBuZXN0ZWQgc2l0ZW1hcHMpYCA6ICcnfWAsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdG90YWxVcmxzOiByZXN1bHQudXJscy5sZW5ndGgsXG4gICAgICAgICAgICAgICAgbmVzdGVkU2l0ZW1hcHM6IHJlc3VsdC5uZXN0ZWRTaXRlbWFwcyxcbiAgICAgICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGBTaXRlbWFwIHBhcnNpbmcgY29tcGxldGVkOiAke3Jlc3VsdC51cmxzLmxlbmd0aH0gVVJMcyBmb3VuZGApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgc2Vzc2lvbklkOiBldmVudC5zZXNzaW9uSWQsXG4gICAgICAgICAgICB0b3RhbFVybHM6IHJlc3VsdC51cmxzLmxlbmd0aCxcbiAgICAgICAgICAgIHNpdGVtYXBVcmxzOiByZXN1bHQudXJscyxcbiAgICAgICAgICAgIG5lc3RlZFNpdGVtYXBzOiByZXN1bHQubmVzdGVkU2l0ZW1hcHMsXG4gICAgICAgICAgICBzM0xvY2F0aW9uLFxuICAgICAgICAgICAgbWVzc2FnZTogYFN1Y2Nlc3NmdWxseSBwYXJzZWQgc2l0ZW1hcCB3aXRoICR7cmVzdWx0LnVybHMubGVuZ3RofSBVUkxzYCxcbiAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgICAgIH07XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdTaXRlbWFwIHBhcnNpbmcgZmFpbGVkOicsIGVycm9yKTtcblxuICAgICAgICBhd2FpdCBwcm9ncmVzcy5lcnJvcihgU2l0ZW1hcCBwYXJzaW5nIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBzZXNzaW9uSWQ6IGV2ZW50LnNlc3Npb25JZCxcbiAgICAgICAgICAgIHRvdGFsVXJsczogMCxcbiAgICAgICAgICAgIHNpdGVtYXBVcmxzOiBbXSxcbiAgICAgICAgICAgIG5lc3RlZFNpdGVtYXBzOiAwLFxuICAgICAgICAgICAgczNMb2NhdGlvbjogJycsXG4gICAgICAgICAgICBtZXNzYWdlOiBgU2l0ZW1hcCBwYXJzaW5nIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgICAgfTtcbiAgICB9XG59O1xuXG5pbnRlcmZhY2UgUGFyc2VSZXN1bHQge1xuICAgIHVybHM6IHN0cmluZ1tdO1xuICAgIG5lc3RlZFNpdGVtYXBzOiBudW1iZXI7XG59XG5cbi8qKlxuICogUmVjdXJzaXZlbHkgcGFyc2Ugc2l0ZW1hcCB3aXRoIG5lc3RlZCBzaXRlbWFwIHN1cHBvcnRcbiAqIFJlcXVpcmVtZW50czogMjkuMSwgMjkuMiwgMjkuMywgMjkuNywgMjkuOCwgMjkuOSwgMjkuMTBcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcGFyc2VTaXRlbWFwUmVjdXJzaXZlbHkoXG4gICAgc2l0ZW1hcFVybDogc3RyaW5nLFxuICAgIHByb2dyZXNzOiBQcm9ncmVzc1B1Ymxpc2hlcixcbiAgICBkZXB0aDogbnVtYmVyID0gMCxcbiAgICBtYXhEZXB0aDogbnVtYmVyID0gMyxcbiAgICBwcm9jZXNzZWRVcmxzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKVxuKTogUHJvbWlzZTxQYXJzZVJlc3VsdD4ge1xuXG4gICAgLy8gUHJldmVudCBpbmZpbml0ZSByZWN1cnNpb24gYW5kIGR1cGxpY2F0ZSBwcm9jZXNzaW5nXG4gICAgaWYgKGRlcHRoID4gbWF4RGVwdGgpIHtcbiAgICAgICAgY29uc29sZS5sb2coYE1heCBkZXB0aCAke21heERlcHRofSByZWFjaGVkLCBza2lwcGluZzogJHtzaXRlbWFwVXJsfWApO1xuICAgICAgICByZXR1cm4geyB1cmxzOiBbXSwgbmVzdGVkU2l0ZW1hcHM6IDAgfTtcbiAgICB9XG5cbiAgICBpZiAocHJvY2Vzc2VkVXJscy5oYXMoc2l0ZW1hcFVybCkpIHtcbiAgICAgICAgY29uc29sZS5sb2coYEFscmVhZHkgcHJvY2Vzc2VkOiAke3NpdGVtYXBVcmx9YCk7XG4gICAgICAgIHJldHVybiB7IHVybHM6IFtdLCBuZXN0ZWRTaXRlbWFwczogMCB9O1xuICAgIH1cblxuICAgIHByb2Nlc3NlZFVybHMuYWRkKHNpdGVtYXBVcmwpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoYEZldGNoaW5nIHNpdGVtYXA6ICR7c2l0ZW1hcFVybH1gLCAnc2l0ZW1hcC1wYXJzaW5nJyk7XG5cbiAgICAgICAgLy8gRmV0Y2ggc2l0ZW1hcCBjb250ZW50IHdpdGggdGltZW91dCBoYW5kbGluZ1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgMTAwMDApOyAvLyAxMCBzZWNvbmQgdGltZW91dFxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goc2l0ZW1hcFVybCwge1xuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdVc2VyLUFnZW50JzogJ0xlbnN5IERvY3VtZW50YXRpb24gUXVhbGl0eSBBdWRpdG9yLzEuMCdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuXG4gICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ2NvbnRlbnQtdHlwZScpIHx8ICcnO1xuICAgICAgICBsZXQgeG1sQ29udGVudDogc3RyaW5nO1xuXG4gICAgICAgIC8vIEhhbmRsZSBjb21wcmVzc2VkIHNpdGVtYXBzXG4gICAgICAgIGlmIChjb250ZW50VHlwZS5pbmNsdWRlcygnZ3ppcCcpIHx8IHNpdGVtYXBVcmwuZW5kc1dpdGgoJy5neicpKSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9ncmVzcy5wcm9ncmVzcygnRGVjb21wcmVzc2luZyBnemlwcGVkIHNpdGVtYXAuLi4nLCAnc2l0ZW1hcC1wYXJzaW5nJyk7XG4gICAgICAgICAgICAvLyBGb3Igbm93LCBhc3N1bWUgdW5jb21wcmVzc2VkLiBJbiBwcm9kdWN0aW9uLCB3b3VsZCB1c2UgemxpYlxuICAgICAgICAgICAgeG1sQ29udGVudCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHhtbENvbnRlbnQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYXJzZSBYTUxcbiAgICAgICAgY29uc3QgcGFyc2VkWG1sOiBQYXJzZWRTaXRlbWFwID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgcGFyc2VTdHJpbmcoeG1sQ29udGVudCwge1xuICAgICAgICAgICAgICAgIGV4cGxpY2l0QXJyYXk6IHRydWUsXG4gICAgICAgICAgICAgICAgaWdub3JlQXR0cnM6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHRyaW06IHRydWVcbiAgICAgICAgICAgIH0sIChlcnI6IGFueSwgcmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICBlbHNlIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgYWxsVXJsczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgbGV0IG5lc3RlZFNpdGVtYXBDb3VudCA9IDA7XG5cbiAgICAgICAgLy8gSGFuZGxlIHNpdGVtYXAgaW5kZXggKGNvbnRhaW5zIHJlZmVyZW5jZXMgdG8gb3RoZXIgc2l0ZW1hcHMpXG4gICAgICAgIGlmIChwYXJzZWRYbWwuc2l0ZW1hcGluZGV4Py5zaXRlbWFwKSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9ncmVzcy5wcm9ncmVzcyhgRm91bmQgc2l0ZW1hcCBpbmRleCB3aXRoICR7cGFyc2VkWG1sLnNpdGVtYXBpbmRleC5zaXRlbWFwLmxlbmd0aH0gbmVzdGVkIHNpdGVtYXBzYCwgJ3NpdGVtYXAtcGFyc2luZycpO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IG5lc3RlZFNpdGVtYXAgb2YgcGFyc2VkWG1sLnNpdGVtYXBpbmRleC5zaXRlbWFwKSB7XG4gICAgICAgICAgICAgICAgaWYgKG5lc3RlZFNpdGVtYXAubG9jICYmIG5lc3RlZFNpdGVtYXAubG9jWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5lc3RlZFVybCA9IG5lc3RlZFNpdGVtYXAubG9jWzBdLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgbmVzdGVkIHNpdGVtYXA6ICR7bmVzdGVkVXJsfWApO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5lc3RlZFJlc3VsdCA9IGF3YWl0IHBhcnNlU2l0ZW1hcFJlY3Vyc2l2ZWx5KFxuICAgICAgICAgICAgICAgICAgICAgICAgbmVzdGVkVXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXB0aCArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhEZXB0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZFVybHNcbiAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICBhbGxVcmxzLnB1c2goLi4ubmVzdGVkUmVzdWx0LnVybHMpO1xuICAgICAgICAgICAgICAgICAgICBuZXN0ZWRTaXRlbWFwQ291bnQgKz0gMSArIG5lc3RlZFJlc3VsdC5uZXN0ZWRTaXRlbWFwcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBIYW5kbGUgcmVndWxhciBzaXRlbWFwIChjb250YWlucyBhY3R1YWwgVVJMcylcbiAgICAgICAgaWYgKHBhcnNlZFhtbC51cmxzZXQ/LnVybCkge1xuICAgICAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoYEV4dHJhY3RpbmcgJHtwYXJzZWRYbWwudXJsc2V0LnVybC5sZW5ndGh9IFVSTHMgZnJvbSBzaXRlbWFwYCwgJ3NpdGVtYXAtcGFyc2luZycpO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHVybEVudHJ5IG9mIHBhcnNlZFhtbC51cmxzZXQudXJsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHVybEVudHJ5LmxvYyAmJiB1cmxFbnRyeS5sb2NbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJsID0gdXJsRW50cnkubG9jWzBdLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVybCAmJiBpc1ZhbGlkVXJsKHVybCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbFVybHMucHVzaCh1cmwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXNcbiAgICAgICAgY29uc3QgdW5pcXVlVXJscyA9IFsuLi5uZXcgU2V0KGFsbFVybHMpXTtcblxuICAgICAgICBpZiAoZGVwdGggPT09IDApIHtcbiAgICAgICAgICAgIGF3YWl0IHByb2dyZXNzLnByb2dyZXNzKGBTaXRlbWFwIHBhcnNpbmcgY29tcGxldGU6ICR7dW5pcXVlVXJscy5sZW5ndGh9IHVuaXF1ZSBVUkxzIGZvdW5kYCwgJ3NpdGVtYXAtcGFyc2luZycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHVybHM6IHVuaXF1ZVVybHMsXG4gICAgICAgICAgICBuZXN0ZWRTaXRlbWFwczogbmVzdGVkU2l0ZW1hcENvdW50XG4gICAgICAgIH07XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBwYXJzaW5nIHNpdGVtYXAgJHtzaXRlbWFwVXJsfTpgLCBlcnJvcik7XG4gICAgICAgIGF3YWl0IHByb2dyZXNzLmVycm9yKGBGYWlsZWQgdG8gcGFyc2Ugc2l0ZW1hcDogJHtzaXRlbWFwVXJsfSAtICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCk7XG5cbiAgICAgICAgLy8gUmV0dXJuIGVtcHR5IHJlc3VsdCBidXQgZG9uJ3QgZmFpbCB0aGUgZW50aXJlIHByb2Nlc3NcbiAgICAgICAgcmV0dXJuIHsgdXJsczogW10sIG5lc3RlZFNpdGVtYXBzOiAwIH07XG4gICAgfVxufVxuXG4vKipcbiAqIFZhbGlkYXRlIFVSTCBmb3JtYXRcbiAqL1xuZnVuY3Rpb24gaXNWYWxpZFVybCh1cmxTdHJpbmc6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwodXJsU3RyaW5nKTtcbiAgICAgICAgcmV0dXJuIHVybC5wcm90b2NvbCA9PT0gJ2h0dHA6JyB8fCB1cmwucHJvdG9jb2wgPT09ICdodHRwczonO1xuICAgIH0gY2F0Y2gge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufSJdfQ==