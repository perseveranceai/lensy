"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProgressPublisher = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const client_apigatewaymanagementapi_1 = require("@aws-sdk/client-apigatewaymanagementapi");
class ProgressPublisher {
    constructor(sessionId) {
        this.apiGatewayClient = null;
        this.sessionId = sessionId;
        this.dynamoClient = new client_dynamodb_1.DynamoDBClient({ region: process.env.AWS_REGION });
        if (process.env.WEBSOCKET_API_ENDPOINT) {
            this.apiGatewayClient = new client_apigatewaymanagementapi_1.ApiGatewayManagementApiClient({
                endpoint: process.env.WEBSOCKET_API_ENDPOINT,
                region: process.env.AWS_REGION
            });
        }
    }
    async progress(message, phase, metadata) {
        await this.publishMessage({
            type: 'progress',
            message,
            timestamp: Date.now(),
            phase,
            metadata
        });
    }
    async success(message, metadata) {
        await this.publishMessage({
            type: 'success',
            message,
            timestamp: Date.now(),
            metadata
        });
    }
    async error(message, metadata) {
        await this.publishMessage({
            type: 'error',
            message,
            timestamp: Date.now(),
            metadata
        });
    }
    async publishMessage(message) {
        if (!this.apiGatewayClient || !process.env.CONNECTIONS_TABLE) {
            console.log('WebSocket not configured, logging message:', message);
            return;
        }
        try {
            // Get connections for this session
            const queryCommand = new client_dynamodb_1.QueryCommand({
                TableName: process.env.CONNECTIONS_TABLE,
                IndexName: 'SessionIdIndex',
                KeyConditionExpression: 'sessionId = :sessionId',
                ExpressionAttributeValues: {
                    ':sessionId': { S: this.sessionId }
                }
            });
            const connections = await this.dynamoClient.send(queryCommand);
            if (!connections.Items || connections.Items.length === 0) {
                console.log('No WebSocket connections found for session:', this.sessionId);
                return;
            }
            // Send message to all connections for this session
            const sendPromises = connections.Items.map(async (item) => {
                const connectionId = item.connectionId?.S;
                if (!connectionId)
                    return;
                try {
                    await this.apiGatewayClient.send(new client_apigatewaymanagementapi_1.PostToConnectionCommand({
                        ConnectionId: connectionId,
                        Data: JSON.stringify(message)
                    }));
                }
                catch (error) {
                    if (error.statusCode === 410) {
                        console.log('Stale connection:', connectionId);
                    }
                    else {
                        console.error('Error sending message to connection:', connectionId, error);
                    }
                }
            });
            await Promise.allSettled(sendPromises);
        }
        catch (error) {
            console.error('Error publishing progress message:', error);
        }
    }
}
exports.ProgressPublisher = ProgressPublisher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZ3Jlc3MtcHVibGlzaGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicHJvZ3Jlc3MtcHVibGlzaGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDhEQUF3RTtBQUN4RSw0RkFBaUg7QUFVakgsTUFBYSxpQkFBaUI7SUFLMUIsWUFBWSxTQUFpQjtRQUhyQixxQkFBZ0IsR0FBeUMsSUFBSSxDQUFDO1FBSWxFLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBQzNCLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztRQUUzRSxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztZQUNyQyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSw4REFBNkIsQ0FBQztnQkFDdEQsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCO2dCQUM1QyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVO2FBQ2pDLENBQUMsQ0FBQztRQUNQLENBQUM7SUFDTCxDQUFDO0lBRUQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFlLEVBQUUsS0FBYyxFQUFFLFFBQThCO1FBQzFFLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQztZQUN0QixJQUFJLEVBQUUsVUFBVTtZQUNoQixPQUFPO1lBQ1AsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7WUFDckIsS0FBSztZQUNMLFFBQVE7U0FDWCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFlLEVBQUUsUUFBOEI7UUFDekQsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDO1lBQ3RCLElBQUksRUFBRSxTQUFTO1lBQ2YsT0FBTztZQUNQLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ3JCLFFBQVE7U0FDWCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFlLEVBQUUsUUFBOEI7UUFDdkQsTUFBTSxJQUFJLENBQUMsY0FBYyxDQUFDO1lBQ3RCLElBQUksRUFBRSxPQUFPO1lBQ2IsT0FBTztZQUNQLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQ3JCLFFBQVE7U0FDWCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sS0FBSyxDQUFDLGNBQWMsQ0FBQyxPQUF3QjtRQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO1lBQzNELE9BQU8sQ0FBQyxHQUFHLENBQUMsNENBQTRDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDbkUsT0FBTztRQUNYLENBQUM7UUFFRCxJQUFJLENBQUM7WUFDRCxtQ0FBbUM7WUFDbkMsTUFBTSxZQUFZLEdBQUcsSUFBSSw4QkFBWSxDQUFDO2dCQUNsQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUI7Z0JBQ3hDLFNBQVMsRUFBRSxnQkFBZ0I7Z0JBQzNCLHNCQUFzQixFQUFFLHdCQUF3QjtnQkFDaEQseUJBQXlCLEVBQUU7b0JBQ3ZCLFlBQVksRUFBRSxFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsU0FBUyxFQUFFO2lCQUN0QzthQUNKLENBQUMsQ0FBQztZQUVILE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFL0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZELE9BQU8sQ0FBQyxHQUFHLENBQUMsNkNBQTZDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUMzRSxPQUFPO1lBQ1gsQ0FBQztZQUVELG1EQUFtRDtZQUNuRCxNQUFNLFlBQVksR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLEVBQUU7Z0JBQ3RELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDO2dCQUMxQyxJQUFJLENBQUMsWUFBWTtvQkFBRSxPQUFPO2dCQUUxQixJQUFJLENBQUM7b0JBQ0QsTUFBTSxJQUFJLENBQUMsZ0JBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksd0RBQXVCLENBQUM7d0JBQzFELFlBQVksRUFBRSxZQUFZO3dCQUMxQixJQUFJLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUM7cUJBQ2hDLENBQUMsQ0FBQyxDQUFDO2dCQUNSLENBQUM7Z0JBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztvQkFDbEIsSUFBSSxLQUFLLENBQUMsVUFBVSxLQUFLLEdBQUcsRUFBRSxDQUFDO3dCQUMzQixPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixFQUFFLFlBQVksQ0FBQyxDQUFDO29CQUNuRCxDQUFDO3lCQUFNLENBQUM7d0JBQ0osT0FBTyxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsRUFBRSxZQUFZLEVBQUUsS0FBSyxDQUFDLENBQUM7b0JBQy9FLENBQUM7Z0JBQ0wsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzNDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyxvQ0FBb0MsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMvRCxDQUFDO0lBQ0wsQ0FBQztDQUNKO0FBN0ZELDhDQTZGQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER5bmFtb0RCQ2xpZW50LCBRdWVyeUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgQXBpR2F0ZXdheU1hbmFnZW1lbnRBcGlDbGllbnQsIFBvc3RUb0Nvbm5lY3Rpb25Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWFwaWdhdGV3YXltYW5hZ2VtZW50YXBpJztcblxuaW50ZXJmYWNlIFByb2dyZXNzTWVzc2FnZSB7XG4gICAgdHlwZTogJ2luZm8nIHwgJ3N1Y2Nlc3MnIHwgJ2Vycm9yJyB8ICdwcm9ncmVzcyc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIHRpbWVzdGFtcDogbnVtYmVyO1xuICAgIHBoYXNlPzogc3RyaW5nO1xuICAgIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pjtcbn1cblxuZXhwb3J0IGNsYXNzIFByb2dyZXNzUHVibGlzaGVyIHtcbiAgICBwcml2YXRlIGR5bmFtb0NsaWVudDogRHluYW1vREJDbGllbnQ7XG4gICAgcHJpdmF0ZSBhcGlHYXRld2F5Q2xpZW50OiBBcGlHYXRld2F5TWFuYWdlbWVudEFwaUNsaWVudCB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgc2Vzc2lvbklkOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcihzZXNzaW9uSWQ6IHN0cmluZykge1xuICAgICAgICB0aGlzLnNlc3Npb25JZCA9IHNlc3Npb25JZDtcbiAgICAgICAgdGhpcy5keW5hbW9DbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5cbiAgICAgICAgaWYgKHByb2Nlc3MuZW52LldFQlNPQ0tFVF9BUElfRU5EUE9JTlQpIHtcbiAgICAgICAgICAgIHRoaXMuYXBpR2F0ZXdheUNsaWVudCA9IG5ldyBBcGlHYXRld2F5TWFuYWdlbWVudEFwaUNsaWVudCh7XG4gICAgICAgICAgICAgICAgZW5kcG9pbnQ6IHByb2Nlc3MuZW52LldFQlNPQ0tFVF9BUElfRU5EUE9JTlQsXG4gICAgICAgICAgICAgICAgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIHByb2dyZXNzKG1lc3NhZ2U6IHN0cmluZywgcGhhc2U/OiBzdHJpbmcsIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pikge1xuICAgICAgICBhd2FpdCB0aGlzLnB1Ymxpc2hNZXNzYWdlKHtcbiAgICAgICAgICAgIHR5cGU6ICdwcm9ncmVzcycsXG4gICAgICAgICAgICBtZXNzYWdlLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgcGhhc2UsXG4gICAgICAgICAgICBtZXRhZGF0YVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBzdWNjZXNzKG1lc3NhZ2U6IHN0cmluZywgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHVibGlzaE1lc3NhZ2Uoe1xuICAgICAgICAgICAgdHlwZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgICAgIG1ldGFkYXRhXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIGVycm9yKG1lc3NhZ2U6IHN0cmluZywgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KSB7XG4gICAgICAgIGF3YWl0IHRoaXMucHVibGlzaE1lc3NhZ2Uoe1xuICAgICAgICAgICAgdHlwZTogJ2Vycm9yJyxcbiAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICBtZXRhZGF0YVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHB1Ymxpc2hNZXNzYWdlKG1lc3NhZ2U6IFByb2dyZXNzTWVzc2FnZSkge1xuICAgICAgICBpZiAoIXRoaXMuYXBpR2F0ZXdheUNsaWVudCB8fCAhcHJvY2Vzcy5lbnYuQ09OTkVDVElPTlNfVEFCTEUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdXZWJTb2NrZXQgbm90IGNvbmZpZ3VyZWQsIGxvZ2dpbmcgbWVzc2FnZTonLCBtZXNzYWdlKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBHZXQgY29ubmVjdGlvbnMgZm9yIHRoaXMgc2Vzc2lvblxuICAgICAgICAgICAgY29uc3QgcXVlcnlDb21tYW5kID0gbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgICAgICAgICAgVGFibGVOYW1lOiBwcm9jZXNzLmVudi5DT05ORUNUSU9OU19UQUJMRSxcbiAgICAgICAgICAgICAgICBJbmRleE5hbWU6ICdTZXNzaW9uSWRJbmRleCcsXG4gICAgICAgICAgICAgICAgS2V5Q29uZGl0aW9uRXhwcmVzc2lvbjogJ3Nlc3Npb25JZCA9IDpzZXNzaW9uSWQnLFxuICAgICAgICAgICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgJzpzZXNzaW9uSWQnOiB7IFM6IHRoaXMuc2Vzc2lvbklkIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvbnMgPSBhd2FpdCB0aGlzLmR5bmFtb0NsaWVudC5zZW5kKHF1ZXJ5Q29tbWFuZCk7XG5cbiAgICAgICAgICAgIGlmICghY29ubmVjdGlvbnMuSXRlbXMgfHwgY29ubmVjdGlvbnMuSXRlbXMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ05vIFdlYlNvY2tldCBjb25uZWN0aW9ucyBmb3VuZCBmb3Igc2Vzc2lvbjonLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBTZW5kIG1lc3NhZ2UgdG8gYWxsIGNvbm5lY3Rpb25zIGZvciB0aGlzIHNlc3Npb25cbiAgICAgICAgICAgIGNvbnN0IHNlbmRQcm9taXNlcyA9IGNvbm5lY3Rpb25zLkl0ZW1zLm1hcChhc3luYyAoaXRlbSkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JZCA9IGl0ZW0uY29ubmVjdGlvbklkPy5TO1xuICAgICAgICAgICAgICAgIGlmICghY29ubmVjdGlvbklkKSByZXR1cm47XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwaUdhdGV3YXlDbGllbnQhLnNlbmQobmV3IFBvc3RUb0Nvbm5lY3Rpb25Db21tYW5kKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIENvbm5lY3Rpb25JZDogY29ubmVjdGlvbklkLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YTogSlNPTi5zdHJpbmdpZnkobWVzc2FnZSlcbiAgICAgICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yLnN0YXR1c0NvZGUgPT09IDQxMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1N0YWxlIGNvbm5lY3Rpb246JywgY29ubmVjdGlvbklkKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNlbmRpbmcgbWVzc2FnZSB0byBjb25uZWN0aW9uOicsIGNvbm5lY3Rpb25JZCwgZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGF3YWl0IFByb21pc2UuYWxsU2V0dGxlZChzZW5kUHJvbWlzZXMpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgcHVibGlzaGluZyBwcm9ncmVzcyBtZXNzYWdlOicsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=