"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const progress_publisher_1 = require("./progress-publisher");
const handler = async (event) => {
    const startTime = Date.now();
    console.log('Starting sitemap health check for session:', event.sessionId);
    // Initialize progress publisher and S3 client
    const progress = new progress_publisher_1.ProgressPublisher(event.sessionId);
    const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
    try {
        // Check if sitemap parsing was successful
        if (!event.sitemapParserResult.Payload.success) {
            throw new Error('Sitemap parsing failed, cannot perform health check');
        }
        const totalUrls = event.sitemapParserResult.Payload.totalUrls;
        const sitemapUrls = event.sitemapParserResult.Payload.sitemapUrls;
        if (totalUrls === 0) {
            await progress.info('No URLs found in sitemap, skipping health check');
            const emptyHealthSummary = {
                totalUrls: 0,
                healthyUrls: 0,
                linkIssues: [],
                healthPercentage: 100,
                processingTime: Date.now() - startTime,
                timestamp: new Date().toISOString()
            };
            return {
                success: true,
                sessionId: event.sessionId,
                totalUrls: 0,
                healthyUrls: 0,
                brokenUrls: 0,
                accessDeniedUrls: 0,
                timeoutUrls: 0,
                otherErrorUrls: 0,
                healthSummary: emptyHealthSummary,
                s3Location: '',
                message: 'No URLs to check',
                processingTime: Date.now() - startTime
            };
        }
        await progress.progress(`Starting bulk health check for ${totalUrls} URLs from sitemap`, 'sitemap-health-check');
        // Perform bulk link validation
        const healthCheckResult = await performBulkLinkValidation(sitemapUrls, progress);
        // Calculate health statistics
        const brokenUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === '404').length;
        const accessDeniedUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === 'access-denied').length;
        const timeoutUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === 'timeout').length;
        const otherErrorUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === 'error').length;
        const healthyUrls = totalUrls - healthCheckResult.linkIssues.length;
        const healthPercentage = Math.round((healthyUrls / totalUrls) * 100);
        // Create health summary
        const healthSummary = {
            totalUrls,
            healthyUrls,
            linkIssues: healthCheckResult.linkIssues,
            healthPercentage,
            processingTime: Date.now() - startTime,
            timestamp: new Date().toISOString()
        };
        // Store results in S3
        const s3Key = `sessions/${event.sessionId}/sitemap-health-results.json`;
        const s3Location = `s3://${process.env.ANALYSIS_BUCKET}/${s3Key}`;
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: process.env.ANALYSIS_BUCKET,
            Key: s3Key,
            Body: JSON.stringify(healthSummary, null, 2),
            ContentType: 'application/json'
        }));
        // Send completion message
        await progress.success(`Sitemap health check complete: ${healthyUrls}/${totalUrls} URLs healthy (${healthPercentage}%)`, {
            totalUrls,
            healthyUrls,
            brokenUrls,
            healthPercentage,
            processingTime: Date.now() - startTime
        });
        console.log(`Sitemap health check completed: ${healthyUrls}/${totalUrls} URLs healthy`);
        return {
            success: true,
            sessionId: event.sessionId,
            totalUrls,
            healthyUrls,
            brokenUrls,
            accessDeniedUrls,
            timeoutUrls,
            otherErrorUrls,
            healthSummary,
            s3Location,
            message: `Health check complete: ${healthyUrls}/${totalUrls} URLs healthy (${healthPercentage}%)`,
            processingTime: Date.now() - startTime
        };
    }
    catch (error) {
        console.error('Sitemap health check failed:', error);
        await progress.error(`Sitemap health check failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
        return {
            success: false,
            sessionId: event.sessionId,
            totalUrls: 0,
            healthyUrls: 0,
            brokenUrls: 0,
            accessDeniedUrls: 0,
            timeoutUrls: 0,
            otherErrorUrls: 0,
            healthSummary: {
                totalUrls: 0,
                healthyUrls: 0,
                linkIssues: [],
                healthPercentage: 0,
                processingTime: Date.now() - startTime,
                timestamp: new Date().toISOString()
            },
            s3Location: '',
            message: `Health check failed: ${error instanceof Error ? error.message : 'Unknown error'}`,
            processingTime: Date.now() - startTime
        };
    }
};
exports.handler = handler;
/**
 * Perform bulk link validation for sitemap URLs
 * Requirements: 30.1, 30.2, 30.3, 30.8, 30.9, 30.10
 */
async function performBulkLinkValidation(urls, progress) {
    if (urls.length === 0) {
        return { linkIssues: [] };
    }
    // Remove duplicates
    const uniqueUrls = [...new Set(urls)];
    await progress.progress(`Checking ${uniqueUrls.length} unique URLs for accessibility`, 'sitemap-health-check');
    const linkIssues = [];
    const maxConcurrent = 10; // Limit concurrent requests to avoid overwhelming servers
    const timeout = 8000; // 8 second timeout (longer than single page validation)
    let processedCount = 0;
    // Process URLs in batches to control concurrency
    for (let i = 0; i < uniqueUrls.length; i += maxConcurrent) {
        const batch = uniqueUrls.slice(i, i + maxConcurrent);
        const promises = batch.map(async (url) => {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (compatible; Lensy Documentation Quality Auditor/1.0; +https://lensy.dev/bot)'
                    },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (response.status === 404) {
                    const linkIssue = {
                        url,
                        status: 404,
                        errorMessage: 'Page not found (404)',
                        issueType: '404'
                    };
                    linkIssues.push(linkIssue);
                }
                else if (response.status === 403) {
                    const linkIssue = {
                        url,
                        status: 403,
                        errorMessage: 'Access denied (403 Forbidden)',
                        issueType: 'access-denied'
                    };
                    linkIssues.push(linkIssue);
                }
                else if (response.status >= 400) {
                    const linkIssue = {
                        url,
                        status: response.status,
                        errorMessage: `HTTP ${response.status}: ${response.statusText}`,
                        issueType: 'error'
                    };
                    linkIssues.push(linkIssue);
                }
                // 2xx and 3xx responses are considered healthy (no action needed)
            }
            catch (error) {
                if (error instanceof Error && error.name === 'AbortError') {
                    const linkIssue = {
                        url,
                        status: 'timeout',
                        errorMessage: 'Request timeout (>8 seconds)',
                        issueType: 'timeout'
                    };
                    linkIssues.push(linkIssue);
                }
                else {
                    const linkIssue = {
                        url,
                        status: 'error',
                        errorMessage: error instanceof Error ? error.message : 'Unknown error',
                        issueType: 'error'
                    };
                    linkIssues.push(linkIssue);
                }
            }
        });
        await Promise.all(promises);
        processedCount += batch.length;
        // Progress update every batch
        const progressPercentage = Math.round((processedCount / uniqueUrls.length) * 100);
        await progress.progress(`Health check progress: ${processedCount}/${uniqueUrls.length} URLs checked (${progressPercentage}%)`, 'sitemap-health-check', { processedCount, totalUrls: uniqueUrls.length, progressPercentage });
    }
    // Final summary
    const brokenCount = linkIssues.filter(issue => issue.issueType === '404').length;
    const accessDeniedCount = linkIssues.filter(issue => issue.issueType === 'access-denied').length;
    const timeoutCount = linkIssues.filter(issue => issue.issueType === 'timeout').length;
    const errorCount = linkIssues.filter(issue => issue.issueType === 'error').length;
    const healthyCount = uniqueUrls.length - linkIssues.length;
    let summaryMessage = `Health check complete: ${healthyCount} healthy`;
    if (brokenCount > 0)
        summaryMessage += `, ${brokenCount} broken (404)`;
    if (accessDeniedCount > 0)
        summaryMessage += `, ${accessDeniedCount} access denied (403)`;
    if (timeoutCount > 0)
        summaryMessage += `, ${timeoutCount} timeout`;
    if (errorCount > 0)
        summaryMessage += `, ${errorCount} other errors`;
    await progress.info(summaryMessage);
    return { linkIssues };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBa0Y7QUFDbEYsNkRBQXlEO0FBNkNsRCxNQUFNLE9BQU8sR0FBcUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO0lBQ3JHLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUUzRSw4Q0FBOEM7SUFDOUMsTUFBTSxRQUFRLEdBQUcsSUFBSSxzQ0FBaUIsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDeEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUVsRSxJQUFJLENBQUM7UUFDRCwwQ0FBMEM7UUFDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDN0MsTUFBTSxJQUFJLEtBQUssQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO1FBQzNFLENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUM5RCxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQztRQUVsRSxJQUFJLFNBQVMsS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNsQixNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQUMsaURBQWlELENBQUMsQ0FBQztZQUV2RSxNQUFNLGtCQUFrQixHQUF5QjtnQkFDN0MsU0FBUyxFQUFFLENBQUM7Z0JBQ1osV0FBVyxFQUFFLENBQUM7Z0JBQ2QsVUFBVSxFQUFFLEVBQUU7Z0JBQ2QsZ0JBQWdC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O0lBQ3RFLElBQUksV0FBVyxHQUFHLENBQUM7UUFBRSxjQUFjLElBQUksS0FBSyxXQUFXLGVBQWUsQ0FBQztJQUN2RSxJQUFJLGlCQUFpQixHQUFHLENBQUM7UUFBRSxjQUFjLElBQUksS0FBSyxpQkFBaUIsc0JBQXNCLENBQUM7SUFDMUYsSUFBSSxZQUFZLEdBQUcsQ0FBQztRQUFFLGNBQWMsSUFBSSxLQUFLLFlBQVksVUFBVSxDQUFDO0lBQ3BFLElBQUksVUFBVSxHQUFHLENBQUM7UUFBRSxjQUFjLElBQUksS0FBSyxVQUFVLGVBQWUsQ0FBQztJQUVyRSxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7SUFFcEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxDQUFDO0FBQzFCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIYW5kbGVyIH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBTM0NsaWVudCwgR2V0T2JqZWN0Q29tbWFuZCwgUHV0T2JqZWN0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1zMyc7XG5pbXBvcnQgeyBQcm9ncmVzc1B1Ymxpc2hlciB9IGZyb20gJy4vcHJvZ3Jlc3MtcHVibGlzaGVyJztcblxuaW50ZXJmYWNlIFNpdGVtYXBIZWFsdGhDaGVja2VyRXZlbnQge1xuICAgIHNlc3Npb25JZDogc3RyaW5nO1xuICAgIHNpdGVtYXBQYXJzZXJSZXN1bHQ6IHtcbiAgICAgICAgUGF5bG9hZDoge1xuICAgICAgICAgICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICAgICAgICAgIHRvdGFsVXJsczogbnVtYmVyO1xuICAgICAgICAgICAgc2l0ZW1hcFVybHM6IHN0cmluZ1tdO1xuICAgICAgICAgICAgczNMb2NhdGlvbjogc3RyaW5nO1xuICAgICAgICB9O1xuICAgIH07XG59XG5cbmludGVyZmFjZSBTaXRlbWFwSGVhbHRoQ2hlY2tlclJlc3BvbnNlIHtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIHNlc3Npb25JZDogc3RyaW5nO1xuICAgIHRvdGFsVXJsczogbnVtYmVyO1xuICAgIGhlYWx0aHlVcmxzOiBudW1iZXI7XG4gICAgYnJva2VuVXJsczogbnVtYmVyO1xuICAgIGFjY2Vzc0RlbmllZFVybHM6IG51bWJlcjtcbiAgICB0aW1lb3V0VXJsczogbnVtYmVyO1xuICAgIG90aGVyRXJyb3JVcmxzOiBudW1iZXI7XG4gICAgaGVhbHRoU3VtbWFyeTogU2l0ZW1hcEhlYWx0aFN1bW1hcnk7XG4gICAgczNMb2NhdGlvbjogc3RyaW5nO1xuICAgIG1lc3NhZ2U6IHN0cmluZztcbiAgICBwcm9jZXNzaW5nVGltZTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgTGlua0lzc3VlIHtcbiAgICB1cmw6IHN0cmluZztcbiAgICBzdGF0dXM6IG51bWJlciB8IHN0cmluZztcbiAgICBlcnJvck1lc3NhZ2U6IHN0cmluZztcbiAgICBpc3N1ZVR5cGU6ICc0MDQnIHwgJ2FjY2Vzcy1kZW5pZWQnIHwgJ3RpbWVvdXQnIHwgJ2Vycm9yJztcbn1cblxuaW50ZXJmYWNlIFNpdGVtYXBIZWFsdGhTdW1tYXJ5IHtcbiAgICB0b3RhbFVybHM6IG51bWJlcjtcbiAgICBoZWFsdGh5VXJsczogbnVtYmVyO1xuICAgIGxpbmtJc3N1ZXM6IExpbmtJc3N1ZVtdO1xuICAgIGhlYWx0aFBlcmNlbnRhZ2U6IG51bWJlcjtcbiAgICBwcm9jZXNzaW5nVGltZTogbnVtYmVyO1xuICAgIHRpbWVzdGFtcDogc3RyaW5nO1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlcjogSGFuZGxlcjxTaXRlbWFwSGVhbHRoQ2hlY2tlckV2ZW50LCBTaXRlbWFwSGVhbHRoQ2hlY2tlclJlc3BvbnNlPiA9IGFzeW5jIChldmVudCkgPT4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgY29uc29sZS5sb2coJ1N0YXJ0aW5nIHNpdGVtYXAgaGVhbHRoIGNoZWNrIGZvciBzZXNzaW9uOicsIGV2ZW50LnNlc3Npb25JZCk7XG5cbiAgICAvLyBJbml0aWFsaXplIHByb2dyZXNzIHB1Ymxpc2hlciBhbmQgUzMgY2xpZW50XG4gICAgY29uc3QgcHJvZ3Jlc3MgPSBuZXcgUHJvZ3Jlc3NQdWJsaXNoZXIoZXZlbnQuc2Vzc2lvbklkKTtcbiAgICBjb25zdCBzM0NsaWVudCA9IG5ldyBTM0NsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB9KTtcblxuICAgIHRyeSB7XG4gICAgICAgIC8vIENoZWNrIGlmIHNpdGVtYXAgcGFyc2luZyB3YXMgc3VjY2Vzc2Z1bFxuICAgICAgICBpZiAoIWV2ZW50LnNpdGVtYXBQYXJzZXJSZXN1bHQuUGF5bG9hZC5zdWNjZXNzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NpdGVtYXAgcGFyc2luZyBmYWlsZWQsIGNhbm5vdCBwZXJmb3JtIGhlYWx0aCBjaGVjaycpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdG90YWxVcmxzID0gZXZlbnQuc2l0ZW1hcFBhcnNlclJlc3VsdC5QYXlsb2FkLnRvdGFsVXJscztcbiAgICAgICAgY29uc3Qgc2l0ZW1hcFVybHMgPSBldmVudC5zaXRlbWFwUGFyc2VyUmVzdWx0LlBheWxvYWQuc2l0ZW1hcFVybHM7XG5cbiAgICAgICAgaWYgKHRvdGFsVXJscyA9PT0gMCkge1xuICAgICAgICAgICAgYXdhaXQgcHJvZ3Jlc3MuaW5mbygnTm8gVVJMcyBmb3VuZCBpbiBzaXRlbWFwLCBza2lwcGluZyBoZWFsdGggY2hlY2snKTtcblxuICAgICAgICAgICAgY29uc3QgZW1wdHlIZWFsdGhTdW1tYXJ5OiBTaXRlbWFwSGVhbHRoU3VtbWFyeSA9IHtcbiAgICAgICAgICAgICAgICB0b3RhbFVybHM6IDAsXG4gICAgICAgICAgICAgICAgaGVhbHRoeVVybHM6IDAsXG4gICAgICAgICAgICAgICAgbGlua0lzc3VlczogW10sXG4gICAgICAgICAgICAgICAgaGVhbHRoUGVyY2VudGFnZTogMTAwLFxuICAgICAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICAgICAgc2Vzc2lvbklkOiBldmVudC5zZXNzaW9uSWQsXG4gICAgICAgICAgICAgICAgdG90YWxVcmxzOiAwLFxuICAgICAgICAgICAgICAgIGhlYWx0aHlVcmxzOiAwLFxuICAgICAgICAgICAgICAgIGJyb2tlblVybHM6IDAsXG4gICAgICAgICAgICAgICAgYWNjZXNzRGVuaWVkVXJsczogMCxcbiAgICAgICAgICAgICAgICB0aW1lb3V0VXJsczogMCxcbiAgICAgICAgICAgICAgICBvdGhlckVycm9yVXJsczogMCxcbiAgICAgICAgICAgICAgICBoZWFsdGhTdW1tYXJ5OiBlbXB0eUhlYWx0aFN1bW1hcnksXG4gICAgICAgICAgICAgICAgczNMb2NhdGlvbjogJycsXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogJ05vIFVSTHMgdG8gY2hlY2snLFxuICAgICAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG5cbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoYFN0YXJ0aW5nIGJ1bGsgaGVhbHRoIGNoZWNrIGZvciAke3RvdGFsVXJsc30gVVJMcyBmcm9tIHNpdGVtYXBgLCAnc2l0ZW1hcC1oZWFsdGgtY2hlY2snKTtcblxuICAgICAgICAvLyBQZXJmb3JtIGJ1bGsgbGluayB2YWxpZGF0aW9uXG4gICAgICAgIGNvbnN0IGhlYWx0aENoZWNrUmVzdWx0ID0gYXdhaXQgcGVyZm9ybUJ1bGtMaW5rVmFsaWRhdGlvbihzaXRlbWFwVXJscywgcHJvZ3Jlc3MpO1xuXG4gICAgICAgIC8vIENhbGN1bGF0ZSBoZWFsdGggc3RhdGlzdGljc1xuICAgICAgICBjb25zdCBicm9rZW5VcmxzID0gaGVhbHRoQ2hlY2tSZXN1bHQubGlua0lzc3Vlcy5maWx0ZXIoaXNzdWUgPT4gaXNzdWUuaXNzdWVUeXBlID09PSAnNDA0JykubGVuZ3RoO1xuICAgICAgICBjb25zdCBhY2Nlc3NEZW5pZWRVcmxzID0gaGVhbHRoQ2hlY2tSZXN1bHQubGlua0lzc3Vlcy5maWx0ZXIoaXNzdWUgPT4gaXNzdWUuaXNzdWVUeXBlID09PSAnYWNjZXNzLWRlbmllZCcpLmxlbmd0aDtcbiAgICAgICAgY29uc3QgdGltZW91dFVybHMgPSBoZWFsdGhDaGVja1Jlc3VsdC5saW5rSXNzdWVzLmZpbHRlcihpc3N1ZSA9PiBpc3N1ZS5pc3N1ZVR5cGUgPT09ICd0aW1lb3V0JykubGVuZ3RoO1xuICAgICAgICBjb25zdCBvdGhlckVycm9yVXJscyA9IGhlYWx0aENoZWNrUmVzdWx0LmxpbmtJc3N1ZXMuZmlsdGVyKGlzc3VlID0+IGlzc3VlLmlzc3VlVHlwZSA9PT0gJ2Vycm9yJykubGVuZ3RoO1xuICAgICAgICBjb25zdCBoZWFsdGh5VXJscyA9IHRvdGFsVXJscyAtIGhlYWx0aENoZWNrUmVzdWx0LmxpbmtJc3N1ZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCBoZWFsdGhQZXJjZW50YWdlID0gTWF0aC5yb3VuZCgoaGVhbHRoeVVybHMgLyB0b3RhbFVybHMpICogMTAwKTtcblxuICAgICAgICAvLyBDcmVhdGUgaGVhbHRoIHN1bW1hcnlcbiAgICAgICAgY29uc3QgaGVhbHRoU3VtbWFyeTogU2l0ZW1hcEhlYWx0aFN1bW1hcnkgPSB7XG4gICAgICAgICAgICB0b3RhbFVybHMsXG4gICAgICAgICAgICBoZWFsdGh5VXJscyxcbiAgICAgICAgICAgIGxpbmtJc3N1ZXM6IGhlYWx0aENoZWNrUmVzdWx0LmxpbmtJc3N1ZXMsXG4gICAgICAgICAgICBoZWFsdGhQZXJjZW50YWdlLFxuICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFN0b3JlIHJlc3VsdHMgaW4gUzNcbiAgICAgICAgY29uc3QgczNLZXkgPSBgc2Vzc2lvbnMvJHtldmVudC5zZXNzaW9uSWR9L3NpdGVtYXAtaGVhbHRoLXJlc3VsdHMuanNvbmA7XG4gICAgICAgIGNvbnN0IHMzTG9jYXRpb24gPSBgczM6Ly8ke3Byb2Nlc3MuZW52LkFOQUxZU0lTX0JVQ0tFVH0vJHtzM0tleX1gO1xuXG4gICAgICAgIGF3YWl0IHMzQ2xpZW50LnNlbmQobmV3IFB1dE9iamVjdENvbW1hbmQoe1xuICAgICAgICAgICAgQnVja2V0OiBwcm9jZXNzLmVudi5BTkFMWVNJU19CVUNLRVQsXG4gICAgICAgICAgICBLZXk6IHMzS2V5LFxuICAgICAgICAgICAgQm9keTogSlNPTi5zdHJpbmdpZnkoaGVhbHRoU3VtbWFyeSwgbnVsbCwgMiksXG4gICAgICAgICAgICBDb250ZW50VHlwZTogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgIH0pKTtcblxuICAgICAgICAvLyBTZW5kIGNvbXBsZXRpb24gbWVzc2FnZVxuICAgICAgICBhd2FpdCBwcm9ncmVzcy5zdWNjZXNzKFxuICAgICAgICAgICAgYFNpdGVtYXAgaGVhbHRoIGNoZWNrIGNvbXBsZXRlOiAke2hlYWx0aHlVcmxzfS8ke3RvdGFsVXJsc30gVVJMcyBoZWFsdGh5ICgke2hlYWx0aFBlcmNlbnRhZ2V9JSlgLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHRvdGFsVXJscyxcbiAgICAgICAgICAgICAgICBoZWFsdGh5VXJscyxcbiAgICAgICAgICAgICAgICBicm9rZW5VcmxzLFxuICAgICAgICAgICAgICAgIGhlYWx0aFBlcmNlbnRhZ2UsXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcblxuICAgICAgICBjb25zb2xlLmxvZyhgU2l0ZW1hcCBoZWFsdGggY2hlY2sgY29tcGxldGVkOiAke2hlYWx0aHlVcmxzfS8ke3RvdGFsVXJsc30gVVJMcyBoZWFsdGh5YCk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBzZXNzaW9uSWQ6IGV2ZW50LnNlc3Npb25JZCxcbiAgICAgICAgICAgIHRvdGFsVXJscyxcbiAgICAgICAgICAgIGhlYWx0aHlVcmxzLFxuICAgICAgICAgICAgYnJva2VuVXJscyxcbiAgICAgICAgICAgIGFjY2Vzc0RlbmllZFVybHMsXG4gICAgICAgICAgICB0aW1lb3V0VXJscyxcbiAgICAgICAgICAgIG90aGVyRXJyb3JVcmxzLFxuICAgICAgICAgICAgaGVhbHRoU3VtbWFyeSxcbiAgICAgICAgICAgIHMzTG9jYXRpb24sXG4gICAgICAgICAgICBtZXNzYWdlOiBgSGVhbHRoIGNoZWNrIGNvbXBsZXRlOiAke2hlYWx0aHlVcmxzfS8ke3RvdGFsVXJsc30gVVJMcyBoZWFsdGh5ICgke2hlYWx0aFBlcmNlbnRhZ2V9JSlgLFxuICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgICAgfTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1NpdGVtYXAgaGVhbHRoIGNoZWNrIGZhaWxlZDonLCBlcnJvcik7XG5cbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3MuZXJyb3IoYFNpdGVtYXAgaGVhbHRoIGNoZWNrIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBzZXNzaW9uSWQ6IGV2ZW50LnNlc3Npb25JZCxcbiAgICAgICAgICAgIHRvdGFsVXJsczogMCxcbiAgICAgICAgICAgIGhlYWx0aHlVcmxzOiAwLFxuICAgICAgICAgICAgYnJva2VuVXJsczogMCxcbiAgICAgICAgICAgIGFjY2Vzc0RlbmllZFVybHM6IDAsXG4gICAgICAgICAgICB0aW1lb3V0VXJsczogMCxcbiAgICAgICAgICAgIG90aGVyRXJyb3JVcmxzOiAwLFxuICAgICAgICAgICAgaGVhbHRoU3VtbWFyeToge1xuICAgICAgICAgICAgICAgIHRvdGFsVXJsczogMCxcbiAgICAgICAgICAgICAgICBoZWFsdGh5VXJsczogMCxcbiAgICAgICAgICAgICAgICBsaW5rSXNzdWVzOiBbXSxcbiAgICAgICAgICAgICAgICBoZWFsdGhQZXJjZW50YWdlOiAwLFxuICAgICAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgczNMb2NhdGlvbjogJycsXG4gICAgICAgICAgICBtZXNzYWdlOiBgSGVhbHRoIGNoZWNrIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgICAgfTtcbiAgICB9XG59O1xuXG4vKipcbiAqIFBlcmZvcm0gYnVsayBsaW5rIHZhbGlkYXRpb24gZm9yIHNpdGVtYXAgVVJMc1xuICogUmVxdWlyZW1lbnRzOiAzMC4xLCAzMC4yLCAzMC4zLCAzMC44LCAzMC45LCAzMC4xMFxuICovXG5hc3luYyBmdW5jdGlvbiBwZXJmb3JtQnVsa0xpbmtWYWxpZGF0aW9uKFxuICAgIHVybHM6IHN0cmluZ1tdLFxuICAgIHByb2dyZXNzOiBQcm9ncmVzc1B1Ymxpc2hlclxuKTogUHJvbWlzZTx7IGxpbmtJc3N1ZXM6IExpbmtJc3N1ZVtdIH0+IHtcblxuICAgIGlmICh1cmxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4geyBsaW5rSXNzdWVzOiBbXSB9O1xuICAgIH1cblxuICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzXG4gICAgY29uc3QgdW5pcXVlVXJscyA9IFsuLi5uZXcgU2V0KHVybHMpXTtcblxuICAgIGF3YWl0IHByb2dyZXNzLnByb2dyZXNzKGBDaGVja2luZyAke3VuaXF1ZVVybHMubGVuZ3RofSB1bmlxdWUgVVJMcyBmb3IgYWNjZXNzaWJpbGl0eWAsICdzaXRlbWFwLWhlYWx0aC1jaGVjaycpO1xuXG4gICAgY29uc3QgbGlua0lzc3VlczogTGlua0lzc3VlW10gPSBbXTtcbiAgICBjb25zdCBtYXhDb25jdXJyZW50ID0gMTA7IC8vIExpbWl0IGNvbmN1cnJlbnQgcmVxdWVzdHMgdG8gYXZvaWQgb3ZlcndoZWxtaW5nIHNlcnZlcnNcbiAgICBjb25zdCB0aW1lb3V0ID0gODAwMDsgLy8gOCBzZWNvbmQgdGltZW91dCAobG9uZ2VyIHRoYW4gc2luZ2xlIHBhZ2UgdmFsaWRhdGlvbilcblxuICAgIGxldCBwcm9jZXNzZWRDb3VudCA9IDA7XG5cbiAgICAvLyBQcm9jZXNzIFVSTHMgaW4gYmF0Y2hlcyB0byBjb250cm9sIGNvbmN1cnJlbmN5XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1bmlxdWVVcmxzLmxlbmd0aDsgaSArPSBtYXhDb25jdXJyZW50KSB7XG4gICAgICAgIGNvbnN0IGJhdGNoID0gdW5pcXVlVXJscy5zbGljZShpLCBpICsgbWF4Q29uY3VycmVudCk7XG5cbiAgICAgICAgY29uc3QgcHJvbWlzZXMgPSBiYXRjaC5tYXAoYXN5bmMgKHVybCkgPT4ge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVvdXRJZCA9IHNldFRpbWVvdXQoKCkgPT4gY29udHJvbGxlci5hYm9ydCgpLCB0aW1lb3V0KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7XG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdVc2VyLUFnZW50JzogJ01vemlsbGEvNS4wIChjb21wYXRpYmxlOyBMZW5zeSBEb2N1bWVudGF0aW9uIFF1YWxpdHkgQXVkaXRvci8xLjA7ICtodHRwczovL2xlbnN5LmRldi9ib3QpJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsXG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcblxuICAgICAgICAgICAgICAgIGlmIChyZXNwb25zZS5zdGF0dXMgPT09IDQwNCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5rSXNzdWU6IExpbmtJc3N1ZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogNDA0LFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiAnUGFnZSBub3QgZm91bmQgKDQwNCknLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNzdWVUeXBlOiAnNDA0J1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBsaW5rSXNzdWVzLnB1c2gobGlua0lzc3VlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDAzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmtJc3N1ZTogTGlua0lzc3VlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiA0MDMsXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2U6ICdBY2Nlc3MgZGVuaWVkICg0MDMgRm9yYmlkZGVuKScsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc3N1ZVR5cGU6ICdhY2Nlc3MtZGVuaWVkJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBsaW5rSXNzdWVzLnB1c2gobGlua0lzc3VlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1cyA+PSA0MDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua0lzc3VlOiBMaW5rSXNzdWUgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IHJlc3BvbnNlLnN0YXR1cyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZTogYEhUVFAgJHtyZXNwb25zZS5zdGF0dXN9OiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzc3VlVHlwZTogJ2Vycm9yJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBsaW5rSXNzdWVzLnB1c2gobGlua0lzc3VlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gMnh4IGFuZCAzeHggcmVzcG9uc2VzIGFyZSBjb25zaWRlcmVkIGhlYWx0aHkgKG5vIGFjdGlvbiBuZWVkZWQpXG5cbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3IubmFtZSA9PT0gJ0Fib3J0RXJyb3InKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmtJc3N1ZTogTGlua0lzc3VlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAndGltZW91dCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2U6ICdSZXF1ZXN0IHRpbWVvdXQgKD44IHNlY29uZHMpJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzc3VlVHlwZTogJ3RpbWVvdXQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGxpbmtJc3N1ZXMucHVzaChsaW5rSXNzdWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmtJc3N1ZTogTGlua0lzc3VlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAnZXJyb3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzc3VlVHlwZTogJ2Vycm9yJ1xuICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICBsaW5rSXNzdWVzLnB1c2gobGlua0lzc3VlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcblxuICAgICAgICBwcm9jZXNzZWRDb3VudCArPSBiYXRjaC5sZW5ndGg7XG5cbiAgICAgICAgLy8gUHJvZ3Jlc3MgdXBkYXRlIGV2ZXJ5IGJhdGNoXG4gICAgICAgIGNvbnN0IHByb2dyZXNzUGVyY2VudGFnZSA9IE1hdGgucm91bmQoKHByb2Nlc3NlZENvdW50IC8gdW5pcXVlVXJscy5sZW5ndGgpICogMTAwKTtcbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoXG4gICAgICAgICAgICBgSGVhbHRoIGNoZWNrIHByb2dyZXNzOiAke3Byb2Nlc3NlZENvdW50fS8ke3VuaXF1ZVVybHMubGVuZ3RofSBVUkxzIGNoZWNrZWQgKCR7cHJvZ3Jlc3NQZXJjZW50YWdlfSUpYCxcbiAgICAgICAgICAgICdzaXRlbWFwLWhlYWx0aC1jaGVjaycsXG4gICAgICAgICAgICB7IHByb2Nlc3NlZENvdW50LCB0b3RhbFVybHM6IHVuaXF1ZVVybHMubGVuZ3RoLCBwcm9ncmVzc1BlcmNlbnRhZ2UgfVxuICAgICAgICApO1xuICAgIH1cblxuICAgIC8vIEZpbmFsIHN1bW1hcnlcbiAgICBjb25zdCBicm9rZW5Db3VudCA9IGxpbmtJc3N1ZXMuZmlsdGVyKGlzc3VlID0+IGlzc3VlLmlzc3VlVHlwZSA9PT0gJzQwNCcpLmxlbmd0aDtcbiAgICBjb25zdCBhY2Nlc3NEZW5pZWRDb3VudCA9IGxpbmtJc3N1ZXMuZmlsdGVyKGlzc3VlID0+IGlzc3VlLmlzc3VlVHlwZSA9PT0gJ2FjY2Vzcy1kZW5pZWQnKS5sZW5ndGg7XG4gICAgY29uc3QgdGltZW91dENvdW50ID0gbGlua0lzc3Vlcy5maWx0ZXIoaXNzdWUgPT4gaXNzdWUuaXNzdWVUeXBlID09PSAndGltZW91dCcpLmxlbmd0aDtcbiAgICBjb25zdCBlcnJvckNvdW50ID0gbGlua0lzc3Vlcy5maWx0ZXIoaXNzdWUgPT4gaXNzdWUuaXNzdWVUeXBlID09PSAnZXJyb3InKS5sZW5ndGg7XG4gICAgY29uc3QgaGVhbHRoeUNvdW50ID0gdW5pcXVlVXJscy5sZW5ndGggLSBsaW5rSXNzdWVzLmxlbmd0aDtcblxuICAgIGxldCBzdW1tYXJ5TWVzc2FnZSA9IGBIZWFsdGggY2hlY2sgY29tcGxldGU6ICR7aGVhbHRoeUNvdW50fSBoZWFsdGh5YDtcbiAgICBpZiAoYnJva2VuQ291bnQgPiAwKSBzdW1tYXJ5TWVzc2FnZSArPSBgLCAke2Jyb2tlbkNvdW50fSBicm9rZW4gKDQwNClgO1xuICAgIGlmIChhY2Nlc3NEZW5pZWRDb3VudCA+IDApIHN1bW1hcnlNZXNzYWdlICs9IGAsICR7YWNjZXNzRGVuaWVkQ291bnR9IGFjY2VzcyBkZW5pZWQgKDQwMylgO1xuICAgIGlmICh0aW1lb3V0Q291bnQgPiAwKSBzdW1tYXJ5TWVzc2FnZSArPSBgLCAke3RpbWVvdXRDb3VudH0gdGltZW91dGA7XG4gICAgaWYgKGVycm9yQ291bnQgPiAwKSBzdW1tYXJ5TWVzc2FnZSArPSBgLCAke2Vycm9yQ291bnR9IG90aGVyIGVycm9yc2A7XG5cbiAgICBhd2FpdCBwcm9ncmVzcy5pbmZvKHN1bW1hcnlNZXNzYWdlKTtcblxuICAgIHJldHVybiB7IGxpbmtJc3N1ZXMgfTtcbn0iXX0=