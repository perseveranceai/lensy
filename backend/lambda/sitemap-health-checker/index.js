"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const progress_publisher_1 = require("./progress-publisher");
const handler = async (event) => {
    const startTime = Date.now();
    console.log('Starting sitemap health check for session:', event.sessionId);
    // Initialize progress publisher and S3 client
    const progress = new progress_publisher_1.ProgressPublisher(event.sessionId);
    const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
    try {
        // Check if sitemap parsing was successful
        if (!event.sitemapParserResult.Payload.success) {
            throw new Error('Sitemap parsing failed, cannot perform health check');
        }
        const totalUrls = event.sitemapParserResult.Payload.totalUrls;
        const sitemapUrls = event.sitemapParserResult.Payload.sitemapUrls;
        if (totalUrls === 0) {
            await progress.info('No URLs found in sitemap, skipping health check');
            const emptyHealthSummary = {
                totalUrls: 0,
                healthyUrls: 0,
                linkIssues: [],
                healthPercentage: 100,
                processingTime: Date.now() - startTime,
                timestamp: new Date().toISOString()
            };
            return {
                success: true,
                sessionId: event.sessionId,
                totalUrls: 0,
                healthyUrls: 0,
                brokenUrls: 0,
                accessDeniedUrls: 0,
                timeoutUrls: 0,
                otherErrorUrls: 0,
                healthSummary: emptyHealthSummary,
                s3Location: '',
                message: 'No URLs to check',
                processingTime: Date.now() - startTime
            };
        }
        await progress.progress(`Starting bulk health check for ${totalUrls} URLs from sitemap`, 'sitemap-health-check');
        // Perform bulk link validation
        const healthCheckResult = await performBulkLinkValidation(sitemapUrls, progress);
        // Calculate health statistics
        const brokenUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === '404').length;
        const accessDeniedUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === 'access-denied').length;
        const timeoutUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === 'timeout').length;
        const otherErrorUrls = healthCheckResult.linkIssues.filter(issue => issue.issueType === 'error').length;
        const healthyUrls = totalUrls - healthCheckResult.linkIssues.length;
        const healthPercentage = Math.round((healthyUrls / totalUrls) * 100);
        // Create health summary
        const healthSummary = {
            totalUrls,
            healthyUrls,
            linkIssues: healthCheckResult.linkIssues,
            healthPercentage,
            processingTime: Date.now() - startTime,
            timestamp: new Date().toISOString()
        };
        // Store results in S3
        const s3Key = `sessions/${event.sessionId}/sitemap-health-results.json`;
        const s3Location = `s3://${process.env.ANALYSIS_BUCKET}/${s3Key}`;
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: process.env.ANALYSIS_BUCKET,
            Key: s3Key,
            Body: JSON.stringify(healthSummary, null, 2),
            ContentType: 'application/json'
        }));
        // Send completion message
        await progress.success(`Sitemap health check complete: ${healthyUrls}/${totalUrls} URLs healthy (${healthPercentage}%)`, {
            totalUrls,
            healthyUrls,
            brokenUrls,
            healthPercentage,
            processingTime: Date.now() - startTime
        });
        console.log(`Sitemap health check completed: ${healthyUrls}/${totalUrls} URLs healthy`);
        return {
            success: true,
            sessionId: event.sessionId,
            totalUrls,
            healthyUrls,
            brokenUrls,
            accessDeniedUrls,
            timeoutUrls,
            otherErrorUrls,
            healthSummary,
            s3Location,
            message: `Health check complete: ${healthyUrls}/${totalUrls} URLs healthy (${healthPercentage}%)`,
            processingTime: Date.now() - startTime
        };
    }
    catch (error) {
        console.error('Sitemap health check failed:', error);
        await progress.error(`Sitemap health check failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
        return {
            success: false,
            sessionId: event.sessionId,
            totalUrls: 0,
            healthyUrls: 0,
            brokenUrls: 0,
            accessDeniedUrls: 0,
            timeoutUrls: 0,
            otherErrorUrls: 0,
            healthSummary: {
                totalUrls: 0,
                healthyUrls: 0,
                linkIssues: [],
                healthPercentage: 0,
                processingTime: Date.now() - startTime,
                timestamp: new Date().toISOString()
            },
            s3Location: '',
            message: `Health check failed: ${error instanceof Error ? error.message : 'Unknown error'}`,
            processingTime: Date.now() - startTime
        };
    }
};
exports.handler = handler;
/**
 * Perform bulk link validation for sitemap URLs
 * Requirements: 30.1, 30.2, 30.3, 30.8, 30.9, 30.10
 */
async function performBulkLinkValidation(urls, progress) {
    if (urls.length === 0) {
        return { linkIssues: [] };
    }
    // Remove duplicates
    const uniqueUrls = [...new Set(urls)];
    await progress.progress(`Checking ${uniqueUrls.length} unique URLs for accessibility`, 'sitemap-health-check');
    const linkIssues = [];
    const maxConcurrent = 10; // Limit concurrent requests to avoid overwhelming servers
    const timeout = 8000; // 8 second timeout (longer than single page validation)
    let processedCount = 0;
    // Process URLs in batches to control concurrency
    for (let i = 0; i < uniqueUrls.length; i += maxConcurrent) {
        const batch = uniqueUrls.slice(i, i + maxConcurrent);
        const promises = batch.map(async (url) => {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (compatible; Lensy Documentation Quality Auditor/1.0; +https://lensy.dev/bot)'
                    },
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (response.status === 404) {
                    const linkIssue = {
                        url,
                        status: 404,
                        errorMessage: 'Page not found (404)',
                        issueType: '404'
                    };
                    linkIssues.push(linkIssue);
                }
                else if (response.status === 403) {
                    const linkIssue = {
                        url,
                        status: 403,
                        errorMessage: 'Access denied (403 Forbidden)',
                        issueType: 'access-denied'
                    };
                    linkIssues.push(linkIssue);
                }
                else if (response.status >= 400) {
                    const linkIssue = {
                        url,
                        status: response.status,
                        errorMessage: `HTTP ${response.status}: ${response.statusText}`,
                        issueType: 'error'
                    };
                    linkIssues.push(linkIssue);
                }
                // 2xx and 3xx responses are considered healthy (no action needed)
            }
            catch (error) {
                if (error instanceof Error && error.name === 'AbortError') {
                    const linkIssue = {
                        url,
                        status: 'timeout',
                        errorMessage: 'Request timeout (>8 seconds)',
                        issueType: 'timeout'
                    };
                    linkIssues.push(linkIssue);
                }
                else {
                    const linkIssue = {
                        url,
                        status: 'error',
                        errorMessage: error instanceof Error ? error.message : 'Unknown error',
                        issueType: 'error'
                    };
                    linkIssues.push(linkIssue);
                }
            }
        });
        await Promise.all(promises);
        processedCount += batch.length;
        // Progress update every batch
        const progressPercentage = Math.round((processedCount / uniqueUrls.length) * 100);
        await progress.progress(`Health check progress: ${processedCount}/${uniqueUrls.length} URLs checked (${progressPercentage}%)`, 'sitemap-health-check', { processedCount, totalUrls: uniqueUrls.length, progressPercentage });
    }
    // Final summary
    const brokenCount = linkIssues.filter(issue => issue.issueType === '404').length;
    const accessDeniedCount = linkIssues.filter(issue => issue.issueType === 'access-denied').length;
    const timeoutCount = linkIssues.filter(issue => issue.issueType === 'timeout').length;
    const errorCount = linkIssues.filter(issue => issue.issueType === 'error').length;
    const healthyCount = uniqueUrls.length - linkIssues.length;
    let summaryMessage = `Health check complete: ${healthyCount} healthy`;
    if (brokenCount > 0)
        summaryMessage += `, ${brokenCount} broken (404)`;
    if (accessDeniedCount > 0)
        summaryMessage += `, ${accessDeniedCount} access denied (403)`;
    if (timeoutCount > 0)
        summaryMessage += `, ${timeoutCount} timeout`;
    if (errorCount > 0)
        summaryMessage += `, ${errorCount} other errors`;
    await progress.info(summaryMessage);
    return { linkIssues };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxrREFBa0Y7QUFDbEYsNkRBQXlEO0FBNkNsRCxNQUFNLE9BQU8sR0FBcUUsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO0lBQ3JHLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLDRDQUE0QyxFQUFFLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUUzRSw4Q0FBOEM7SUFDOUMsTUFBTSxRQUFRLEdBQUcsSUFBSSxzQ0FBaUIsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDeEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxvQkFBUSxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztJQUVsRSxJQUFJO1FBQ0EsMENBQTBDO1FBQzFDLElBQUksQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUM1QyxNQUFNLElBQUksS0FBSyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7U0FDMUU7UUFFRCxNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUM5RCxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQztRQUVsRSxJQUFJLFNBQVMsS0FBSyxDQUFDLEVBQUU7WUFDakIsTUFBTSxRQUFRLENBQUMsSUFBSSxDQUFDLGlEQUFpRCxDQUFDLENBQUM7WUFFdkUsTUFBTSxrQkFBa0IsR0FBeUI7Z0JBQzdDLFNBQVMsRUFBRSxDQUFDO2dCQUNaLFdBQVcsRUFBRSxDQUFDO2dCQUNkLFVBQVUsRUFBRSxFQUFFO2dCQUNkLGdCQUFnQixFQUFFLEdBQUc7Z0JBQ3JCLGNBQWMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUztnQkFDdEMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3RDLENBQUM7WUFFRixPQUFPO2dCQUNILE9BQU8sRUFBRSxJQUFJO2dCQUNiLFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztnQkFDMUIsU0FBUyxFQUFFLENBQUM7Z0JBQ1osV0FBVyxFQUFFLENBQUM7Z0JBQ2QsVUFBVSxFQUFFLENBQUM7Z0JBQ2IsZ0JBQWdCLEVBQUUsQ0FBQztnQkFDbkIsV0FBVyxFQUFFLENBQUM7Z0JBQ2QsY0FBYyxFQUFFLENBQUM7Z0JBQ2pCLGFBQWEsRUFBRSxrQkFBa0I7Z0JBQ2pDLFVBQVUsRUFBRSxFQUFFO2dCQUNkLE9BQU8sRUFBRSxrQkFBa0I7Z0JBQzNCLGNBQWMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUzthQUN6QyxDQUFDO1NBQ0w7UUFFRCxNQUFNLFFBQVEsQ0FBQyxRQUFRLENBQUMsa0NBQWtDLFNBQVMsb0JBQW9CLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUVqSCwrQkFBK0I7UUFDL0IsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLHlCQUF5QixDQUFDLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUVqRiw4QkFBOEI7UUFDOUIsTUFBTSxVQUFVLEdBQUcsaUJBQWlCLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssS0FBSyxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xHLE1BQU0sZ0JBQWdCLEdBQUcsaUJBQWlCLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssZUFBZSxDQUFDLENBQUMsTUFBTSxDQUFDO1FBQ2xILE1BQU0sV0FBVyxHQUFHLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUN2RyxNQUFNLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsS0FBSyxPQUFPLENBQUMsQ0FBQyxNQUFNLENBQUM7UUFDeEcsTUFBTSxXQUFXLEdBQUcsU0FBUyxHQUFHLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUM7UUFDcEUsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxHQUFHLFNBQVMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO1FBRXJFLHdCQUF3QjtRQUN4QixNQUFNLGFBQWEsR0FBeUI7WUFDeEMsU0FBUztZQUNULFdBQVc7WUFDWCxVQUFVLEVBQUUsaUJBQWlCLENBQUMsVUFBVTtZQUN4QyxnQkFBZ0I7WUFDaEIsY0FBYyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxTQUFTO1lBQ3RDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN0QyxDQUFDO1FBRUYsc0JBQXNCO1FBQ3RCLE1BQU0sS0FBSyxHQUFHLFlBQVksS0FBSyxDQUFDLFNBQVMsOEJBQThCLENBQUM7UUFDeEUsTUFBTSxVQUFVLEdBQUcsUUFBUSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUVsRSxNQUFNLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSw0QkFBZ0IsQ0FBQztZQUNyQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlO1lBQ25DLEdBQUcsRUFBRSxLQUFLO1lBQ1YsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDNUMsV0FBVyxFQUFFLGtCQUFrQjtTQUNsQyxDQUFDLENBQUMsQ0FBQztRQUVKLDBCQUEwQjtRQUMxQixNQUFNLFFBQVEsQ0FBQyxPQUFPLENBQ2xCLGtDQUFrQyxXQUFXLElBQUksU0FBUyxrQkFBa0IsZ0JBQWdCLElBQUksRUFDaEc7WUFDSSxTQUFTO1lBQ1QsV0FBVztZQUNYLFVBQVU7WUFDVixnQkFBZ0I7WUFDaEIsY0FBYyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxTQUFTO1NBQ3pDLENBQ0osQ0FBQztRQUVGLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUNBQW1DLFdBQVcsSUFBSSxTQUFTLGVBQWUsQ0FBQyxDQUFDO1FBRXhGLE9BQU87WUFDSCxPQUFPLEVBQUUsSUFBSTtZQUNiLFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztZQUMxQixTQUFTO1lBQ1QsV0FBVztZQUNYLFVBQVU7WUFDVixnQkFBZ0I7WUFDaEIsV0FBVztZQUNYLGNBQWM7WUFDZCxhQUFhO1lBQ2IsVUFBVTtZQUNWLE9BQU8sRUFBRSwwQkFBMEIsV0FBVyxJQUFJLFNBQVMsa0JBQWtCLGdCQUFnQixJQUFJO1lBQ2pHLGNBQWMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUztTQUN6QyxDQUFDO0tBRUw7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsOEJBQThCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFckQsTUFBTSxRQUFRLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBRWpILE9BQU87WUFDSCxPQUFPLEVBQUUsS0FBSztZQUNkLFNBQVMsRUFBRSxLQUFLLENBQUMsU0FBUztZQUMxQixTQUFTLEVBQUUsQ0FBQztZQUNaLFdBQVcsRUFBRSxDQUFDO1lBQ2QsVUFBVSxFQUFFLENBQUM7WUFDYixnQkFBZ0IsRUFBRSxDQUFDO1lBQ25CLFdBQVcsRUFBRSxDQUFDO1lBQ2QsY0FBYyxFQUFFLENBQUM7WUFDakIsYUFBYSxFQUFFO2dCQUNYLFNBQVMsRUFBRSxDQUFDO2dCQUNaLFdBQVcsRUFBRSxDQUFDO2dCQUNkLFVBQVUsRUFBRSxFQUFFO2dCQUNkLGdCQUFnQixFQUFFLENBQUM7Z0JBQ25CLGNBQWMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUztnQkFDdEMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFLENBQUMsV0FBVyxFQUFFO2FBQ3RDO1lBQ0QsVUFBVSxFQUFFLEVBQUU7WUFDZCxPQUFPLEVBQUUsd0JBQXdCLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWUsRUFBRTtZQUMzRixjQUFjLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVM7U0FDekMsQ0FBQztLQUNMO0FBQ0wsQ0FBQyxDQUFDO0FBdklXLFFBQUEsT0FBTyxXQXVJbEI7QUFFRjs7O0dBR0c7QUFDSCxLQUFLLFVBQVUseUJBQXlCLENBQ3BDLElBQWMsRUFDZCxRQUEyQjtJQUczQixJQUFJLElBQUksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1FBQ25CLE9BQU8sRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUM7S0FDN0I7SUFFRCxvQkFBb0I7SUFDcEIsTUFBTSxVQUFVLEdBQUcsQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFFdEMsTUFBTSxRQUFRLENBQUMsUUFBUSxDQUFDLFlBQVksVUFBVSxDQUFDLE1BQU0sZ0NBQWdDLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztJQUUvRyxNQUFNLFVBQVUsR0FBZ0IsRUFBRSxDQUFDO0lBQ25DLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQyxDQUFDLDBEQUEwRDtJQUNwRixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyx3REFBd0Q7SUFFOUUsSUFBSSxjQUFjLEdBQUcsQ0FBQyxDQUFDO0lBRXZCLGlEQUFpRDtJQUNqRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksYUFBYSxFQUFFO1FBQ3ZELE1BQU0sS0FBSyxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxhQUFhLENBQUMsQ0FBQztRQUVyRCxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtZQUNyQyxJQUFJO2dCQUNBLE1BQU0sVUFBVSxHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7Z0JBQ3pDLE1BQU0sU0FBUyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUM7Z0JBRWhFLE1BQU0sUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLEdBQUcsRUFBRTtvQkFDOUIsTUFBTSxFQUFFLEtBQUs7b0JBQ2IsT0FBTyxFQUFFO3dCQUNMLFlBQVksRUFBRSwyRkFBMkY7cUJBQzVHO29CQUNELE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtpQkFDNUIsQ0FBQyxDQUFDO2dCQUVILFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztnQkFFeEIsSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRTtvQkFDekIsTUFBTSxTQUFTLEdBQWM7d0JBQ3pCLEdBQUc7d0JBQ0gsTUFBTSxFQUFFLEdBQUc7d0JBQ1gsWUFBWSxFQUFFLHNCQUFzQjt3QkFDcEMsU0FBUyxFQUFFLEtBQUs7cUJBQ25CLENBQUM7b0JBQ0YsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztpQkFDOUI7cUJBQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxLQUFLLEdBQUcsRUFBRTtvQkFDaEMsTUFBTSxTQUFTLEdBQWM7d0JBQ3pCLEdBQUc7d0JBQ0gsTUFBTSxFQUFFLEdBQUc7d0JBQ1gsWUFBWSxFQUFFLCtCQUErQjt3QkFDN0MsU0FBUyxFQUFFLGVBQWU7cUJBQzdCLENBQUM7b0JBQ0YsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztpQkFDOUI7cUJBQU0sSUFBSSxRQUFRLENBQUMsTUFBTSxJQUFJLEdBQUcsRUFBRTtvQkFDL0IsTUFBTSxTQUFTLEdBQWM7d0JBQ3pCLEdBQUc7d0JBQ0gsTUFBTSxFQUFFLFFBQVEsQ0FBQyxNQUFNO3dCQUN2QixZQUFZLEVBQUUsUUFBUSxRQUFRLENBQUMsTUFBTSxLQUFLLFFBQVEsQ0FBQyxVQUFVLEVBQUU7d0JBQy9ELFNBQVMsRUFBRSxPQUFPO3FCQUNyQixDQUFDO29CQUNGLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7aUJBQzlCO2dCQUNELGtFQUFrRTthQUVyRTtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLElBQUksS0FBSyxZQUFZLEtBQUssSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFlBQVksRUFBRTtvQkFDdkQsTUFBTSxTQUFTLEdBQWM7d0JBQ3pCLEdBQUc7d0JBQ0gsTUFBTSxFQUFFLFNBQVM7d0JBQ2pCLFlBQVksRUFBRSw4QkFBOEI7d0JBQzVDLFNBQVMsRUFBRSxTQUFTO3FCQUN2QixDQUFDO29CQUNGLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7aUJBQzlCO3FCQUFNO29CQUNILE1BQU0sU0FBUyxHQUFjO3dCQUN6QixHQUFHO3dCQUNILE1BQU0sRUFBRSxPQUFPO3dCQUNmLFlBQVksRUFBRSxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxlQUFlO3dCQUN0RSxTQUFTLEVBQUUsT0FBTztxQkFDckIsQ0FBQztvQkFDRixVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUM5QjthQUNKO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFNUIsY0FBYyxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFFL0IsOEJBQThCO1FBQzlCLE1BQU0sa0JBQWtCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLGNBQWMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7UUFDbEYsTUFBTSxRQUFRLENBQUMsUUFBUSxDQUNuQiwwQkFBMEIsY0FBYyxJQUFJLFVBQVUsQ0FBQyxNQUFNLGtCQUFrQixrQkFBa0IsSUFBSSxFQUNyRyxzQkFBc0IsRUFDdEIsRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUFFLFVBQVUsQ0FBQyxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsQ0FDdkUsQ0FBQztLQUNMO0lBRUQsZ0JBQWdCO0lBQ2hCLE1BQU0sV0FBVyxHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxLQUFLLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNqRixNQUFNLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsU0FBUyxLQUFLLGVBQWUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNqRyxNQUFNLFlBQVksR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFNBQVMsS0FBSyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUM7SUFDdEYsTUFBTSxVQUFVLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ2xGLE1BQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQyxNQUFNLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQztJQUUzRCxJQUFJLGNBQWMsR0FBRywwQkFBMEIsWUFBWSxVQUFVLENBQUM7SUFDdEUsSUFBSSxXQUFXLEdBQUcsQ0FBQztRQUFFLGNBQWMsSUFBSSxLQUFLLFdBQVcsZUFBZSxDQUFDO0lBQ3ZFLElBQUksaUJBQWlCLEdBQUcsQ0FBQztRQUFFLGNBQWMsSUFBSSxLQUFLLGlCQUFpQixzQkFBc0IsQ0FBQztJQUMxRixJQUFJLFlBQVksR0FBRyxDQUFDO1FBQUUsY0FBYyxJQUFJLEtBQUssWUFBWSxVQUFVLENBQUM7SUFDcEUsSUFBSSxVQUFVLEdBQUcsQ0FBQztRQUFFLGNBQWMsSUFBSSxLQUFLLFVBQVUsZUFBZSxDQUFDO0lBRXJFLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUVwQyxPQUFPLEVBQUUsVUFBVSxFQUFFLENBQUM7QUFDMUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kLCBQdXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IFByb2dyZXNzUHVibGlzaGVyIH0gZnJvbSAnLi9wcm9ncmVzcy1wdWJsaXNoZXInO1xuXG5pbnRlcmZhY2UgU2l0ZW1hcEhlYWx0aENoZWNrZXJFdmVudCB7XG4gICAgc2Vzc2lvbklkOiBzdHJpbmc7XG4gICAgc2l0ZW1hcFBhcnNlclJlc3VsdDoge1xuICAgICAgICBQYXlsb2FkOiB7XG4gICAgICAgICAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgICAgICAgICAgdG90YWxVcmxzOiBudW1iZXI7XG4gICAgICAgICAgICBzaXRlbWFwVXJsczogc3RyaW5nW107XG4gICAgICAgICAgICBzM0xvY2F0aW9uOiBzdHJpbmc7XG4gICAgICAgIH07XG4gICAgfTtcbn1cblxuaW50ZXJmYWNlIFNpdGVtYXBIZWFsdGhDaGVja2VyUmVzcG9uc2Uge1xuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgc2Vzc2lvbklkOiBzdHJpbmc7XG4gICAgdG90YWxVcmxzOiBudW1iZXI7XG4gICAgaGVhbHRoeVVybHM6IG51bWJlcjtcbiAgICBicm9rZW5VcmxzOiBudW1iZXI7XG4gICAgYWNjZXNzRGVuaWVkVXJsczogbnVtYmVyO1xuICAgIHRpbWVvdXRVcmxzOiBudW1iZXI7XG4gICAgb3RoZXJFcnJvclVybHM6IG51bWJlcjtcbiAgICBoZWFsdGhTdW1tYXJ5OiBTaXRlbWFwSGVhbHRoU3VtbWFyeTtcbiAgICBzM0xvY2F0aW9uOiBzdHJpbmc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIHByb2Nlc3NpbmdUaW1lOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBMaW5rSXNzdWUge1xuICAgIHVybDogc3RyaW5nO1xuICAgIHN0YXR1czogbnVtYmVyIHwgc3RyaW5nO1xuICAgIGVycm9yTWVzc2FnZTogc3RyaW5nO1xuICAgIGlzc3VlVHlwZTogJzQwNCcgfCAnYWNjZXNzLWRlbmllZCcgfCAndGltZW91dCcgfCAnZXJyb3InO1xufVxuXG5pbnRlcmZhY2UgU2l0ZW1hcEhlYWx0aFN1bW1hcnkge1xuICAgIHRvdGFsVXJsczogbnVtYmVyO1xuICAgIGhlYWx0aHlVcmxzOiBudW1iZXI7XG4gICAgbGlua0lzc3VlczogTGlua0lzc3VlW107XG4gICAgaGVhbHRoUGVyY2VudGFnZTogbnVtYmVyO1xuICAgIHByb2Nlc3NpbmdUaW1lOiBudW1iZXI7XG4gICAgdGltZXN0YW1wOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBIYW5kbGVyPFNpdGVtYXBIZWFsdGhDaGVja2VyRXZlbnQsIFNpdGVtYXBIZWFsdGhDaGVja2VyUmVzcG9uc2U+ID0gYXN5bmMgKGV2ZW50KSA9PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBjb25zb2xlLmxvZygnU3RhcnRpbmcgc2l0ZW1hcCBoZWFsdGggY2hlY2sgZm9yIHNlc3Npb246JywgZXZlbnQuc2Vzc2lvbklkKTtcblxuICAgIC8vIEluaXRpYWxpemUgcHJvZ3Jlc3MgcHVibGlzaGVyIGFuZCBTMyBjbGllbnRcbiAgICBjb25zdCBwcm9ncmVzcyA9IG5ldyBQcm9ncmVzc1B1Ymxpc2hlcihldmVudC5zZXNzaW9uSWQpO1xuICAgIGNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIH0pO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgc2l0ZW1hcCBwYXJzaW5nIHdhcyBzdWNjZXNzZnVsXG4gICAgICAgIGlmICghZXZlbnQuc2l0ZW1hcFBhcnNlclJlc3VsdC5QYXlsb2FkLnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2l0ZW1hcCBwYXJzaW5nIGZhaWxlZCwgY2Fubm90IHBlcmZvcm0gaGVhbHRoIGNoZWNrJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCB0b3RhbFVybHMgPSBldmVudC5zaXRlbWFwUGFyc2VyUmVzdWx0LlBheWxvYWQudG90YWxVcmxzO1xuICAgICAgICBjb25zdCBzaXRlbWFwVXJscyA9IGV2ZW50LnNpdGVtYXBQYXJzZXJSZXN1bHQuUGF5bG9hZC5zaXRlbWFwVXJscztcblxuICAgICAgICBpZiAodG90YWxVcmxzID09PSAwKSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9ncmVzcy5pbmZvKCdObyBVUkxzIGZvdW5kIGluIHNpdGVtYXAsIHNraXBwaW5nIGhlYWx0aCBjaGVjaycpO1xuXG4gICAgICAgICAgICBjb25zdCBlbXB0eUhlYWx0aFN1bW1hcnk6IFNpdGVtYXBIZWFsdGhTdW1tYXJ5ID0ge1xuICAgICAgICAgICAgICAgIHRvdGFsVXJsczogMCxcbiAgICAgICAgICAgICAgICBoZWFsdGh5VXJsczogMCxcbiAgICAgICAgICAgICAgICBsaW5rSXNzdWVzOiBbXSxcbiAgICAgICAgICAgICAgICBoZWFsdGhQZXJjZW50YWdlOiAxMDAsXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgICAgICBzZXNzaW9uSWQ6IGV2ZW50LnNlc3Npb25JZCxcbiAgICAgICAgICAgICAgICB0b3RhbFVybHM6IDAsXG4gICAgICAgICAgICAgICAgaGVhbHRoeVVybHM6IDAsXG4gICAgICAgICAgICAgICAgYnJva2VuVXJsczogMCxcbiAgICAgICAgICAgICAgICBhY2Nlc3NEZW5pZWRVcmxzOiAwLFxuICAgICAgICAgICAgICAgIHRpbWVvdXRVcmxzOiAwLFxuICAgICAgICAgICAgICAgIG90aGVyRXJyb3JVcmxzOiAwLFxuICAgICAgICAgICAgICAgIGhlYWx0aFN1bW1hcnk6IGVtcHR5SGVhbHRoU3VtbWFyeSxcbiAgICAgICAgICAgICAgICBzM0xvY2F0aW9uOiAnJyxcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiAnTm8gVVJMcyB0byBjaGVjaycsXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgICAgICAgIH07XG4gICAgICAgIH1cblxuICAgICAgICBhd2FpdCBwcm9ncmVzcy5wcm9ncmVzcyhgU3RhcnRpbmcgYnVsayBoZWFsdGggY2hlY2sgZm9yICR7dG90YWxVcmxzfSBVUkxzIGZyb20gc2l0ZW1hcGAsICdzaXRlbWFwLWhlYWx0aC1jaGVjaycpO1xuXG4gICAgICAgIC8vIFBlcmZvcm0gYnVsayBsaW5rIHZhbGlkYXRpb25cbiAgICAgICAgY29uc3QgaGVhbHRoQ2hlY2tSZXN1bHQgPSBhd2FpdCBwZXJmb3JtQnVsa0xpbmtWYWxpZGF0aW9uKHNpdGVtYXBVcmxzLCBwcm9ncmVzcyk7XG5cbiAgICAgICAgLy8gQ2FsY3VsYXRlIGhlYWx0aCBzdGF0aXN0aWNzXG4gICAgICAgIGNvbnN0IGJyb2tlblVybHMgPSBoZWFsdGhDaGVja1Jlc3VsdC5saW5rSXNzdWVzLmZpbHRlcihpc3N1ZSA9PiBpc3N1ZS5pc3N1ZVR5cGUgPT09ICc0MDQnKS5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGFjY2Vzc0RlbmllZFVybHMgPSBoZWFsdGhDaGVja1Jlc3VsdC5saW5rSXNzdWVzLmZpbHRlcihpc3N1ZSA9PiBpc3N1ZS5pc3N1ZVR5cGUgPT09ICdhY2Nlc3MtZGVuaWVkJykubGVuZ3RoO1xuICAgICAgICBjb25zdCB0aW1lb3V0VXJscyA9IGhlYWx0aENoZWNrUmVzdWx0LmxpbmtJc3N1ZXMuZmlsdGVyKGlzc3VlID0+IGlzc3VlLmlzc3VlVHlwZSA9PT0gJ3RpbWVvdXQnKS5sZW5ndGg7XG4gICAgICAgIGNvbnN0IG90aGVyRXJyb3JVcmxzID0gaGVhbHRoQ2hlY2tSZXN1bHQubGlua0lzc3Vlcy5maWx0ZXIoaXNzdWUgPT4gaXNzdWUuaXNzdWVUeXBlID09PSAnZXJyb3InKS5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGhlYWx0aHlVcmxzID0gdG90YWxVcmxzIC0gaGVhbHRoQ2hlY2tSZXN1bHQubGlua0lzc3Vlcy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGhlYWx0aFBlcmNlbnRhZ2UgPSBNYXRoLnJvdW5kKChoZWFsdGh5VXJscyAvIHRvdGFsVXJscykgKiAxMDApO1xuXG4gICAgICAgIC8vIENyZWF0ZSBoZWFsdGggc3VtbWFyeVxuICAgICAgICBjb25zdCBoZWFsdGhTdW1tYXJ5OiBTaXRlbWFwSGVhbHRoU3VtbWFyeSA9IHtcbiAgICAgICAgICAgIHRvdGFsVXJscyxcbiAgICAgICAgICAgIGhlYWx0aHlVcmxzLFxuICAgICAgICAgICAgbGlua0lzc3VlczogaGVhbHRoQ2hlY2tSZXN1bHQubGlua0lzc3VlcyxcbiAgICAgICAgICAgIGhlYWx0aFBlcmNlbnRhZ2UsXG4gICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gU3RvcmUgcmVzdWx0cyBpbiBTM1xuICAgICAgICBjb25zdCBzM0tleSA9IGBzZXNzaW9ucy8ke2V2ZW50LnNlc3Npb25JZH0vc2l0ZW1hcC1oZWFsdGgtcmVzdWx0cy5qc29uYDtcbiAgICAgICAgY29uc3QgczNMb2NhdGlvbiA9IGBzMzovLyR7cHJvY2Vzcy5lbnYuQU5BTFlTSVNfQlVDS0VUfS8ke3MzS2V5fWA7XG5cbiAgICAgICAgYXdhaXQgczNDbGllbnQuc2VuZChuZXcgUHV0T2JqZWN0Q29tbWFuZCh7XG4gICAgICAgICAgICBCdWNrZXQ6IHByb2Nlc3MuZW52LkFOQUxZU0lTX0JVQ0tFVCxcbiAgICAgICAgICAgIEtleTogczNLZXksXG4gICAgICAgICAgICBCb2R5OiBKU09OLnN0cmluZ2lmeShoZWFsdGhTdW1tYXJ5LCBudWxsLCAyKSxcbiAgICAgICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIC8vIFNlbmQgY29tcGxldGlvbiBtZXNzYWdlXG4gICAgICAgIGF3YWl0IHByb2dyZXNzLnN1Y2Nlc3MoXG4gICAgICAgICAgICBgU2l0ZW1hcCBoZWFsdGggY2hlY2sgY29tcGxldGU6ICR7aGVhbHRoeVVybHN9LyR7dG90YWxVcmxzfSBVUkxzIGhlYWx0aHkgKCR7aGVhbHRoUGVyY2VudGFnZX0lKWAsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdG90YWxVcmxzLFxuICAgICAgICAgICAgICAgIGhlYWx0aHlVcmxzLFxuICAgICAgICAgICAgICAgIGJyb2tlblVybHMsXG4gICAgICAgICAgICAgICAgaGVhbHRoUGVyY2VudGFnZSxcbiAgICAgICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGBTaXRlbWFwIGhlYWx0aCBjaGVjayBjb21wbGV0ZWQ6ICR7aGVhbHRoeVVybHN9LyR7dG90YWxVcmxzfSBVUkxzIGhlYWx0aHlgKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIHNlc3Npb25JZDogZXZlbnQuc2Vzc2lvbklkLFxuICAgICAgICAgICAgdG90YWxVcmxzLFxuICAgICAgICAgICAgaGVhbHRoeVVybHMsXG4gICAgICAgICAgICBicm9rZW5VcmxzLFxuICAgICAgICAgICAgYWNjZXNzRGVuaWVkVXJscyxcbiAgICAgICAgICAgIHRpbWVvdXRVcmxzLFxuICAgICAgICAgICAgb3RoZXJFcnJvclVybHMsXG4gICAgICAgICAgICBoZWFsdGhTdW1tYXJ5LFxuICAgICAgICAgICAgczNMb2NhdGlvbixcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBIZWFsdGggY2hlY2sgY29tcGxldGU6ICR7aGVhbHRoeVVybHN9LyR7dG90YWxVcmxzfSBVUkxzIGhlYWx0aHkgKCR7aGVhbHRoUGVyY2VudGFnZX0lKWAsXG4gICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignU2l0ZW1hcCBoZWFsdGggY2hlY2sgZmFpbGVkOicsIGVycm9yKTtcblxuICAgICAgICBhd2FpdCBwcm9ncmVzcy5lcnJvcihgU2l0ZW1hcCBoZWFsdGggY2hlY2sgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgIHNlc3Npb25JZDogZXZlbnQuc2Vzc2lvbklkLFxuICAgICAgICAgICAgdG90YWxVcmxzOiAwLFxuICAgICAgICAgICAgaGVhbHRoeVVybHM6IDAsXG4gICAgICAgICAgICBicm9rZW5VcmxzOiAwLFxuICAgICAgICAgICAgYWNjZXNzRGVuaWVkVXJsczogMCxcbiAgICAgICAgICAgIHRpbWVvdXRVcmxzOiAwLFxuICAgICAgICAgICAgb3RoZXJFcnJvclVybHM6IDAsXG4gICAgICAgICAgICBoZWFsdGhTdW1tYXJ5OiB7XG4gICAgICAgICAgICAgICAgdG90YWxVcmxzOiAwLFxuICAgICAgICAgICAgICAgIGhlYWx0aHlVcmxzOiAwLFxuICAgICAgICAgICAgICAgIGxpbmtJc3N1ZXM6IFtdLFxuICAgICAgICAgICAgICAgIGhlYWx0aFBlcmNlbnRhZ2U6IDAsXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzM0xvY2F0aW9uOiAnJyxcbiAgICAgICAgICAgIG1lc3NhZ2U6IGBIZWFsdGggY2hlY2sgZmFpbGVkOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWAsXG4gICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgICB9O1xuICAgIH1cbn07XG5cbi8qKlxuICogUGVyZm9ybSBidWxrIGxpbmsgdmFsaWRhdGlvbiBmb3Igc2l0ZW1hcCBVUkxzXG4gKiBSZXF1aXJlbWVudHM6IDMwLjEsIDMwLjIsIDMwLjMsIDMwLjgsIDMwLjksIDMwLjEwXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHBlcmZvcm1CdWxrTGlua1ZhbGlkYXRpb24oXG4gICAgdXJsczogc3RyaW5nW10sXG4gICAgcHJvZ3Jlc3M6IFByb2dyZXNzUHVibGlzaGVyXG4pOiBQcm9taXNlPHsgbGlua0lzc3VlczogTGlua0lzc3VlW10gfT4ge1xuXG4gICAgaWYgKHVybHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiB7IGxpbmtJc3N1ZXM6IFtdIH07XG4gICAgfVxuXG4gICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXNcbiAgICBjb25zdCB1bmlxdWVVcmxzID0gWy4uLm5ldyBTZXQodXJscyldO1xuXG4gICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoYENoZWNraW5nICR7dW5pcXVlVXJscy5sZW5ndGh9IHVuaXF1ZSBVUkxzIGZvciBhY2Nlc3NpYmlsaXR5YCwgJ3NpdGVtYXAtaGVhbHRoLWNoZWNrJyk7XG5cbiAgICBjb25zdCBsaW5rSXNzdWVzOiBMaW5rSXNzdWVbXSA9IFtdO1xuICAgIGNvbnN0IG1heENvbmN1cnJlbnQgPSAxMDsgLy8gTGltaXQgY29uY3VycmVudCByZXF1ZXN0cyB0byBhdm9pZCBvdmVyd2hlbG1pbmcgc2VydmVyc1xuICAgIGNvbnN0IHRpbWVvdXQgPSA4MDAwOyAvLyA4IHNlY29uZCB0aW1lb3V0IChsb25nZXIgdGhhbiBzaW5nbGUgcGFnZSB2YWxpZGF0aW9uKVxuXG4gICAgbGV0IHByb2Nlc3NlZENvdW50ID0gMDtcblxuICAgIC8vIFByb2Nlc3MgVVJMcyBpbiBiYXRjaGVzIHRvIGNvbnRyb2wgY29uY3VycmVuY3lcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVuaXF1ZVVybHMubGVuZ3RoOyBpICs9IG1heENvbmN1cnJlbnQpIHtcbiAgICAgICAgY29uc3QgYmF0Y2ggPSB1bmlxdWVVcmxzLnNsaWNlKGksIGkgKyBtYXhDb25jdXJyZW50KTtcblxuICAgICAgICBjb25zdCBwcm9taXNlcyA9IGJhdGNoLm1hcChhc3luYyAodXJsKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgICAgICAgICAgICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIHRpbWVvdXQpO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHtcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ1VzZXItQWdlbnQnOiAnTW96aWxsYS81LjAgKGNvbXBhdGlibGU7IExlbnN5IERvY3VtZW50YXRpb24gUXVhbGl0eSBBdWRpdG9yLzEuMDsgK2h0dHBzOi8vbGVuc3kuZGV2L2JvdCknXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIHNpZ25hbDogY29udHJvbGxlci5zaWduYWxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cyA9PT0gNDA0KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGxpbmtJc3N1ZTogTGlua0lzc3VlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiA0MDQsXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2U6ICdQYWdlIG5vdCBmb3VuZCAoNDA0KScsXG4gICAgICAgICAgICAgICAgICAgICAgICBpc3N1ZVR5cGU6ICc0MDQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGxpbmtJc3N1ZXMucHVzaChsaW5rSXNzdWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzID09PSA0MDMpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua0lzc3VlOiBMaW5rSXNzdWUgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IDQwMyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZTogJ0FjY2VzcyBkZW5pZWQgKDQwMyBGb3JiaWRkZW4pJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzc3VlVHlwZTogJ2FjY2Vzcy1kZW5pZWQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGxpbmtJc3N1ZXMucHVzaChsaW5rSXNzdWUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uuc3RhdHVzID49IDQwMCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBsaW5rSXNzdWU6IExpbmtJc3N1ZSA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHVybCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1czogcmVzcG9uc2Uuc3RhdHVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JNZXNzYWdlOiBgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNzdWVUeXBlOiAnZXJyb3InXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGxpbmtJc3N1ZXMucHVzaChsaW5rSXNzdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyAyeHggYW5kIDN4eCByZXNwb25zZXMgYXJlIGNvbnNpZGVyZWQgaGVhbHRoeSAobm8gYWN0aW9uIG5lZWRlZClcblxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvciAmJiBlcnJvci5uYW1lID09PSAnQWJvcnRFcnJvcicpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua0lzc3VlOiBMaW5rSXNzdWUgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICd0aW1lb3V0JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yTWVzc2FnZTogJ1JlcXVlc3QgdGltZW91dCAoPjggc2Vjb25kcyknLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNzdWVUeXBlOiAndGltZW91dCdcbiAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgbGlua0lzc3Vlcy5wdXNoKGxpbmtJc3N1ZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGlua0lzc3VlOiBMaW5rSXNzdWUgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXM6ICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnJvck1lc3NhZ2U6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgICAgICAgICAgICAgICAgICAgaXNzdWVUeXBlOiAnZXJyb3InXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGxpbmtJc3N1ZXMucHVzaChsaW5rSXNzdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuXG4gICAgICAgIHByb2Nlc3NlZENvdW50ICs9IGJhdGNoLmxlbmd0aDtcblxuICAgICAgICAvLyBQcm9ncmVzcyB1cGRhdGUgZXZlcnkgYmF0Y2hcbiAgICAgICAgY29uc3QgcHJvZ3Jlc3NQZXJjZW50YWdlID0gTWF0aC5yb3VuZCgocHJvY2Vzc2VkQ291bnQgLyB1bmlxdWVVcmxzLmxlbmd0aCkgKiAxMDApO1xuICAgICAgICBhd2FpdCBwcm9ncmVzcy5wcm9ncmVzcyhcbiAgICAgICAgICAgIGBIZWFsdGggY2hlY2sgcHJvZ3Jlc3M6ICR7cHJvY2Vzc2VkQ291bnR9LyR7dW5pcXVlVXJscy5sZW5ndGh9IFVSTHMgY2hlY2tlZCAoJHtwcm9ncmVzc1BlcmNlbnRhZ2V9JSlgLFxuICAgICAgICAgICAgJ3NpdGVtYXAtaGVhbHRoLWNoZWNrJyxcbiAgICAgICAgICAgIHsgcHJvY2Vzc2VkQ291bnQsIHRvdGFsVXJsczogdW5pcXVlVXJscy5sZW5ndGgsIHByb2dyZXNzUGVyY2VudGFnZSB9XG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gRmluYWwgc3VtbWFyeVxuICAgIGNvbnN0IGJyb2tlbkNvdW50ID0gbGlua0lzc3Vlcy5maWx0ZXIoaXNzdWUgPT4gaXNzdWUuaXNzdWVUeXBlID09PSAnNDA0JykubGVuZ3RoO1xuICAgIGNvbnN0IGFjY2Vzc0RlbmllZENvdW50ID0gbGlua0lzc3Vlcy5maWx0ZXIoaXNzdWUgPT4gaXNzdWUuaXNzdWVUeXBlID09PSAnYWNjZXNzLWRlbmllZCcpLmxlbmd0aDtcbiAgICBjb25zdCB0aW1lb3V0Q291bnQgPSBsaW5rSXNzdWVzLmZpbHRlcihpc3N1ZSA9PiBpc3N1ZS5pc3N1ZVR5cGUgPT09ICd0aW1lb3V0JykubGVuZ3RoO1xuICAgIGNvbnN0IGVycm9yQ291bnQgPSBsaW5rSXNzdWVzLmZpbHRlcihpc3N1ZSA9PiBpc3N1ZS5pc3N1ZVR5cGUgPT09ICdlcnJvcicpLmxlbmd0aDtcbiAgICBjb25zdCBoZWFsdGh5Q291bnQgPSB1bmlxdWVVcmxzLmxlbmd0aCAtIGxpbmtJc3N1ZXMubGVuZ3RoO1xuXG4gICAgbGV0IHN1bW1hcnlNZXNzYWdlID0gYEhlYWx0aCBjaGVjayBjb21wbGV0ZTogJHtoZWFsdGh5Q291bnR9IGhlYWx0aHlgO1xuICAgIGlmIChicm9rZW5Db3VudCA+IDApIHN1bW1hcnlNZXNzYWdlICs9IGAsICR7YnJva2VuQ291bnR9IGJyb2tlbiAoNDA0KWA7XG4gICAgaWYgKGFjY2Vzc0RlbmllZENvdW50ID4gMCkgc3VtbWFyeU1lc3NhZ2UgKz0gYCwgJHthY2Nlc3NEZW5pZWRDb3VudH0gYWNjZXNzIGRlbmllZCAoNDAzKWA7XG4gICAgaWYgKHRpbWVvdXRDb3VudCA+IDApIHN1bW1hcnlNZXNzYWdlICs9IGAsICR7dGltZW91dENvdW50fSB0aW1lb3V0YDtcbiAgICBpZiAoZXJyb3JDb3VudCA+IDApIHN1bW1hcnlNZXNzYWdlICs9IGAsICR7ZXJyb3JDb3VudH0gb3RoZXIgZXJyb3JzYDtcblxuICAgIGF3YWl0IHByb2dyZXNzLmluZm8oc3VtbWFyeU1lc3NhZ2UpO1xuXG4gICAgcmV0dXJuIHsgbGlua0lzc3VlcyB9O1xufSJdfQ==