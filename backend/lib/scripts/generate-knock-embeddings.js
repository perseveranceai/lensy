"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const client_s3_1 = require("@aws-sdk/client-s3");
const client_bedrock_runtime_1 = require("@aws-sdk/client-bedrock-runtime");
const https_1 = __importDefault(require("https"));
const s3Client = new client_s3_1.S3Client({ region: 'us-east-1' });
const bedrockClient = new client_bedrock_runtime_1.BedrockRuntimeClient({ region: 'us-east-1' });
/**
 * Make HTTPS request
 */
function makeHttpRequest(url) {
    return new Promise((resolve, reject) => {
        https_1.default.get(url, (res) => {
            let data = '';
            res.on('data', (chunk) => data += chunk);
            res.on('end', () => resolve(data));
        }).on('error', reject);
    });
}
/**
 * Generate embedding for text using Amazon Bedrock Titan
 */
async function generateEmbedding(text) {
    try {
        const input = {
            modelId: 'amazon.titan-embed-text-v1',
            contentType: 'application/json',
            accept: 'application/json',
            body: JSON.stringify({
                inputText: text
            })
        };
        const command = new client_bedrock_runtime_1.InvokeModelCommand(input);
        const response = await bedrockClient.send(command);
        const responseBody = JSON.parse(new TextDecoder().decode(response.body));
        return responseBody.embedding;
    }
    catch (error) {
        console.error('Error generating embedding:', error);
        throw error;
    }
}
/**
 * Extract page content from HTML
 */
function extractPageContent(html) {
    // Extract title
    const titleMatch = html.match(/<title[^>]*>(.*?)<\/title>/i);
    const title = titleMatch ? titleMatch[1].trim() : '';
    // Extract meta description
    const descMatch = html.match(/<meta[^>]*name=["']description["'][^>]*content=["']([^"']*?)["'][^>]*>/i);
    const description = descMatch ? descMatch[1].trim() : '';
    // Extract main content (remove scripts, styles, nav, footer)
    let content = html
        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
        .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
        .replace(/<nav[^>]*>[\s\S]*?<\/nav>/gi, '')
        .replace(/<footer[^>]*>[\s\S]*?<\/footer>/gi, '')
        .replace(/<header[^>]*>[\s\S]*?<\/header>/gi, '')
        .replace(/<aside[^>]*>[\s\S]*?<\/aside>/gi, '')
        .replace(/<[^>]+>/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    // Limit content length for embedding
    if (content.length > 8000) {
        content = content.substring(0, 8000) + '...';
    }
    return { title, description, content };
}
/**
 * Fetch sitemap and extract URLs
 */
async function fetchSitemap() {
    const sitemapUrl = 'https://docs.knock.app/sitemap.xml';
    console.log(`Fetching sitemap from: ${sitemapUrl}`);
    const xml = await makeHttpRequest(sitemapUrl);
    const urlMatches = xml.match(/<loc>(.*?)<\/loc>/g) || [];
    const urls = urlMatches.map(match => {
        const url = match.replace(/<\/?loc>/g, '');
        return url;
    });
    console.log(`Found ${urls.length} URLs in sitemap`);
    return urls;
}
/**
 * Fetch page content
 */
async function fetchPageContent(url) {
    try {
        return await makeHttpRequest(url);
    }
    catch (error) {
        console.error(`Failed to fetch ${url}:`, error);
        return null;
    }
}
/**
 * Main function to generate embeddings
 */
async function main() {
    console.log('üöÄ Starting Knock.app documentation embedding generation...\n');
    const startTime = Date.now();
    const urls = await fetchSitemap();
    const embeddings = [];
    console.log(`\nüìÑ Processing ${urls.length} pages...\n`);
    for (let i = 0; i < urls.length; i++) {
        const url = urls[i];
        const progress = `[${i + 1}/${urls.length}]`;
        try {
            const html = await fetchPageContent(url);
            if (!html) {
                console.log(`${progress} ‚è≠Ô∏è  Skipped: ${url} (fetch failed)`);
                continue;
            }
            const { title, description, content } = extractPageContent(html);
            // Combine title, description, and content for embedding
            const textForEmbedding = `${title} ${description} ${content}`.trim();
            if (textForEmbedding.length < 10) {
                console.log(`${progress} ‚è≠Ô∏è  Skipped: ${url} (minimal content)`);
                continue;
            }
            const embedding = await generateEmbedding(textForEmbedding);
            // Extract pathname for storage
            const urlObj = new URL(url);
            const pathname = urlObj.pathname;
            embeddings.push({
                url: pathname,
                title,
                description,
                content,
                embedding
            });
            console.log(`${progress} ‚úÖ Generated: ${pathname} (${title.substring(0, 50)}...)`);
            // Add small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        catch (error) {
            console.error(`${progress} ‚ùå Failed: ${url}`, error);
        }
    }
    console.log(`\nüìä Generated ${embeddings.length} embeddings\n`);
    // Store embeddings in S3
    const bucketName = 'lensy-analysis-951411676525-us-east-1';
    const embeddingsKey = 'rich-content-embeddings-docs-knock-app.json';
    try {
        const putCommand = new client_s3_1.PutObjectCommand({
            Bucket: bucketName,
            Key: embeddingsKey,
            Body: JSON.stringify(embeddings, null, 2),
            ContentType: 'application/json'
        });
        await s3Client.send(putCommand);
        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(2);
        console.log(`‚úÖ Stored embeddings in S3: s3://${bucketName}/${embeddingsKey}`);
        console.log(`‚è±Ô∏è  Total time: ${elapsedTime}s`);
        console.log(`üì¶ File size: ${(JSON.stringify(embeddings).length / 1024 / 1024).toFixed(2)} MB`);
    }
    catch (error) {
        console.error('‚ùå Failed to store embeddings in S3:', error);
        throw error;
    }
}
main().catch(console.error);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUta25vY2stZW1iZWRkaW5ncy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NjcmlwdHMvZ2VuZXJhdGUta25vY2stZW1iZWRkaW5ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGtEQUFnRTtBQUNoRSw0RUFBMkY7QUFDM0Ysa0RBQTBCO0FBRTFCLE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZELE1BQU0sYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQztBQVV4RTs7R0FFRztBQUNILFNBQVMsZUFBZSxDQUFDLEdBQVc7SUFDaEMsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNuQyxlQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFO1lBQ25CLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUNkLEdBQUcsQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLENBQUM7WUFDekMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztJQUMzQixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRDs7R0FFRztBQUNILEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxJQUFZO0lBQ3pDLElBQUk7UUFDQSxNQUFNLEtBQUssR0FBRztZQUNWLE9BQU8sRUFBRSw0QkFBNEI7WUFDckMsV0FBVyxFQUFFLGtCQUFrQjtZQUMvQixNQUFNLEVB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QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUzNDbGllbnQsIFB1dE9iamVjdENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtczMnO1xuaW1wb3J0IHsgQmVkcm9ja1J1bnRpbWVDbGllbnQsIEludm9rZU1vZGVsQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1iZWRyb2NrLXJ1bnRpbWUnO1xuaW1wb3J0IGh0dHBzIGZyb20gJ2h0dHBzJztcblxuY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246ICd1cy1lYXN0LTEnIH0pO1xuY29uc3QgYmVkcm9ja0NsaWVudCA9IG5ldyBCZWRyb2NrUnVudGltZUNsaWVudCh7IHJlZ2lvbjogJ3VzLWVhc3QtMScgfSk7XG5cbmludGVyZmFjZSBSaWNoQ29udGVudEVtYmVkZGluZyB7XG4gICAgdXJsOiBzdHJpbmc7XG4gICAgdGl0bGU6IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgIGNvbnRlbnQ6IHN0cmluZztcbiAgICBlbWJlZGRpbmc6IG51bWJlcltdO1xufVxuXG4vKipcbiAqIE1ha2UgSFRUUFMgcmVxdWVzdFxuICovXG5mdW5jdGlvbiBtYWtlSHR0cFJlcXVlc3QodXJsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIGh0dHBzLmdldCh1cmwsIChyZXMpID0+IHtcbiAgICAgICAgICAgIGxldCBkYXRhID0gJyc7XG4gICAgICAgICAgICByZXMub24oJ2RhdGEnLCAoY2h1bmspID0+IGRhdGEgKz0gY2h1bmspO1xuICAgICAgICAgICAgcmVzLm9uKCdlbmQnLCAoKSA9PiByZXNvbHZlKGRhdGEpKTtcbiAgICAgICAgfSkub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICB9KTtcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBlbWJlZGRpbmcgZm9yIHRleHQgdXNpbmcgQW1hem9uIEJlZHJvY2sgVGl0YW5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVFbWJlZGRpbmcodGV4dDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXJbXT4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGlucHV0ID0ge1xuICAgICAgICAgICAgbW9kZWxJZDogJ2FtYXpvbi50aXRhbi1lbWJlZC10ZXh0LXYxJyxcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICBhY2NlcHQ6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICBpbnB1dFRleHQ6IHRleHRcbiAgICAgICAgICAgIH0pXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgY29tbWFuZCA9IG5ldyBJbnZva2VNb2RlbENvbW1hbmQoaW5wdXQpO1xuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGJlZHJvY2tDbGllbnQuc2VuZChjb21tYW5kKTtcblxuICAgICAgICBjb25zdCByZXNwb25zZUJvZHkgPSBKU09OLnBhcnNlKG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShyZXNwb25zZS5ib2R5KSk7XG4gICAgICAgIHJldHVybiByZXNwb25zZUJvZHkuZW1iZWRkaW5nO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGdlbmVyYXRpbmcgZW1iZWRkaW5nOicsIGVycm9yKTtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxufVxuXG4vKipcbiAqIEV4dHJhY3QgcGFnZSBjb250ZW50IGZyb20gSFRNTFxuICovXG5mdW5jdGlvbiBleHRyYWN0UGFnZUNvbnRlbnQoaHRtbDogc3RyaW5nKTogeyB0aXRsZTogc3RyaW5nOyBkZXNjcmlwdGlvbjogc3RyaW5nOyBjb250ZW50OiBzdHJpbmcgfSB7XG4gICAgLy8gRXh0cmFjdCB0aXRsZVxuICAgIGNvbnN0IHRpdGxlTWF0Y2ggPSBodG1sLm1hdGNoKC88dGl0bGVbXj5dKj4oLio/KTxcXC90aXRsZT4vaSk7XG4gICAgY29uc3QgdGl0bGUgPSB0aXRsZU1hdGNoID8gdGl0bGVNYXRjaFsxXS50cmltKCkgOiAnJztcblxuICAgIC8vIEV4dHJhY3QgbWV0YSBkZXNjcmlwdGlvblxuICAgIGNvbnN0IGRlc2NNYXRjaCA9IGh0bWwubWF0Y2goLzxtZXRhW14+XSpuYW1lPVtcIiddZGVzY3JpcHRpb25bXCInXVtePl0qY29udGVudD1bXCInXShbXlwiJ10qPylbXCInXVtePl0qPi9pKTtcbiAgICBjb25zdCBkZXNjcmlwdGlvbiA9IGRlc2NNYXRjaCA/IGRlc2NNYXRjaFsxXS50cmltKCkgOiAnJztcblxuICAgIC8vIEV4dHJhY3QgbWFpbiBjb250ZW50IChyZW1vdmUgc2NyaXB0cywgc3R5bGVzLCBuYXYsIGZvb3RlcilcbiAgICBsZXQgY29udGVudCA9IGh0bWxcbiAgICAgICAgLnJlcGxhY2UoLzxzY3JpcHRbXj5dKj5bXFxzXFxTXSo/PFxcL3NjcmlwdD4vZ2ksICcnKVxuICAgICAgICAucmVwbGFjZSgvPHN0eWxlW14+XSo+W1xcc1xcU10qPzxcXC9zdHlsZT4vZ2ksICcnKVxuICAgICAgICAucmVwbGFjZSgvPG5hdltePl0qPltcXHNcXFNdKj88XFwvbmF2Pi9naSwgJycpXG4gICAgICAgIC5yZXBsYWNlKC88Zm9vdGVyW14+XSo+W1xcc1xcU10qPzxcXC9mb290ZXI+L2dpLCAnJylcbiAgICAgICAgLnJlcGxhY2UoLzxoZWFkZXJbXj5dKj5bXFxzXFxTXSo/PFxcL2hlYWRlcj4vZ2ksICcnKVxuICAgICAgICAucmVwbGFjZSgvPGFzaWRlW14+XSo+W1xcc1xcU10qPzxcXC9hc2lkZT4vZ2ksICcnKVxuICAgICAgICAucmVwbGFjZSgvPFtePl0rPi9nLCAnICcpXG4gICAgICAgIC5yZXBsYWNlKC9cXHMrL2csICcgJylcbiAgICAgICAgLnRyaW0oKTtcblxuICAgIC8vIExpbWl0IGNvbnRlbnQgbGVuZ3RoIGZvciBlbWJlZGRpbmdcbiAgICBpZiAoY29udGVudC5sZW5ndGggPiA4MDAwKSB7XG4gICAgICAgIGNvbnRlbnQgPSBjb250ZW50LnN1YnN0cmluZygwLCA4MDAwKSArICcuLi4nO1xuICAgIH1cblxuICAgIHJldHVybiB7IHRpdGxlLCBkZXNjcmlwdGlvbiwgY29udGVudCB9O1xufVxuXG4vKipcbiAqIEZldGNoIHNpdGVtYXAgYW5kIGV4dHJhY3QgVVJMc1xuICovXG5hc3luYyBmdW5jdGlvbiBmZXRjaFNpdGVtYXAoKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHNpdGVtYXBVcmwgPSAnaHR0cHM6Ly9kb2NzLmtub2NrLmFwcC9zaXRlbWFwLnhtbCc7XG4gICAgY29uc29sZS5sb2coYEZldGNoaW5nIHNpdGVtYXAgZnJvbTogJHtzaXRlbWFwVXJsfWApO1xuXG4gICAgY29uc3QgeG1sID0gYXdhaXQgbWFrZUh0dHBSZXF1ZXN0KHNpdGVtYXBVcmwpO1xuICAgIGNvbnN0IHVybE1hdGNoZXMgPSB4bWwubWF0Y2goLzxsb2M+KC4qPyk8XFwvbG9jPi9nKSB8fCBbXTtcblxuICAgIGNvbnN0IHVybHMgPSB1cmxNYXRjaGVzLm1hcChtYXRjaCA9PiB7XG4gICAgICAgIGNvbnN0IHVybCA9IG1hdGNoLnJlcGxhY2UoLzxcXC8/bG9jPi9nLCAnJyk7XG4gICAgICAgIHJldHVybiB1cmw7XG4gICAgfSk7XG5cbiAgICBjb25zb2xlLmxvZyhgRm91bmQgJHt1cmxzLmxlbmd0aH0gVVJMcyBpbiBzaXRlbWFwYCk7XG4gICAgcmV0dXJuIHVybHM7XG59XG5cbi8qKlxuICogRmV0Y2ggcGFnZSBjb250ZW50XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGZldGNoUGFnZUNvbnRlbnQodXJsOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZyB8IG51bGw+IHtcbiAgICB0cnkge1xuICAgICAgICByZXR1cm4gYXdhaXQgbWFrZUh0dHBSZXF1ZXN0KHVybCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgRmFpbGVkIHRvIGZldGNoICR7dXJsfTpgLCBlcnJvcik7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbn1cblxuLyoqXG4gKiBNYWluIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIGVtYmVkZGluZ3NcbiAqL1xuYXN5bmMgZnVuY3Rpb24gbWFpbigpIHtcbiAgICBjb25zb2xlLmxvZygn8J+agCBTdGFydGluZyBLbm9jay5hcHAgZG9jdW1lbnRhdGlvbiBlbWJlZGRpbmcgZ2VuZXJhdGlvbi4uLlxcbicpO1xuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB1cmxzID0gYXdhaXQgZmV0Y2hTaXRlbWFwKCk7XG4gICAgY29uc3QgZW1iZWRkaW5nczogUmljaENvbnRlbnRFbWJlZGRpbmdbXSA9IFtdO1xuXG4gICAgY29uc29sZS5sb2coYFxcbvCfk4QgUHJvY2Vzc2luZyAke3VybHMubGVuZ3RofSBwYWdlcy4uLlxcbmApO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB1cmxzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHVybCA9IHVybHNbaV07XG4gICAgICAgIGNvbnN0IHByb2dyZXNzID0gYFske2kgKyAxfS8ke3VybHMubGVuZ3RofV1gO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBodG1sID0gYXdhaXQgZmV0Y2hQYWdlQ29udGVudCh1cmwpO1xuICAgICAgICAgICAgaWYgKCFodG1sKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYCR7cHJvZ3Jlc3N9IOKPre+4jyAgU2tpcHBlZDogJHt1cmx9IChmZXRjaCBmYWlsZWQpYCk7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHsgdGl0bGUsIGRlc2NyaXB0aW9uLCBjb250ZW50IH0gPSBleHRyYWN0UGFnZUNvbnRlbnQoaHRtbCk7XG5cbiAgICAgICAgICAgIC8vIENvbWJpbmUgdGl0bGUsIGRlc2NyaXB0aW9uLCBhbmQgY29udGVudCBmb3IgZW1iZWRkaW5nXG4gICAgICAgICAgICBjb25zdCB0ZXh0Rm9yRW1iZWRkaW5nID0gYCR7dGl0bGV9ICR7ZGVzY3JpcHRpb259ICR7Y29udGVudH1gLnRyaW0oKTtcblxuICAgICAgICAgICAgaWYgKHRleHRGb3JFbWJlZGRpbmcubGVuZ3RoIDwgMTApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtwcm9ncmVzc30g4o+t77iPICBTa2lwcGVkOiAke3VybH0gKG1pbmltYWwgY29udGVudClgKTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgZW1iZWRkaW5nID0gYXdhaXQgZ2VuZXJhdGVFbWJlZGRpbmcodGV4dEZvckVtYmVkZGluZyk7XG5cbiAgICAgICAgICAgIC8vIEV4dHJhY3QgcGF0aG5hbWUgZm9yIHN0b3JhZ2VcbiAgICAgICAgICAgIGNvbnN0IHVybE9iaiA9IG5ldyBVUkwodXJsKTtcbiAgICAgICAgICAgIGNvbnN0IHBhdGhuYW1lID0gdXJsT2JqLnBhdGhuYW1lO1xuXG4gICAgICAgICAgICBlbWJlZGRpbmdzLnB1c2goe1xuICAgICAgICAgICAgICAgIHVybDogcGF0aG5hbWUsXG4gICAgICAgICAgICAgICAgdGl0bGUsXG4gICAgICAgICAgICAgICAgZGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgY29udGVudCxcbiAgICAgICAgICAgICAgICBlbWJlZGRpbmdcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtwcm9ncmVzc30g4pyFIEdlbmVyYXRlZDogJHtwYXRobmFtZX0gKCR7dGl0bGUuc3Vic3RyaW5nKDAsIDUwKX0uLi4pYCk7XG5cbiAgICAgICAgICAgIC8vIEFkZCBzbWFsbCBkZWxheSB0byBhdm9pZCByYXRlIGxpbWl0aW5nXG4gICAgICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwKSk7XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYCR7cHJvZ3Jlc3N9IOKdjCBGYWlsZWQ6ICR7dXJsfWAsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBcXG7wn5OKIEdlbmVyYXRlZCAke2VtYmVkZGluZ3MubGVuZ3RofSBlbWJlZGRpbmdzXFxuYCk7XG5cbiAgICAvLyBTdG9yZSBlbWJlZGRpbmdzIGluIFMzXG4gICAgY29uc3QgYnVja2V0TmFtZSA9ICdsZW5zeS1hbmFseXNpcy05NTE0MTE2NzY1MjUtdXMtZWFzdC0xJztcbiAgICBjb25zdCBlbWJlZGRpbmdzS2V5ID0gJ3JpY2gtY29udGVudC1lbWJlZGRpbmdzLWRvY3Mta25vY2stYXBwLmpzb24nO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcHV0Q29tbWFuZCA9IG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICAgIEJ1Y2tldDogYnVja2V0TmFtZSxcbiAgICAgICAgICAgIEtleTogZW1iZWRkaW5nc0tleSxcbiAgICAgICAgICAgIEJvZHk6IEpTT04uc3RyaW5naWZ5KGVtYmVkZGluZ3MsIG51bGwsIDIpLFxuICAgICAgICAgICAgQ29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICB9KTtcblxuICAgICAgICBhd2FpdCBzM0NsaWVudC5zZW5kKHB1dENvbW1hbmQpO1xuXG4gICAgICAgIGNvbnN0IGVsYXBzZWRUaW1lID0gKChEYXRlLm5vdygpIC0gc3RhcnRUaW1lKSAvIDEwMDApLnRvRml4ZWQoMik7XG4gICAgICAgIGNvbnNvbGUubG9nKGDinIUgU3RvcmVkIGVtYmVkZGluZ3MgaW4gUzM6IHMzOi8vJHtidWNrZXROYW1lfS8ke2VtYmVkZGluZ3NLZXl9YCk7XG4gICAgICAgIGNvbnNvbGUubG9nKGDij7HvuI8gIFRvdGFsIHRpbWU6ICR7ZWxhcHNlZFRpbWV9c2ApO1xuICAgICAgICBjb25zb2xlLmxvZyhg8J+TpiBGaWxlIHNpemU6ICR7KEpTT04uc3RyaW5naWZ5KGVtYmVkZGluZ3MpLmxlbmd0aCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpfSBNQmApO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBGYWlsZWQgdG8gc3RvcmUgZW1iZWRkaW5ncyBpbiBTMzonLCBlcnJvcik7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbn1cblxubWFpbigpLmNhdGNoKGNvbnNvbGUuZXJyb3IpO1xuIl19