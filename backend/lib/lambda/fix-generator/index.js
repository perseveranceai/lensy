"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const client_bedrock_runtime_1 = require("@aws-sdk/client-bedrock-runtime");
const progress_publisher_1 = require("./progress-publisher");
// --- Clients ---
const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION || 'us-east-1' });
const bedrockClient = new client_bedrock_runtime_1.BedrockRuntimeClient({ region: process.env.AWS_REGION || 'us-east-1' });
// --- Handler ---
const handler = async (event) => {
    // Handle API Gateway V2 proxy event
    let input = event;
    if (event.body) {
        try {
            input = typeof event.body === 'string' ? JSON.parse(event.body) : event.body;
        }
        catch (e) {
            console.warn('Could not parse event body, using event as is');
        }
    }
    const { sessionId, bucketName: eventBucket, modelId: eventModel, selectedRecommendations } = input;
    const bucketName = eventBucket || process.env.ANALYSIS_BUCKET;
    const modelId = eventModel || 'us.anthropic.claude-3-5-sonnet-20241022-v2:0'; // Default to Sonnet 3.5 New (v2) via cross-region profile
    console.log(`Starting Fix Generation for session: ${sessionId} (Bucket: ${bucketName})`);
    if (!sessionId) {
        return {
            statusCode: 400,
            body: JSON.stringify({ success: false, message: 'sessionId is required' })
        };
    }
    const progress = new progress_publisher_1.ProgressPublisher(sessionId);
    try {
        if (!bucketName)
            throw new Error('Bucket name is required (ANALYSIS_BUCKET env or bucketName payload)');
        // 1. Load Data from S3
        await progress.progress('Loading analysis results...', 'fix-generation');
        // Load Processed Content
        const contentKey = `sessions/${sessionId}/processed-content.json`;
        const contentStr = await getS3Object(bucketName, contentKey);
        const processedContent = JSON.parse(contentStr);
        const documentUrl = processedContent.url || 'unknown-url';
        // Load Findings (Dimension Results)
        const resultsKey = `sessions/${sessionId}/dimension-results.json`;
        const resultsStr = await getS3Object(bucketName, resultsKey);
        const dimensionResults = JSON.parse(resultsStr);
        // Aggregate findings/recommendations
        let issuesToFix = [];
        if (event.selectedRecommendations && event.selectedRecommendations.length > 0) {
            console.log(`Using ${event.selectedRecommendations.length} user-selected recommendations`);
            issuesToFix = event.selectedRecommendations;
        }
        else {
            console.log('No user-selected recommendations, using all findings from analysis');
            Object.values(dimensionResults).forEach((result) => {
                if (result.findings && Array.isArray(result.findings)) {
                    issuesToFix.push(...result.findings);
                }
                // Also include recommendations as they are more actionable
                if (result.recommendations && Array.isArray(result.recommendations)) {
                    issuesToFix.push(...result.recommendations.map((r) => r.action));
                }
            });
        }
        // Remove duplicates
        issuesToFix = [...new Set(issuesToFix)];
        if (issuesToFix.length === 0) {
            await progress.success('No issues to fix.', { fixCount: 0 });
            return response(true, sessionId, 0, 'No issues found to fix');
        }
        // 2. Generate Fixes with Bedrock
        await progress.progress(`Generating fixes for ${issuesToFix.length} issues...`, 'fix-generation');
        const fixes = await generateFixesWithBedrock(modelId, processedContent.markdownContent, issuesToFix, documentUrl);
        // 3. Create Fix Session
        const fixSession = {
            sessionId,
            documentUrl,
            documentHash: processedContent.hash || new Date().toISOString(),
            createdAt: new Date().toISOString(),
            fixes: fixes.map(f => ({ ...f, sessionId, status: 'PROPOSED', generatedAt: new Date().toISOString() })),
            summary: calculateSummary(fixes)
        };
        // 4. Save to S3
        const fixesKey = `sessions/${sessionId}/fixes.json`;
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: bucketName,
            Key: fixesKey,
            Body: JSON.stringify(fixSession, null, 2),
            ContentType: 'application/json'
        }));
        await progress.success(`Generated ${fixes.length} fixes`, {
            fixCount: fixes.length,
            preview: fixes.slice(0, 3).map(f => f.category)
        });
        const successBody = {
            success: true,
            fixSessionId: sessionId,
            fixCount: fixes.length,
            message: `Successfully generated ${fixes.length} fixes`
        };
        return {
            statusCode: 200,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify(successBody)
        };
    }
    catch (error) {
        const errorMsg = error.Code === 'NoSuchKey' ? `S3 Object Not Found: ${error.Key} in ${bucketName}` : error.message;
        console.error('Fix generation failed:', error);
        await progress.error(`Fix generation failed: ${errorMsg}`);
        return {
            statusCode: 500,
            headers: {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            body: JSON.stringify({
                success: false,
                fixSessionId: sessionId,
                fixCount: 0,
                message: errorMsg
            })
        };
    }
};
exports.handler = handler;
// --- Helpers ---
async function getS3Object(bucket, key) {
    const res = await s3Client.send(new client_s3_1.GetObjectCommand({ Bucket: bucket, Key: key }));
    return res.Body.transformToString();
}
function response(success, id, count, msg) {
    return { success, fixSessionId: id, fixCount: count, message: msg };
}
function calculateSummary(fixes) {
    const byCategory = {
        CODE_UPDATE: 0, LINK_FIX: 0, CONTENT_ADDITION: 0, VERSION_UPDATE: 0, FORMATTING_FIX: 0
    };
    let totalConfidence = 0;
    fixes.forEach(f => {
        if (byCategory[f.category] !== undefined)
            byCategory[f.category]++;
        totalConfidence += f.confidence;
    });
    return {
        totalFixes: fixes.length,
        byCategory,
        averageConfidence: fixes.length > 0 ? Math.round(totalConfidence / fixes.length) : 0
    };
}
// --- AI Logic ---
async function generateFixesWithBedrock(modelId, content, findings, url) {
    // Construct Prompt
    const prompt = `You are a technical documentation editor.
Your task is to generate precise, actionable fixes for the identified issues in the documentation.

DOCUMENT URL: ${url}

DOCUMENT CONTENT (Markdown):
\`\`\`markdown
${content.slice(0, 25000)}
\`\`\`
(Content truncated if too long)

IDENTIFIED ISSUES:
${findings.map((f, i) => `${i + 1}. ${f}`).join('\n')}

INSTRUCTIONS:
For each issue that can be fixed by text/code modification, generate a "Fix Object".
- "originalContent": The EXACT text/code block from the document that needs changing (must match exactly to be findable).
- "proposedContent": The replacement text/code.
- "lineStart" / "lineEnd": Approximate line numbers (context).
- "category": One of [CODE_UPDATE, LINK_FIX, CONTENT_ADDITION, VERSION_UPDATE, FORMATTING_FIX].
- "confidence": 0-100 (how sure are you this is the correct fix).
- "rationale": Brief explanation.

If an issue is vague or cannot be fixed automatically, SKIP IT.
Output specific JSON only.

OUTPUT FORMAT:
Return a valid JSON array of objects. Do not wrap in markdown code blocks.
[
  {
    "id": "fix_1",
    "category": "CODE_UPDATE",
    "originalContent": "var x = 1;",
    "proposedContent": "const x = 1;",
    "lineStart": 10,
    "lineEnd": 10,
    "confidence": 95,
    "rationale": "Use const for immutability"
  }
]
`;
    // Call Bedrock (Claude 3.5 Sonnet payload)
    const payload = {
        anthropic_version: "bedrock-2023-05-31",
        max_tokens: 4000,
        messages: [{ role: "user", content: prompt }]
    };
    const command = new client_bedrock_runtime_1.InvokeModelCommand({
        modelId,
        contentType: 'application/json',
        accept: 'application/json',
        body: JSON.stringify(payload)
    });
    const response = await bedrockClient.send(command);
    const responseBody = JSON.parse(new TextDecoder().decode(response.body));
    const text = responseBody.content[0].text;
    // Parse JSON
    try {
        const jsonMatch = text.match(/\[[\s\S]*\]/);
        if (!jsonMatch)
            return [];
        const fixes = JSON.parse(jsonMatch[0]);
        // Basic validation/sanitization
        return fixes.map((f, index) => ({
            id: `fix_${Date.now()}_${index}`,
            sessionId: '',
            documentUrl: url,
            category: (f.category || 'FORMATTING_FIX'),
            originalContent: f.originalContent || '',
            proposedContent: f.proposedContent || '',
            lineStart: f.lineStart || 0,
            lineEnd: f.lineEnd || 0,
            confidence: f.confidence || 0,
            rationale: f.rationale || 'AI generated',
            status: 'PROPOSED',
            generatedAt: new Date().toISOString()
        }));
    }
    catch (e) {
        console.error("Failed to parse AI fix response", e);
        console.log("Raw response:", text);
        throw new Error("AI response was not valid JSON");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvZml4LWdlbmVyYXRvci9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFFQSxrREFBa0Y7QUFDbEYsNEVBQTJGO0FBQzNGLDZEQUF5RDtBQWtEekQsa0JBQWtCO0FBRWxCLE1BQU0sUUFBUSxHQUFHLElBQUksb0JBQVEsQ0FBQyxFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0FBQ2pGLE1BQU0sYUFBYSxHQUFHLElBQUksNkNBQW9CLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVyxFQUFFLENBQUMsQ0FBQztBQUVsRyxrQkFBa0I7QUFFWCxNQUFNLE9BQU8sR0FBc0IsS0FBSyxFQUFFLEtBQUssRUFBRSxFQUFFO0lBQ3RELG9DQUFvQztJQUNwQyxJQUFJLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDbEIsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFO1FBQ1osSUFBSTtZQUNBLEtBQUssR0FBRyxPQUFPLEtBQUssQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztTQUNoRjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1IsT0FBTyxDQUFDLElBQUksQ0FBQywrQ0FBK0MsQ0FBQyxDQUFDO1NBQ2pFO0tBQ0o7SUFFRCxNQUFNLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxXQUFXLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSx1QkFBdUIsRUFBRSxHQUFHLEtBQUssQ0FBQztJQUNuRyxNQUFNLFVBQVUsR0FBRyxXQUFXLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUM7SUFDOUQs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WUFDeEMsTUFBTSxFQUFFLFVBQXVCO1lBQy9CLFdBQVcsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtTQUN4QyxDQUFDLENBQUMsQ0FBQztLQUNQO0lBQUMsT0FBTyxDQUFDLEVBQUU7UUFDUixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3BELE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ25DLE1BQU0sSUFBSSxLQUFLLENBQUMsZ0NBQWdDLENBQUMsQ0FBQztLQUNyRDtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IEhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFMzQ2xpZW50LCBHZXRPYmplY3RDb21tYW5kLCBQdXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IEJlZHJvY2tSdW50aW1lQ2xpZW50LCBJbnZva2VNb2RlbENvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtYmVkcm9jay1ydW50aW1lJztcbmltcG9ydCB7IFByb2dyZXNzUHVibGlzaGVyIH0gZnJvbSAnLi9wcm9ncmVzcy1wdWJsaXNoZXInO1xuXG4vLyAtLS0gSW50ZXJmYWNlcyAtLS1cblxuaW50ZXJmYWNlIEZpeEdlbmVyYXRvckV2ZW50IHtcbiAgICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgICAvLyBPcHRpb25hbCBvdmVycmlkZXNcbiAgICBidWNrZXROYW1lPzogc3RyaW5nO1xuICAgIG1vZGVsSWQ/OiBzdHJpbmc7XG4gICAgc2VsZWN0ZWRSZWNvbW1lbmRhdGlvbnM/OiBzdHJpbmdbXTsgLy8gU3BlY2lmaWMgcmVjb21tZW5kYXRpb24gYWN0aW9ucyB0byBmaXhcbn1cblxuaW50ZXJmYWNlIEZpeEdlbmVyYXRvclJlc3BvbnNlIHtcbiAgICBzdWNjZXNzOiBib29sZWFuO1xuICAgIGZpeFNlc3Npb25JZDogc3RyaW5nO1xuICAgIGZpeENvdW50OiBudW1iZXI7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xufVxuXG50eXBlIEZpeENhdGVnb3J5ID0gJ0NPREVfVVBEQVRFJyB8ICdMSU5LX0ZJWCcgfCAnQ09OVEVOVF9BRERJVElPTicgfCAnVkVSU0lPTl9VUERBVEUnIHwgJ0ZPUk1BVFRJTkdfRklYJztcbnR5cGUgRml4U3RhdHVzID0gJ1BST1BPU0VEJyB8ICdBUFBST1ZFRCcgfCAnUkVKRUNURUQnIHwgJ0FQUExJRUQnIHwgJ0ZBSUxFRCc7XG5cbmludGVyZmFjZSBGaXgge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgc2Vzc2lvbklkOiBzdHJpbmc7XG4gICAgZG9jdW1lbnRVcmw6IHN0cmluZztcbiAgICBjYXRlZ29yeTogRml4Q2F0ZWdvcnk7XG4gICAgb3JpZ2luYWxDb250ZW50OiBzdHJpbmc7XG4gICAgcHJvcG9zZWRDb250ZW50OiBzdHJpbmc7XG4gICAgbGluZVN0YXJ0OiBudW1iZXI7XG4gICAgbGluZUVuZDogbnVtYmVyO1xuICAgIGNvbmZpZGVuY2U6IG51bWJlcjtcbiAgICByYXRpb25hbGU6IHN0cmluZztcbiAgICBzdGF0dXM6IEZpeFN0YXR1cztcbiAgICBnZW5lcmF0ZWRBdDogc3RyaW5nO1xufVxuXG5pbnRlcmZhY2UgRml4U2Vzc2lvbiB7XG4gICAgc2Vzc2lvbklkOiBzdHJpbmc7XG4gICAgZG9jdW1lbnRVcmw6IHN0cmluZztcbiAgICBkb2N1bWVudEhhc2g6IHN0cmluZzsgLy8gVG8gbWF0Y2ggcHJvY2Vzc2VkLWNvbnRlbnQgaGFzaCBpZiB3ZSBoYWQgaXQsIG9yIGp1c3QgdXNlIHRpbWVzdGFtcCBmb3Igbm93XG4gICAgY3JlYXRlZEF0OiBzdHJpbmc7XG4gICAgZml4ZXM6IEZpeFtdO1xuICAgIHN1bW1hcnk6IHtcbiAgICAgICAgdG90YWxGaXhlczogbnVtYmVyO1xuICAgICAgICBieUNhdGVnb3J5OiBSZWNvcmQ8Rml4Q2F0ZWdvcnksIG51bWJlcj47XG4gICAgICAgIGF2ZXJhZ2VDb25maWRlbmNlOiBudW1iZXI7XG4gICAgfTtcbn1cblxuLy8gLS0tIENsaWVudHMgLS0tXG5cbmNvbnN0IHMzQ2xpZW50ID0gbmV3IFMzQ2xpZW50KHsgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnIH0pO1xuY29uc3QgYmVkcm9ja0NsaWVudCA9IG5ldyBCZWRyb2NrUnVudGltZUNsaWVudCh7IHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTiB8fCAndXMtZWFzdC0xJyB9KTtcblxuLy8gLS0tIEhhbmRsZXIgLS0tXG5cbmV4cG9ydCBjb25zdCBoYW5kbGVyOiBIYW5kbGVyPGFueSwgYW55PiA9IGFzeW5jIChldmVudCkgPT4ge1xuICAgIC8vIEhhbmRsZSBBUEkgR2F0ZXdheSBWMiBwcm94eSBldmVudFxuICAgIGxldCBpbnB1dCA9IGV2ZW50O1xuICAgIGlmIChldmVudC5ib2R5KSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpbnB1dCA9IHR5cGVvZiBldmVudC5ib2R5ID09PSAnc3RyaW5nJyA/IEpTT04ucGFyc2UoZXZlbnQuYm9keSkgOiBldmVudC5ib2R5O1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oJ0NvdWxkIG5vdCBwYXJzZSBldmVudCBib2R5LCB1c2luZyBldmVudCBhcyBpcycpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgeyBzZXNzaW9uSWQsIGJ1Y2tldE5hbWU6IGV2ZW50QnVja2V0LCBtb2RlbElkOiBldmVudE1vZGVsLCBzZWxlY3RlZFJlY29tbWVuZGF0aW9ucyB9ID0gaW5wdXQ7XG4gICAgY29uc3QgYnVja2V0TmFtZSA9IGV2ZW50QnVja2V0IHx8IHByb2Nlc3MuZW52LkFOQUxZU0lTX0JVQ0tFVDtcbiAgICBjb25zdCBtb2RlbElkID0gZXZlbnRNb2RlbCB8fCAndXMuYW50aHJvcGljLmNsYXVkZS0zLTUtc29ubmV0LTIwMjQxMDIyLXYyOjAnOyAvLyBEZWZhdWx0IHRvIFNvbm5ldCAzLjUgTmV3ICh2MikgdmlhIGNyb3NzLXJlZ2lvbiBwcm9maWxlXG5cbiAgICBjb25zb2xlLmxvZyhgU3RhcnRpbmcgRml4IEdlbmVyYXRpb24gZm9yIHNlc3Npb246ICR7c2Vzc2lvbklkfSAoQnVja2V0OiAke2J1Y2tldE5hbWV9KWApO1xuICAgIGlmICghc2Vzc2lvbklkKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiA0MDAsXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHN1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnc2Vzc2lvbklkIGlzIHJlcXVpcmVkJyB9KVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGNvbnN0IHByb2dyZXNzID0gbmV3IFByb2dyZXNzUHVibGlzaGVyKHNlc3Npb25JZCk7XG5cbiAgICB0cnkge1xuICAgICAgICBpZiAoIWJ1Y2tldE5hbWUpIHRocm93IG5ldyBFcnJvcignQnVja2V0IG5hbWUgaXMgcmVxdWlyZWQgKEFOQUxZU0lTX0JVQ0tFVCBlbnYgb3IgYnVja2V0TmFtZSBwYXlsb2FkKScpO1xuXG4gICAgICAgIC8vIDEuIExvYWQgRGF0YSBmcm9tIFMzXG4gICAgICAgIGF3YWl0IHByb2dyZXNzLnByb2dyZXNzKCdMb2FkaW5nIGFuYWx5c2lzIHJlc3VsdHMuLi4nLCAnZml4LWdlbmVyYXRpb24nKTtcblxuICAgICAgICAvLyBMb2FkIFByb2Nlc3NlZCBDb250ZW50XG4gICAgICAgIGNvbnN0IGNvbnRlbnRLZXkgPSBgc2Vzc2lvbnMvJHtzZXNzaW9uSWR9L3Byb2Nlc3NlZC1jb250ZW50Lmpzb25gO1xuICAgICAgICBjb25zdCBjb250ZW50U3RyID0gYXdhaXQgZ2V0UzNPYmplY3QoYnVja2V0TmFtZSwgY29udGVudEtleSk7XG4gICAgICAgIGNvbnN0IHByb2Nlc3NlZENvbnRlbnQgPSBKU09OLnBhcnNlKGNvbnRlbnRTdHIpO1xuICAgICAgICBjb25zdCBkb2N1bWVudFVybCA9IHByb2Nlc3NlZENvbnRlbnQudXJsIHx8ICd1bmtub3duLXVybCc7XG5cbiAgICAgICAgLy8gTG9hZCBGaW5kaW5ncyAoRGltZW5zaW9uIFJlc3VsdHMpXG4gICAgICAgIGNvbnN0IHJlc3VsdHNLZXkgPSBgc2Vzc2lvbnMvJHtzZXNzaW9uSWR9L2RpbWVuc2lvbi1yZXN1bHRzLmpzb25gO1xuICAgICAgICBjb25zdCByZXN1bHRzU3RyID0gYXdhaXQgZ2V0UzNPYmplY3QoYnVja2V0TmFtZSwgcmVzdWx0c0tleSk7XG4gICAgICAgIGNvbnN0IGRpbWVuc2lvblJlc3VsdHMgPSBKU09OLnBhcnNlKHJlc3VsdHNTdHIpO1xuXG4gICAgICAgIC8vIEFnZ3JlZ2F0ZSBmaW5kaW5ncy9yZWNvbW1lbmRhdGlvbnNcbiAgICAgICAgbGV0IGlzc3Vlc1RvRml4OiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICAgIGlmIChldmVudC5zZWxlY3RlZFJlY29tbWVuZGF0aW9ucyAmJiBldmVudC5zZWxlY3RlZFJlY29tbWVuZGF0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgVXNpbmcgJHtldmVudC5zZWxlY3RlZFJlY29tbWVuZGF0aW9ucy5sZW5ndGh9IHVzZXItc2VsZWN0ZWQgcmVjb21tZW5kYXRpb25zYCk7XG4gICAgICAgICAgICBpc3N1ZXNUb0ZpeCA9IGV2ZW50LnNlbGVjdGVkUmVjb21tZW5kYXRpb25zO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ05vIHVzZXItc2VsZWN0ZWQgcmVjb21tZW5kYXRpb25zLCB1c2luZyBhbGwgZmluZGluZ3MgZnJvbSBhbmFseXNpcycpO1xuICAgICAgICAgICAgT2JqZWN0LnZhbHVlcyhkaW1lbnNpb25SZXN1bHRzKS5mb3JFYWNoKChyZXN1bHQ6IGFueSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuZmluZGluZ3MgJiYgQXJyYXkuaXNBcnJheShyZXN1bHQuZmluZGluZ3MpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzc3Vlc1RvRml4LnB1c2goLi4ucmVzdWx0LmZpbmRpbmdzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gQWxzbyBpbmNsdWRlIHJlY29tbWVuZGF0aW9ucyBhcyB0aGV5IGFyZSBtb3JlIGFjdGlvbmFibGVcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnJlY29tbWVuZGF0aW9ucyAmJiBBcnJheS5pc0FycmF5KHJlc3VsdC5yZWNvbW1lbmRhdGlvbnMpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlzc3Vlc1RvRml4LnB1c2goLi4ucmVzdWx0LnJlY29tbWVuZGF0aW9ucy5tYXAoKHI6IGFueSkgPT4gci5hY3Rpb24pKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzXG4gICAgICAgIGlzc3Vlc1RvRml4ID0gWy4uLm5ldyBTZXQoaXNzdWVzVG9GaXgpXTtcblxuICAgICAgICBpZiAoaXNzdWVzVG9GaXgubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9ncmVzcy5zdWNjZXNzKCdObyBpc3N1ZXMgdG8gZml4LicsIHsgZml4Q291bnQ6IDAgfSk7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UodHJ1ZSwgc2Vzc2lvbklkLCAwLCAnTm8gaXNzdWVzIGZvdW5kIHRvIGZpeCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gMi4gR2VuZXJhdGUgRml4ZXMgd2l0aCBCZWRyb2NrXG4gICAgICAgIGF3YWl0IHByb2dyZXNzLnByb2dyZXNzKGBHZW5lcmF0aW5nIGZpeGVzIGZvciAke2lzc3Vlc1RvRml4Lmxlbmd0aH0gaXNzdWVzLi4uYCwgJ2ZpeC1nZW5lcmF0aW9uJyk7XG5cbiAgICAgICAgY29uc3QgZml4ZXMgPSBhd2FpdCBnZW5lcmF0ZUZpeGVzV2l0aEJlZHJvY2sobW9kZWxJZCwgcHJvY2Vzc2VkQ29udGVudC5tYXJrZG93bkNvbnRlbnQsIGlzc3Vlc1RvRml4LCBkb2N1bWVudFVybCk7XG5cbiAgICAgICAgLy8gMy4gQ3JlYXRlIEZpeCBTZXNzaW9uXG4gICAgICAgIGNvbnN0IGZpeFNlc3Npb246IEZpeFNlc3Npb24gPSB7XG4gICAgICAgICAgICBzZXNzaW9uSWQsXG4gICAgICAgICAgICBkb2N1bWVudFVybCxcbiAgICAgICAgICAgIGRvY3VtZW50SGFzaDogcHJvY2Vzc2VkQ29udGVudC5oYXNoIHx8IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgLy8gRmFsbGJhY2tcbiAgICAgICAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgZml4ZXM6IGZpeGVzLm1hcChmID0+ICh7IC4uLmYsIHNlc3Npb25JZCwgc3RhdHVzOiAnUFJPUE9TRUQnLCBnZW5lcmF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpIH0pKSxcbiAgICAgICAgICAgIHN1bW1hcnk6IGNhbGN1bGF0ZVN1bW1hcnkoZml4ZXMpXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gNC4gU2F2ZSB0byBTM1xuICAgICAgICBjb25zdCBmaXhlc0tleSA9IGBzZXNzaW9ucy8ke3Nlc3Npb25JZH0vZml4ZXMuanNvbmA7XG4gICAgICAgIGF3YWl0IHMzQ2xpZW50LnNlbmQobmV3IFB1dE9iamVjdENvbW1hbmQoe1xuICAgICAgICAgICAgQnVja2V0OiBidWNrZXROYW1lLFxuICAgICAgICAgICAgS2V5OiBmaXhlc0tleSxcbiAgICAgICAgICAgIEJvZHk6IEpTT04uc3RyaW5naWZ5KGZpeFNlc3Npb24sIG51bGwsIDIpLFxuICAgICAgICAgICAgQ29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3Muc3VjY2VzcyhgR2VuZXJhdGVkICR7Zml4ZXMubGVuZ3RofSBmaXhlc2AsIHtcbiAgICAgICAgICAgIGZpeENvdW50OiBmaXhlcy5sZW5ndGgsXG4gICAgICAgICAgICBwcmV2aWV3OiBmaXhlcy5zbGljZSgwLCAzKS5tYXAoZiA9PiBmLmNhdGVnb3J5KVxuICAgICAgICB9KTtcblxuICAgICAgICBjb25zdCBzdWNjZXNzQm9keSA9IHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBmaXhTZXNzaW9uSWQ6IHNlc3Npb25JZCxcbiAgICAgICAgICAgIGZpeENvdW50OiBmaXhlcy5sZW5ndGgsXG4gICAgICAgICAgICBtZXNzYWdlOiBgU3VjY2Vzc2Z1bGx5IGdlbmVyYXRlZCAke2ZpeGVzLmxlbmd0aH0gZml4ZXNgXG4gICAgICAgIH07XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN0YXR1c0NvZGU6IDIwMCxcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAgICAgICAgICdBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4nOiAnKidcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShzdWNjZXNzQm9keSlcbiAgICAgICAgfTtcblxuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgICAgY29uc3QgZXJyb3JNc2cgPSBlcnJvci5Db2RlID09PSAnTm9TdWNoS2V5JyA/IGBTMyBPYmplY3QgTm90IEZvdW5kOiAke2Vycm9yLktleX0gaW4gJHtidWNrZXROYW1lfWAgOiBlcnJvci5tZXNzYWdlO1xuICAgICAgICBjb25zb2xlLmVycm9yKCdGaXggZ2VuZXJhdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgICBhd2FpdCBwcm9ncmVzcy5lcnJvcihgRml4IGdlbmVyYXRpb24gZmFpbGVkOiAke2Vycm9yTXNnfWApO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3RhdHVzQ29kZTogNTAwLFxuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgICAgICAgJ0FjY2Vzcy1Db250cm9sLUFsbG93LU9yaWdpbic6ICcqJ1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICBmaXhTZXNzaW9uSWQ6IHNlc3Npb25JZCxcbiAgICAgICAgICAgICAgICBmaXhDb3VudDogMCxcbiAgICAgICAgICAgICAgICBtZXNzYWdlOiBlcnJvck1zZ1xuICAgICAgICAgICAgfSlcbiAgICAgICAgfTtcbiAgICB9XG59O1xuXG4vLyAtLS0gSGVscGVycyAtLS1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0UzNPYmplY3QoYnVja2V0OiBzdHJpbmcsIGtleTogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBzM0NsaWVudC5zZW5kKG5ldyBHZXRPYmplY3RDb21tYW5kKHsgQnVja2V0OiBidWNrZXQsIEtleToga2V5IH0pKTtcbiAgICByZXR1cm4gcmVzLkJvZHkhLnRyYW5zZm9ybVRvU3RyaW5nKCk7XG59XG5cbmZ1bmN0aW9uIHJlc3BvbnNlKHN1Y2Nlc3M6IGJvb2xlYW4sIGlkOiBzdHJpbmcsIGNvdW50OiBudW1iZXIsIG1zZzogc3RyaW5nKTogRml4R2VuZXJhdG9yUmVzcG9uc2Uge1xuICAgIHJldHVybiB7IHN1Y2Nlc3MsIGZpeFNlc3Npb25JZDogaWQsIGZpeENvdW50OiBjb3VudCwgbWVzc2FnZTogbXNnIH07XG59XG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZVN1bW1hcnkoZml4ZXM6IEZpeFtdKTogRml4U2Vzc2lvblsnc3VtbWFyeSddIHtcbiAgICBjb25zdCBieUNhdGVnb3J5OiBSZWNvcmQ8Rml4Q2F0ZWdvcnksIG51bWJlcj4gPSB7XG4gICAgICAgIENPREVfVVBEQVRFOiAwLCBMSU5LX0ZJWDogMCwgQ09OVEVOVF9BRERJVElPTjogMCwgVkVSU0lPTl9VUERBVEU6IDAsIEZPUk1BVFRJTkdfRklYOiAwXG4gICAgfTtcbiAgICBsZXQgdG90YWxDb25maWRlbmNlID0gMDtcblxuICAgIGZpeGVzLmZvckVhY2goZiA9PiB7XG4gICAgICAgIGlmIChieUNhdGVnb3J5W2YuY2F0ZWdvcnldICE9PSB1bmRlZmluZWQpIGJ5Q2F0ZWdvcnlbZi5jYXRlZ29yeV0rKztcbiAgICAgICAgdG90YWxDb25maWRlbmNlICs9IGYuY29uZmlkZW5jZTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHRvdGFsRml4ZXM6IGZpeGVzLmxlbmd0aCxcbiAgICAgICAgYnlDYXRlZ29yeSxcbiAgICAgICAgYXZlcmFnZUNvbmZpZGVuY2U6IGZpeGVzLmxlbmd0aCA+IDAgPyBNYXRoLnJvdW5kKHRvdGFsQ29uZmlkZW5jZSAvIGZpeGVzLmxlbmd0aCkgOiAwXG4gICAgfTtcbn1cblxuLy8gLS0tIEFJIExvZ2ljIC0tLVxuXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUZpeGVzV2l0aEJlZHJvY2soXG4gICAgbW9kZWxJZDogc3RyaW5nLFxuICAgIGNvbnRlbnQ6IHN0cmluZyxcbiAgICBmaW5kaW5nczogc3RyaW5nW10sXG4gICAgdXJsOiBzdHJpbmdcbik6IFByb21pc2U8Rml4W10+IHtcblxuICAgIC8vIENvbnN0cnVjdCBQcm9tcHRcbiAgICBjb25zdCBwcm9tcHQgPSBgWW91IGFyZSBhIHRlY2huaWNhbCBkb2N1bWVudGF0aW9uIGVkaXRvci5cbllvdXIgdGFzayBpcyB0byBnZW5lcmF0ZSBwcmVjaXNlLCBhY3Rpb25hYmxlIGZpeGVzIGZvciB0aGUgaWRlbnRpZmllZCBpc3N1ZXMgaW4gdGhlIGRvY3VtZW50YXRpb24uXG5cbkRPQ1VNRU5UIFVSTDogJHt1cmx9XG5cbkRPQ1VNRU5UIENPTlRFTlQgKE1hcmtkb3duKTpcblxcYFxcYFxcYG1hcmtkb3duXG4ke2NvbnRlbnQuc2xpY2UoMCwgMjUwMDApfVxuXFxgXFxgXFxgXG4oQ29udGVudCB0cnVuY2F0ZWQgaWYgdG9vIGxvbmcpXG5cbklERU5USUZJRUQgSVNTVUVTOlxuJHtmaW5kaW5ncy5tYXAoKGYsIGkpID0+IGAke2kgKyAxfS4gJHtmfWApLmpvaW4oJ1xcbicpfVxuXG5JTlNUUlVDVElPTlM6XG5Gb3IgZWFjaCBpc3N1ZSB0aGF0IGNhbiBiZSBmaXhlZCBieSB0ZXh0L2NvZGUgbW9kaWZpY2F0aW9uLCBnZW5lcmF0ZSBhIFwiRml4IE9iamVjdFwiLlxuLSBcIm9yaWdpbmFsQ29udGVudFwiOiBUaGUgRVhBQ1QgdGV4dC9jb2RlIGJsb2NrIGZyb20gdGhlIGRvY3VtZW50IHRoYXQgbmVlZHMgY2hhbmdpbmcgKG11c3QgbWF0Y2ggZXhhY3RseSB0byBiZSBmaW5kYWJsZSkuXG4tIFwicHJvcG9zZWRDb250ZW50XCI6IFRoZSByZXBsYWNlbWVudCB0ZXh0L2NvZGUuXG4tIFwibGluZVN0YXJ0XCIgLyBcImxpbmVFbmRcIjogQXBwcm94aW1hdGUgbGluZSBudW1iZXJzIChjb250ZXh0KS5cbi0gXCJjYXRlZ29yeVwiOiBPbmUgb2YgW0NPREVfVVBEQVRFLCBMSU5LX0ZJWCwgQ09OVEVOVF9BRERJVElPTiwgVkVSU0lPTl9VUERBVEUsIEZPUk1BVFRJTkdfRklYXS5cbi0gXCJjb25maWRlbmNlXCI6IDAtMTAwIChob3cgc3VyZSBhcmUgeW91IHRoaXMgaXMgdGhlIGNvcnJlY3QgZml4KS5cbi0gXCJyYXRpb25hbGVcIjogQnJpZWYgZXhwbGFuYXRpb24uXG5cbklmIGFuIGlzc3VlIGlzIHZhZ3VlIG9yIGNhbm5vdCBiZSBmaXhlZCBhdXRvbWF0aWNhbGx5LCBTS0lQIElULlxuT3V0cHV0IHNwZWNpZmljIEpTT04gb25seS5cblxuT1VUUFVUIEZPUk1BVDpcblJldHVybiBhIHZhbGlkIEpTT04gYXJyYXkgb2Ygb2JqZWN0cy4gRG8gbm90IHdyYXAgaW4gbWFya2Rvd24gY29kZSBibG9ja3MuXG5bXG4gIHtcbiAgICBcImlkXCI6IFwiZml4XzFcIixcbiAgICBcImNhdGVnb3J5XCI6IFwiQ09ERV9VUERBVEVcIixcbiAgICBcIm9yaWdpbmFsQ29udGVudFwiOiBcInZhciB4ID0gMTtcIixcbiAgICBcInByb3Bvc2VkQ29udGVudFwiOiBcImNvbnN0IHggPSAxO1wiLFxuICAgIFwibGluZVN0YXJ0XCI6IDEwLFxuICAgIFwibGluZUVuZFwiOiAxMCxcbiAgICBcImNvbmZpZGVuY2VcIjogOTUsXG4gICAgXCJyYXRpb25hbGVcIjogXCJVc2UgY29uc3QgZm9yIGltbXV0YWJpbGl0eVwiXG4gIH1cbl1cbmA7XG5cbiAgICAvLyBDYWxsIEJlZHJvY2sgKENsYXVkZSAzLjUgU29ubmV0IHBheWxvYWQpXG4gICAgY29uc3QgcGF5bG9hZCA9IHtcbiAgICAgICAgYW50aHJvcGljX3ZlcnNpb246IFwiYmVkcm9jay0yMDIzLTA1LTMxXCIsXG4gICAgICAgIG1heF90b2tlbnM6IDQwMDAsXG4gICAgICAgIG1lc3NhZ2VzOiBbeyByb2xlOiBcInVzZXJcIiwgY29udGVudDogcHJvbXB0IH1dXG4gICAgfTtcblxuICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgSW52b2tlTW9kZWxDb21tYW5kKHtcbiAgICAgICAgbW9kZWxJZCxcbiAgICAgICAgY29udGVudFR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAgICAgYWNjZXB0OiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHBheWxvYWQpXG4gICAgfSk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGJlZHJvY2tDbGllbnQuc2VuZChjb21tYW5kKTtcbiAgICBjb25zdCByZXNwb25zZUJvZHkgPSBKU09OLnBhcnNlKG5ldyBUZXh0RGVjb2RlcigpLmRlY29kZShyZXNwb25zZS5ib2R5KSk7XG4gICAgY29uc3QgdGV4dCA9IHJlc3BvbnNlQm9keS5jb250ZW50WzBdLnRleHQ7XG5cbiAgICAvLyBQYXJzZSBKU09OXG4gICAgdHJ5IHtcbiAgICAgICAgY29uc3QganNvbk1hdGNoID0gdGV4dC5tYXRjaCgvXFxbW1xcc1xcU10qXFxdLyk7XG4gICAgICAgIGlmICghanNvbk1hdGNoKSByZXR1cm4gW107XG4gICAgICAgIGNvbnN0IGZpeGVzID0gSlNPTi5wYXJzZShqc29uTWF0Y2hbMF0pO1xuXG4gICAgICAgIC8vIEJhc2ljIHZhbGlkYXRpb24vc2FuaXRpemF0aW9uXG4gICAgICAgIHJldHVybiBmaXhlcy5tYXAoKGY6IGFueSwgaW5kZXg6IG51bWJlcikgPT4gKHtcbiAgICAgICAgICAgIGlkOiBgZml4XyR7RGF0ZS5ub3coKX1fJHtpbmRleH1gLFxuICAgICAgICAgICAgc2Vzc2lvbklkOiAnJywgLy8gRmlsbGVkIGJ5IGNhbGxlclxuICAgICAgICAgICAgZG9jdW1lbnRVcmw6IHVybCxcbiAgICAgICAgICAgIGNhdGVnb3J5OiAoZi5jYXRlZ29yeSB8fCAnRk9STUFUVElOR19GSVgnKSBhcyBGaXhDYXRlZ29yeSxcbiAgICAgICAgICAgIG9yaWdpbmFsQ29udGVudDogZi5vcmlnaW5hbENvbnRlbnQgfHwgJycsXG4gICAgICAgICAgICBwcm9wb3NlZENvbnRlbnQ6IGYucHJvcG9zZWRDb250ZW50IHx8ICcnLFxuICAgICAgICAgICAgbGluZVN0YXJ0OiBmLmxpbmVTdGFydCB8fCAwLFxuICAgICAgICAgICAgbGluZUVuZDogZi5saW5lRW5kIHx8IDAsXG4gICAgICAgICAgICBjb25maWRlbmNlOiBmLmNvbmZpZGVuY2UgfHwgMCxcbiAgICAgICAgICAgIHJhdGlvbmFsZTogZi5yYXRpb25hbGUgfHwgJ0FJIGdlbmVyYXRlZCcsXG4gICAgICAgICAgICBzdGF0dXM6ICdQUk9QT1NFRCcgYXMgRml4U3RhdHVzLFxuICAgICAgICAgICAgZ2VuZXJhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgICB9KSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRmFpbGVkIHRvIHBhcnNlIEFJIGZpeCByZXNwb25zZVwiLCBlKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJSYXcgcmVzcG9uc2U6XCIsIHRleHQpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJBSSByZXNwb25zZSB3YXMgbm90IHZhbGlkIEpTT05cIik7XG4gICAgfVxufVxuIl19