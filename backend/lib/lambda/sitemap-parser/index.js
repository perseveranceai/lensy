"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = void 0;
const client_s3_1 = require("@aws-sdk/client-s3");
const xml2js_1 = require("xml2js");
const progress_publisher_1 = require("./progress-publisher");
const handler = async (event) => {
    const startTime = Date.now();
    console.log('Parsing sitemap for URL:', event.url);
    // Initialize progress publisher and S3 client
    const progress = new progress_publisher_1.ProgressPublisher(event.sessionId);
    const s3Client = new client_s3_1.S3Client({ region: process.env.AWS_REGION });
    try {
        // Send initial progress
        await progress.progress('Starting sitemap parsing...', 'sitemap-parsing');
        // Fetch and parse the sitemap
        const result = await parseSitemapRecursively(event.url, progress, 0);
        // Store results in S3
        const s3Key = `sessions/${event.sessionId}/sitemap-results.json`;
        const s3Location = `s3://${process.env.ANALYSIS_BUCKET}/${s3Key}`;
        const sitemapResults = {
            originalUrl: event.url,
            totalUrls: result.urls.length,
            urls: result.urls,
            nestedSitemaps: result.nestedSitemaps,
            processingTime: Date.now() - startTime,
            timestamp: new Date().toISOString()
        };
        await s3Client.send(new client_s3_1.PutObjectCommand({
            Bucket: process.env.ANALYSIS_BUCKET,
            Key: s3Key,
            Body: JSON.stringify(sitemapResults, null, 2),
            ContentType: 'application/json'
        }));
        // Send completion message
        await progress.success(`Sitemap parsing complete: Found ${result.urls.length} URLs${result.nestedSitemaps > 0 ? ` (${result.nestedSitemaps} nested sitemaps)` : ''}`, {
            totalUrls: result.urls.length,
            nestedSitemaps: result.nestedSitemaps,
            processingTime: Date.now() - startTime
        });
        console.log(`Sitemap parsing completed: ${result.urls.length} URLs found`);
        return {
            success: true,
            sessionId: event.sessionId,
            totalUrls: result.urls.length,
            sitemapUrls: result.urls,
            nestedSitemaps: result.nestedSitemaps,
            s3Location,
            message: `Successfully parsed sitemap with ${result.urls.length} URLs`,
            processingTime: Date.now() - startTime
        };
    }
    catch (error) {
        console.error('Sitemap parsing failed:', error);
        await progress.error(`Sitemap parsing failed: ${error instanceof Error ? error.message : 'Unknown error'}`);
        return {
            success: false,
            sessionId: event.sessionId,
            totalUrls: 0,
            sitemapUrls: [],
            nestedSitemaps: 0,
            s3Location: '',
            message: `Sitemap parsing failed: ${error instanceof Error ? error.message : 'Unknown error'}`,
            processingTime: Date.now() - startTime
        };
    }
};
exports.handler = handler;
/**
 * Recursively parse sitemap with nested sitemap support
 * Requirements: 29.1, 29.2, 29.3, 29.7, 29.8, 29.9, 29.10
 */
async function parseSitemapRecursively(sitemapUrl, progress, depth = 0, maxDepth = 3, processedUrls = new Set()) {
    // Prevent infinite recursion and duplicate processing
    if (depth > maxDepth) {
        console.log(`Max depth ${maxDepth} reached, skipping: ${sitemapUrl}`);
        return { urls: [], nestedSitemaps: 0 };
    }
    if (processedUrls.has(sitemapUrl)) {
        console.log(`Already processed: ${sitemapUrl}`);
        return { urls: [], nestedSitemaps: 0 };
    }
    processedUrls.add(sitemapUrl);
    try {
        await progress.progress(`Fetching sitemap: ${sitemapUrl}`, 'sitemap-parsing');
        // Fetch sitemap content with timeout handling
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
        const response = await fetch(sitemapUrl, {
            headers: {
                'User-Agent': 'Lensy Documentation Quality Auditor/1.0'
            },
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const contentType = response.headers.get('content-type') || '';
        let xmlContent;
        // Handle compressed sitemaps
        if (contentType.includes('gzip') || sitemapUrl.endsWith('.gz')) {
            await progress.progress('Decompressing gzipped sitemap...', 'sitemap-parsing');
            // For now, assume uncompressed. In production, would use zlib
            xmlContent = await response.text();
        }
        else {
            xmlContent = await response.text();
        }
        // Parse XML
        const parsedXml = await new Promise((resolve, reject) => {
            (0, xml2js_1.parseString)(xmlContent, {
                explicitArray: true,
                ignoreAttrs: false,
                trim: true
            }, (err, result) => {
                if (err)
                    reject(err);
                else
                    resolve(result);
            });
        });
        let allUrls = [];
        let nestedSitemapCount = 0;
        // Handle sitemap index (contains references to other sitemaps)
        if (parsedXml.sitemapindex?.sitemap) {
            await progress.progress(`Found sitemap index with ${parsedXml.sitemapindex.sitemap.length} nested sitemaps`, 'sitemap-parsing');
            for (const nestedSitemap of parsedXml.sitemapindex.sitemap) {
                if (nestedSitemap.loc && nestedSitemap.loc[0]) {
                    const nestedUrl = nestedSitemap.loc[0].trim();
                    console.log(`Processing nested sitemap: ${nestedUrl}`);
                    const nestedResult = await parseSitemapRecursively(nestedUrl, progress, depth + 1, maxDepth, processedUrls);
                    allUrls.push(...nestedResult.urls);
                    nestedSitemapCount += 1 + nestedResult.nestedSitemaps;
                }
            }
        }
        // Handle regular sitemap (contains actual URLs)
        if (parsedXml.urlset?.url) {
            await progress.progress(`Extracting ${parsedXml.urlset.url.length} URLs from sitemap`, 'sitemap-parsing');
            for (const urlEntry of parsedXml.urlset.url) {
                if (urlEntry.loc && urlEntry.loc[0]) {
                    const url = urlEntry.loc[0].trim();
                    if (url && isValidUrl(url)) {
                        allUrls.push(url);
                    }
                }
            }
        }
        // Remove duplicates
        const uniqueUrls = [...new Set(allUrls)];
        if (depth === 0) {
            await progress.progress(`Sitemap parsing complete: ${uniqueUrls.length} unique URLs found`, 'sitemap-parsing');
        }
        return {
            urls: uniqueUrls,
            nestedSitemaps: nestedSitemapCount
        };
    }
    catch (error) {
        console.error(`Error parsing sitemap ${sitemapUrl}:`, error);
        await progress.error(`Failed to parse sitemap: ${sitemapUrl} - ${error instanceof Error ? error.message : 'Unknown error'}`);
        // Return empty result but don't fail the entire process
        return { urls: [], nestedSitemaps: 0 };
    }
}
/**
 * Validate URL format
 */
function isValidUrl(urlString) {
    try {
        const url = new URL(urlString);
        return url.protocol === 'http:' || url.protocol === 'https:';
    }
    catch {
        return false;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9sYW1iZGEvc2l0ZW1hcC1wYXJzZXIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0Esa0RBQWdFO0FBQ2hFLG1DQUFxQztBQUNyQyw2REFBeUQ7QUFzQ2xELE1BQU0sT0FBTyxHQUF1RCxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUU7SUFDdkYsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO0lBQzdCLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQTBCLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRW5ELDhDQUE4QztJQUM5QyxNQUFNLFFBQVEsR0FBRyxJQUFJLHNDQUFpQixDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUN4RCxNQUFNLFFBQVEsR0FBRyxJQUFJLG9CQUFRLENBQUMsRUFBRSxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO0lBRWxFLElBQUk7UUFDQSx3QkFBd0I7UUFDeEIsTUFBTSxRQUFRLENBQUMsUUFBUSxDQUFDLDZCQUE2QixFQUFFLGlCQUFpQixDQUFDLENBQUM7UUFFMUUsOEJBQThCO1FBQzlCLE1BQU0sTUFBTSxHQUFHLE1BQU0sdUJBQXVCLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFckUsc0JBQXNCO1FBQ3RCLE1BQU0sS0FBSyxHQUFHLFlBQVksS0FBSyxDQUFDLFNBQVMsdUJBQXVCLENBQUM7UUFDakUsTUFBTSxVQUFVLEdBQUcsUUFBUSxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWUsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUVsRSxNQUFNLGNBQWMsR0FBRztZQUNuQixXQUFXLEVBQUUsS0FBSyxDQUFDLEdBQUc7WUFDdEIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTTtZ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RyxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUV6QyxJQUFJLEtBQUssS0FBSyxDQUFDLEVBQUU7WUFDYixNQUFNLFFBQVEsQ0FBQyxRQUFRLENBQUMsNkJBQTZCLFVBQVUsQ0FBQyxNQUFNLG9CQUFvQixFQUFFLGlCQUFpQixDQUFDLENBQUM7U0FDbEg7UUFFRCxPQUFPO1lBQ0gsSUFBSSxFQUFFLFVBQVU7WUFDaEIsY0FBYyxFQUFFLGtCQUFrQjtTQUNyQyxDQUFDO0tBRUw7SUFBQyxPQUFPLEtBQUssRUFBRTtRQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMseUJBQXlCLFVBQVUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzdELE1BQU0sUUFBUSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsVUFBVSxNQUFNLEtBQUssWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7UUFFN0gsd0RBQXdEO1FBQ3hELE9BQU8sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLGNBQWMsRUFBRSxDQUFDLEVBQUUsQ0FBQztLQUMxQztBQUNMLENBQUM7QUFFRDs7R0FFRztBQUNILFNBQVMsVUFBVSxDQUFDLFNBQWlCO0lBQ2pDLElBQUk7UUFDQSxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUMvQixPQUFPLEdBQUcsQ0FBQyxRQUFRLEtBQUssT0FBTyxJQUFJLEdBQUcsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDO0tBQ2hFO0lBQUMsTUFBTTtRQUNKLE9BQU8sS0FBSyxDQUFDO0tBQ2hCO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEhhbmRsZXIgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFMzQ2xpZW50LCBQdXRPYmplY3RDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXMzJztcbmltcG9ydCB7IHBhcnNlU3RyaW5nIH0gZnJvbSAneG1sMmpzJztcbmltcG9ydCB7IFByb2dyZXNzUHVibGlzaGVyIH0gZnJvbSAnLi9wcm9ncmVzcy1wdWJsaXNoZXInO1xuXG5pbnRlcmZhY2UgU2l0ZW1hcFBhcnNlckV2ZW50IHtcbiAgICB1cmw6IHN0cmluZztcbiAgICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgICBpbnB1dFR5cGU6ICdzaXRlbWFwJztcbn1cblxuaW50ZXJmYWNlIFNpdGVtYXBQYXJzZXJSZXNwb25zZSB7XG4gICAgc3VjY2VzczogYm9vbGVhbjtcbiAgICBzZXNzaW9uSWQ6IHN0cmluZztcbiAgICB0b3RhbFVybHM6IG51bWJlcjtcbiAgICBzaXRlbWFwVXJsczogc3RyaW5nW107XG4gICAgbmVzdGVkU2l0ZW1hcHM6IG51bWJlcjtcbiAgICBzM0xvY2F0aW9uOiBzdHJpbmc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIHByb2Nlc3NpbmdUaW1lOiBudW1iZXI7XG59XG5cbmludGVyZmFjZSBTaXRlbWFwRW50cnkge1xuICAgIGxvYzogc3RyaW5nW107XG4gICAgbGFzdG1vZD86IHN0cmluZ1tdO1xuICAgIHByaW9yaXR5Pzogc3RyaW5nW107XG4gICAgY2hhbmdlZnJlcT86IHN0cmluZ1tdO1xufVxuXG5pbnRlcmZhY2UgUGFyc2VkU2l0ZW1hcCB7XG4gICAgdXJsc2V0Pzoge1xuICAgICAgICB1cmw6IFNpdGVtYXBFbnRyeVtdO1xuICAgIH07XG4gICAgc2l0ZW1hcGluZGV4Pzoge1xuICAgICAgICBzaXRlbWFwOiBBcnJheTx7XG4gICAgICAgICAgICBsb2M6IHN0cmluZ1tdO1xuICAgICAgICAgICAgbGFzdG1vZD86IHN0cmluZ1tdO1xuICAgICAgICB9PjtcbiAgICB9O1xufVxuXG5leHBvcnQgY29uc3QgaGFuZGxlcjogSGFuZGxlcjxTaXRlbWFwUGFyc2VyRXZlbnQsIFNpdGVtYXBQYXJzZXJSZXNwb25zZT4gPSBhc3luYyAoZXZlbnQpID0+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGNvbnNvbGUubG9nKCdQYXJzaW5nIHNpdGVtYXAgZm9yIFVSTDonLCBldmVudC51cmwpO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBwcm9ncmVzcyBwdWJsaXNoZXIgYW5kIFMzIGNsaWVudFxuICAgIGNvbnN0IHByb2dyZXNzID0gbmV3IFByb2dyZXNzUHVibGlzaGVyKGV2ZW50LnNlc3Npb25JZCk7XG4gICAgY29uc3QgczNDbGllbnQgPSBuZXcgUzNDbGllbnQoeyByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfSk7XG5cbiAgICB0cnkge1xuICAgICAgICAvLyBTZW5kIGluaXRpYWwgcHJvZ3Jlc3NcbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoJ1N0YXJ0aW5nIHNpdGVtYXAgcGFyc2luZy4uLicsICdzaXRlbWFwLXBhcnNpbmcnKTtcblxuICAgICAgICAvLyBGZXRjaCBhbmQgcGFyc2UgdGhlIHNpdGVtYXBcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgcGFyc2VTaXRlbWFwUmVjdXJzaXZlbHkoZXZlbnQudXJsLCBwcm9ncmVzcywgMCk7XG5cbiAgICAgICAgLy8gU3RvcmUgcmVzdWx0cyBpbiBTM1xuICAgICAgICBjb25zdCBzM0tleSA9IGBzZXNzaW9ucy8ke2V2ZW50LnNlc3Npb25JZH0vc2l0ZW1hcC1yZXN1bHRzLmpzb25gO1xuICAgICAgICBjb25zdCBzM0xvY2F0aW9uID0gYHMzOi8vJHtwcm9jZXNzLmVudi5BTkFMWVNJU19CVUNLRVR9LyR7czNLZXl9YDtcblxuICAgICAgICBjb25zdCBzaXRlbWFwUmVzdWx0cyA9IHtcbiAgICAgICAgICAgIG9yaWdpbmFsVXJsOiBldmVudC51cmwsXG4gICAgICAgICAgICB0b3RhbFVybHM6IHJlc3VsdC51cmxzLmxlbmd0aCxcbiAgICAgICAgICAgIHVybHM6IHJlc3VsdC51cmxzLFxuICAgICAgICAgICAgbmVzdGVkU2l0ZW1hcHM6IHJlc3VsdC5uZXN0ZWRTaXRlbWFwcyxcbiAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgfTtcblxuICAgICAgICBhd2FpdCBzM0NsaWVudC5zZW5kKG5ldyBQdXRPYmplY3RDb21tYW5kKHtcbiAgICAgICAgICAgIEJ1Y2tldDogcHJvY2Vzcy5lbnYuQU5BTFlTSVNfQlVDS0VULFxuICAgICAgICAgICAgS2V5OiBzM0tleSxcbiAgICAgICAgICAgIEJvZHk6IEpTT04uc3RyaW5naWZ5KHNpdGVtYXBSZXN1bHRzLCBudWxsLCAyKSxcbiAgICAgICAgICAgIENvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIC8vIFNlbmQgY29tcGxldGlvbiBtZXNzYWdlXG4gICAgICAgIGF3YWl0IHByb2dyZXNzLnN1Y2Nlc3MoXG4gICAgICAgICAgICBgU2l0ZW1hcCBwYXJzaW5nIGNvbXBsZXRlOiBGb3VuZCAke3Jlc3VsdC51cmxzLmxlbmd0aH0gVVJMcyR7cmVzdWx0Lm5lc3RlZFNpdGVtYXBzID4gMCA/IGAgKCR7cmVzdWx0Lm5lc3RlZFNpdGVtYXBzfSBuZXN0ZWQgc2l0ZW1hcHMpYCA6ICcnfWAsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdG90YWxVcmxzOiByZXN1bHQudXJscy5sZW5ndGgsXG4gICAgICAgICAgICAgICAgbmVzdGVkU2l0ZW1hcHM6IHJlc3VsdC5uZXN0ZWRTaXRlbWFwcyxcbiAgICAgICAgICAgICAgICBwcm9jZXNzaW5nVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgICAgICAgICAgfVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGBTaXRlbWFwIHBhcnNpbmcgY29tcGxldGVkOiAke3Jlc3VsdC51cmxzLmxlbmd0aH0gVVJMcyBmb3VuZGApO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgc2Vzc2lvbklkOiBldmVudC5zZXNzaW9uSWQsXG4gICAgICAgICAgICB0b3RhbFVybHM6IHJlc3VsdC51cmxzLmxlbmd0aCxcbiAgICAgICAgICAgIHNpdGVtYXBVcmxzOiByZXN1bHQudXJscyxcbiAgICAgICAgICAgIG5lc3RlZFNpdGVtYXBzOiByZXN1bHQubmVzdGVkU2l0ZW1hcHMsXG4gICAgICAgICAgICBzM0xvY2F0aW9uLFxuICAgICAgICAgICAgbWVzc2FnZTogYFN1Y2Nlc3NmdWxseSBwYXJzZWQgc2l0ZW1hcCB3aXRoICR7cmVzdWx0LnVybHMubGVuZ3RofSBVUkxzYCxcbiAgICAgICAgICAgIHByb2Nlc3NpbmdUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgICAgIH07XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdTaXRlbWFwIHBhcnNpbmcgZmFpbGVkOicsIGVycm9yKTtcblxuICAgICAgICBhd2FpdCBwcm9ncmVzcy5lcnJvcihgU2l0ZW1hcCBwYXJzaW5nIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gKTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBzZXNzaW9uSWQ6IGV2ZW50LnNlc3Npb25JZCxcbiAgICAgICAgICAgIHRvdGFsVXJsczogMCxcbiAgICAgICAgICAgIHNpdGVtYXBVcmxzOiBbXSxcbiAgICAgICAgICAgIG5lc3RlZFNpdGVtYXBzOiAwLFxuICAgICAgICAgICAgczNMb2NhdGlvbjogJycsXG4gICAgICAgICAgICBtZXNzYWdlOiBgU2l0ZW1hcCBwYXJzaW5nIGZhaWxlZDogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gLFxuICAgICAgICAgICAgcHJvY2Vzc2luZ1RpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgICAgfTtcbiAgICB9XG59O1xuXG5pbnRlcmZhY2UgUGFyc2VSZXN1bHQge1xuICAgIHVybHM6IHN0cmluZ1tdO1xuICAgIG5lc3RlZFNpdGVtYXBzOiBudW1iZXI7XG59XG5cbi8qKlxuICogUmVjdXJzaXZlbHkgcGFyc2Ugc2l0ZW1hcCB3aXRoIG5lc3RlZCBzaXRlbWFwIHN1cHBvcnRcbiAqIFJlcXVpcmVtZW50czogMjkuMSwgMjkuMiwgMjkuMywgMjkuNywgMjkuOCwgMjkuOSwgMjkuMTBcbiAqL1xuYXN5bmMgZnVuY3Rpb24gcGFyc2VTaXRlbWFwUmVjdXJzaXZlbHkoXG4gICAgc2l0ZW1hcFVybDogc3RyaW5nLFxuICAgIHByb2dyZXNzOiBQcm9ncmVzc1B1Ymxpc2hlcixcbiAgICBkZXB0aDogbnVtYmVyID0gMCxcbiAgICBtYXhEZXB0aDogbnVtYmVyID0gMyxcbiAgICBwcm9jZXNzZWRVcmxzOiBTZXQ8c3RyaW5nPiA9IG5ldyBTZXQoKVxuKTogUHJvbWlzZTxQYXJzZVJlc3VsdD4ge1xuXG4gICAgLy8gUHJldmVudCBpbmZpbml0ZSByZWN1cnNpb24gYW5kIGR1cGxpY2F0ZSBwcm9jZXNzaW5nXG4gICAgaWYgKGRlcHRoID4gbWF4RGVwdGgpIHtcbiAgICAgICAgY29uc29sZS5sb2coYE1heCBkZXB0aCAke21heERlcHRofSByZWFjaGVkLCBza2lwcGluZzogJHtzaXRlbWFwVXJsfWApO1xuICAgICAgICByZXR1cm4geyB1cmxzOiBbXSwgbmVzdGVkU2l0ZW1hcHM6IDAgfTtcbiAgICB9XG5cbiAgICBpZiAocHJvY2Vzc2VkVXJscy5oYXMoc2l0ZW1hcFVybCkpIHtcbiAgICAgICAgY29uc29sZS5sb2coYEFscmVhZHkgcHJvY2Vzc2VkOiAke3NpdGVtYXBVcmx9YCk7XG4gICAgICAgIHJldHVybiB7IHVybHM6IFtdLCBuZXN0ZWRTaXRlbWFwczogMCB9O1xuICAgIH1cblxuICAgIHByb2Nlc3NlZFVybHMuYWRkKHNpdGVtYXBVcmwpO1xuXG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoYEZldGNoaW5nIHNpdGVtYXA6ICR7c2l0ZW1hcFVybH1gLCAnc2l0ZW1hcC1wYXJzaW5nJyk7XG5cbiAgICAgICAgLy8gRmV0Y2ggc2l0ZW1hcCBjb250ZW50IHdpdGggdGltZW91dCBoYW5kbGluZ1xuICAgICAgICBjb25zdCBjb250cm9sbGVyID0gbmV3IEFib3J0Q29udHJvbGxlcigpO1xuICAgICAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgMTAwMDApOyAvLyAxMCBzZWNvbmQgdGltZW91dFxuXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goc2l0ZW1hcFVybCwge1xuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICAgICdVc2VyLUFnZW50JzogJ0xlbnN5IERvY3VtZW50YXRpb24gUXVhbGl0eSBBdWRpdG9yLzEuMCdcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzaWduYWw6IGNvbnRyb2xsZXIuc2lnbmFsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuXG4gICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ2NvbnRlbnQtdHlwZScpIHx8ICcnO1xuICAgICAgICBsZXQgeG1sQ29udGVudDogc3RyaW5nO1xuXG4gICAgICAgIC8vIEhhbmRsZSBjb21wcmVzc2VkIHNpdGVtYXBzXG4gICAgICAgIGlmIChjb250ZW50VHlwZS5pbmNsdWRlcygnZ3ppcCcpIHx8IHNpdGVtYXBVcmwuZW5kc1dpdGgoJy5neicpKSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9ncmVzcy5wcm9ncmVzcygnRGVjb21wcmVzc2luZyBnemlwcGVkIHNpdGVtYXAuLi4nLCAnc2l0ZW1hcC1wYXJzaW5nJyk7XG4gICAgICAgICAgICAvLyBGb3Igbm93LCBhc3N1bWUgdW5jb21wcmVzc2VkLiBJbiBwcm9kdWN0aW9uLCB3b3VsZCB1c2UgemxpYlxuICAgICAgICAgICAgeG1sQ29udGVudCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHhtbENvbnRlbnQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYXJzZSBYTUxcbiAgICAgICAgY29uc3QgcGFyc2VkWG1sOiBQYXJzZWRTaXRlbWFwID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgcGFyc2VTdHJpbmcoeG1sQ29udGVudCwge1xuICAgICAgICAgICAgICAgIGV4cGxpY2l0QXJyYXk6IHRydWUsXG4gICAgICAgICAgICAgICAgaWdub3JlQXR0cnM6IGZhbHNlLFxuICAgICAgICAgICAgICAgIHRyaW06IHRydWVcbiAgICAgICAgICAgIH0sIChlcnI6IGFueSwgcmVzdWx0OiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICBlbHNlIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBsZXQgYWxsVXJsczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgbGV0IG5lc3RlZFNpdGVtYXBDb3VudCA9IDA7XG5cbiAgICAgICAgLy8gSGFuZGxlIHNpdGVtYXAgaW5kZXggKGNvbnRhaW5zIHJlZmVyZW5jZXMgdG8gb3RoZXIgc2l0ZW1hcHMpXG4gICAgICAgIGlmIChwYXJzZWRYbWwuc2l0ZW1hcGluZGV4Py5zaXRlbWFwKSB7XG4gICAgICAgICAgICBhd2FpdCBwcm9ncmVzcy5wcm9ncmVzcyhgRm91bmQgc2l0ZW1hcCBpbmRleCB3aXRoICR7cGFyc2VkWG1sLnNpdGVtYXBpbmRleC5zaXRlbWFwLmxlbmd0aH0gbmVzdGVkIHNpdGVtYXBzYCwgJ3NpdGVtYXAtcGFyc2luZycpO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IG5lc3RlZFNpdGVtYXAgb2YgcGFyc2VkWG1sLnNpdGVtYXBpbmRleC5zaXRlbWFwKSB7XG4gICAgICAgICAgICAgICAgaWYgKG5lc3RlZFNpdGVtYXAubG9jICYmIG5lc3RlZFNpdGVtYXAubG9jWzBdKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5lc3RlZFVybCA9IG5lc3RlZFNpdGVtYXAubG9jWzBdLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFByb2Nlc3NpbmcgbmVzdGVkIHNpdGVtYXA6ICR7bmVzdGVkVXJsfWApO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG5lc3RlZFJlc3VsdCA9IGF3YWl0IHBhcnNlU2l0ZW1hcFJlY3Vyc2l2ZWx5KFxuICAgICAgICAgICAgICAgICAgICAgICAgbmVzdGVkVXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3MsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXB0aCArIDEsXG4gICAgICAgICAgICAgICAgICAgICAgICBtYXhEZXB0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NlZFVybHNcbiAgICAgICAgICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgICAgICAgICBhbGxVcmxzLnB1c2goLi4ubmVzdGVkUmVzdWx0LnVybHMpO1xuICAgICAgICAgICAgICAgICAgICBuZXN0ZWRTaXRlbWFwQ291bnQgKz0gMSArIG5lc3RlZFJlc3VsdC5uZXN0ZWRTaXRlbWFwcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBIYW5kbGUgcmVndWxhciBzaXRlbWFwIChjb250YWlucyBhY3R1YWwgVVJMcylcbiAgICAgICAgaWYgKHBhcnNlZFhtbC51cmxzZXQ/LnVybCkge1xuICAgICAgICAgICAgYXdhaXQgcHJvZ3Jlc3MucHJvZ3Jlc3MoYEV4dHJhY3RpbmcgJHtwYXJzZWRYbWwudXJsc2V0LnVybC5sZW5ndGh9IFVSTHMgZnJvbSBzaXRlbWFwYCwgJ3NpdGVtYXAtcGFyc2luZycpO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHVybEVudHJ5IG9mIHBhcnNlZFhtbC51cmxzZXQudXJsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHVybEVudHJ5LmxvYyAmJiB1cmxFbnRyeS5sb2NbMF0pIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJsID0gdXJsRW50cnkubG9jWzBdLnRyaW0oKTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHVybCAmJiBpc1ZhbGlkVXJsKHVybCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFsbFVybHMucHVzaCh1cmwpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXNcbiAgICAgICAgY29uc3QgdW5pcXVlVXJscyA9IFsuLi5uZXcgU2V0KGFsbFVybHMpXTtcblxuICAgICAgICBpZiAoZGVwdGggPT09IDApIHtcbiAgICAgICAgICAgIGF3YWl0IHByb2dyZXNzLnByb2dyZXNzKGBTaXRlbWFwIHBhcnNpbmcgY29tcGxldGU6ICR7dW5pcXVlVXJscy5sZW5ndGh9IHVuaXF1ZSBVUkxzIGZvdW5kYCwgJ3NpdGVtYXAtcGFyc2luZycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHVybHM6IHVuaXF1ZVVybHMsXG4gICAgICAgICAgICBuZXN0ZWRTaXRlbWFwczogbmVzdGVkU2l0ZW1hcENvdW50XG4gICAgICAgIH07XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBFcnJvciBwYXJzaW5nIHNpdGVtYXAgJHtzaXRlbWFwVXJsfTpgLCBlcnJvcik7XG4gICAgICAgIGF3YWl0IHByb2dyZXNzLmVycm9yKGBGYWlsZWQgdG8gcGFyc2Ugc2l0ZW1hcDogJHtzaXRlbWFwVXJsfSAtICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCk7XG5cbiAgICAgICAgLy8gUmV0dXJuIGVtcHR5IHJlc3VsdCBidXQgZG9uJ3QgZmFpbCB0aGUgZW50aXJlIHByb2Nlc3NcbiAgICAgICAgcmV0dXJuIHsgdXJsczogW10sIG5lc3RlZFNpdGVtYXBzOiAwIH07XG4gICAgfVxufVxuXG4vKipcbiAqIFZhbGlkYXRlIFVSTCBmb3JtYXRcbiAqL1xuZnVuY3Rpb24gaXNWYWxpZFVybCh1cmxTdHJpbmc6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwodXJsU3RyaW5nKTtcbiAgICAgICAgcmV0dXJuIHVybC5wcm90b2NvbCA9PT0gJ2h0dHA6JyB8fCB1cmwucHJvdG9jb2wgPT09ICdodHRwczonO1xuICAgIH0gY2F0Y2gge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufSJdfQ==